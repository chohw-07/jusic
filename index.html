
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 & 부동산 시뮬레이터</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        :root {
            --primary-color: #0062df;
            --secondary-color: #171b23;
            --background-color: #0e1217;
            --text-color: #d1d4dc;
            --panel-color: #131722;
            --border-color: #2a2e39;
            --positive-color: #26a69a;
            --negative-color: #ef5350;
            --hover-color: #1e2230;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: auto;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            height: 60px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .account-info {
            display: flex;
            gap: 20px;
        }

        .balance, .loan, .time, .day {
            display: flex;
            flex-direction: column;
            font-size: 14px;
        }

        .balance-value, .loan-value, .time-value, .day-value {
            font-weight: bold;
            font-size: 16px;
        }
        
        .game-controls {
            display: flex;
            gap: 10px;
            margin-right: 20px;
        }
        
        .game-btn {
            background-color: var(--panel-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .game-btn:hover {
            background-color: var(--hover-color);
        }
        
        .sort-controls {
            display: flex;
            padding: 10px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .sort-btn {
            background-color: transparent;
            color: var(--text-color);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
            text-align: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .sort-btn:hover {
            background-color: var(--hover-color);
        }
        
        .sort-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .left-panel {
            width: 250px;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .tab-selector {
            display: flex;
            background-color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .tab {
            padding: 12px 15px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            border-bottom: 2px solid transparent;
            transition: border-bottom 0.2s;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: white;
        }

        .stock-list, .real-estate-list {
            display: none;
        }

        .stock-list.active, .real-estate-list.active {
            display: block;
        }

        .stock-item, .property-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .stock-item:hover, .property-item:hover {
            background-color: var(--hover-color);
        }

        .stock-name, .property-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stock-price, .property-price {
            display: flex;
            justify-content: space-between;
        }

        .price-value {
            font-weight: bold;
        }

        .price-change {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .positive {
            color: var(--positive-color);
        }

        .negative {
            color: var(--negative-color);
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .asset-name {
            font-size: 20px;
            font-weight: bold;
        }

        .asset-price {
            font-size: 24px;
            font-weight: bold;
        }

        .chart-container {
            flex: 1;
            position: relative;
        }

        .interval-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            background-color: var(--panel-color);
            border-radius: 5px;
            border: 1px solid var(--border-color);
            z-index: 10;
        }

        .interval {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .interval.active {
            background-color: var(--primary-color);
            color: white;
        }

        .trading-panel {
            height: 150px;
            border-top: 1px solid var(--border-color);
            display: flex;
        }

        .trade-form {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--panel-color);
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* 필요시 줄바꿈 */
        }

        .form-group {
            flex: 1;
            min-width: 120px; /* 너무 작아지지 않도록 최소 너비 설정 */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 3px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 0;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            font-size: 14px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-buy {
            background-color: var(--positive-color);
            color: white;
        }

        .btn-sell {
            background-color: var(--negative-color);
            color: white;
        }

        .right-panel {
            width: 300px;
            background-color: var(--panel-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .portfolio-header, .transactions-header {
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }

        .portfolio-list, .transactions-list {
            flex: 1;
            overflow-y: auto;
        }

        .portfolio-item, .transaction-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .portfolio-name, .transaction-type {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .portfolio-details, .transaction-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            animation: toast-in-right 0.7s;
            max-width: 350px;
        }
        
        .toast-success {
            border-left: 4px solid var(--positive-color);
        }
        
        .toast-error {
            border-left: 4px solid var(--negative-color);
        }
        
        .toast-info {
            border-left: 4px solid var(--primary-color);
        }
        
        .toast-warning {
            border-left: 4px solid #ff9800;
        }
        
        @keyframes toast-in-right {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes toast-out-right {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(100%);
            }
        }
        
        .toast.hide {
            animation: toast-out-right 0.7s forwards;
        }
        
        .confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 350px;
            z-index: 2000;
            display: none;
        }
        
        .confirm-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
        }
        
        .confirm-content {
            padding: 20px;
        }
        
        .confirm-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .chart-controls {
            position: absolute;
            right: 10px;
            bottom: 10px;
            z-index: 100;
            display: flex;
            gap: 5px;
            flex-direction: column;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            background-color: var(--panel-color);
            border-radius: 4px;
            padding: 5px;
            border: 1px solid var(--border-color);
        }
        
        .zoom-btn {
            background-color: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .zoom-btn:hover {
            background-color: var(--hover-color);
        }
        
        .reset-zoom-btn {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .reset-zoom-btn:hover {
            background-color: var(--hover-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* 특별한 z-index 값을 가진 모달 */
        #load-game-modal {
            z-index: 1100; /* 다른 모달보다 높은 z-index */
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            background-color: var(--panel-color);
            border-radius: 5px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: bold;
            font-size: 18px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 20px;
        }

        .modal-content {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-modal {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-modal:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-danger {
            background-color: var(--negative-color);
            color: white;
        }

        .property-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group-full {
            grid-column: 1 / 3;
        }

        .day-summary {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .summary-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .bill-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chart-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #8e939d;
        }

        .property-image-small {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 10px;
        }

        .property-image {
            width: 100%;
            height: auto;
            border-radius: 4px;
            max-height: 200px;
            object-fit: cover;
        }
        
        /* 대출 관리 스타일 */
        .loan-info, .loan-history, .loan-actions {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .loan-info h3, .loan-history h3, .loan-actions h3 {
            margin-bottom: 10px;
        }
        
        .loan-history-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .loan-history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .loan-history-item:last-child {
            border-bottom: none;
        }
        
        .loan-form, .loan-repay-form {
            margin-top: 10px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 4px;
        }
        
        .loan-form .form-group, .loan-repay-form .form-group {
            margin-bottom: 15px;
        }
        
        .loan-term-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .loan-term-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .loan-term-option.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .credit-rating {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .credit-A {
            background-color: #4CAF50;
            color: white;
        }
        
        .credit-B {
            background-color: #2196F3;
            color: white;
        }
        
        .credit-C {
            background-color: #FFC107;
            color: black;
        }
        
        .credit-D {
            background-color: #FF9800;
            color: white;
        }
        
        .credit-E {
            background-color: #F44336;
            color: white;
        }

        /* 모바일 반응형 스타일 */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                height: 300px;
                border: none;
            }
            
            .chart-container {
                min-height: 350px;
            }
            
            .account-info {
                display: none;
            }
            
            .header {
                flex-direction: column;
                height: auto;
                gap: 10px;
                padding: 10px;
            }
            
            .game-controls {
                margin-right: 0;
                justify-content: center;
                width: 100%;
            }
            
            .mobile-account-info {
                display: flex;
                justify-content: space-between;
                width: 100%;
                padding: 10px;
                background-color: var(--secondary-color);
                border-bottom: 1px solid var(--border-color);
            }
            
            .trading-panel {
                position: sticky;
                bottom: 0;
                height: auto;
                min-height: 180px; /* 모바일에서 더 큰 높이 */
                padding-bottom: 10px;
            }
            
            .center-panel {
                min-height: 600px; /* 모바일에서 충분한 높이 확보 */
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">스톡 & 부동산 시뮬레이터</div>
        <div class="game-controls">
            <button class="game-btn" id="pause-game">일시정지</button>
            <button class="game-btn" id="loan-manager">대출관리</button>
            <button class="game-btn" id="save-game">저장하기</button>
            <button class="game-btn" id="load-game">불러오기</button>
        </div>
        <div class="account-info">
            <div class="balance">
                <span>보유 자산</span>
                <span class="balance-value">₩10,000,000</span>
            </div>
            <div class="loan">
                <span>대출 금액</span>
                <span class="loan-value">₩0</span>
            </div>
            <div class="time">
                <span>시간</span>
                <span class="time-value">08:00</span>
            </div>
            <div class="day">
                <span>날짜</span>
                <span class="day-value">1일차</span>
            </div>
        </div>
    </div>
    
    <!-- 모바일 환경에서만 표시되는 계정 정보 -->
    <div class="mobile-account-info" style="display: none;">
        <div class="balance">
            <span>자산: <span class="balance-value">₩10,000,000</span></span>
        </div>
        <div class="time-day">
            <span class="time-value">08:00</span> / <span class="day-value">1일차</span>
        </div>
    </div>
    
    <div class="main-container">
        <div class="left-panel">
            <div class="tab-selector">
                <div class="tab active" data-tab="stock">주식</div>
                <div class="tab" data-tab="real-estate">부동산</div>
            </div>
            
            <div class="stock-list active">
                <!-- Stock items will be populated here -->
            </div>
            
            <div class="real-estate-list">
                <div class="sort-controls">
                    <button class="sort-btn active" data-sort="name">이름순</button>
                    <button class="sort-btn" data-sort="price-asc">가격 낮은순</button>
                    <button class="sort-btn" data-sort="price-desc">가격 높은순</button>
                    <button class="sort-btn" data-sort="units">세대수순</button>
                </div>
                <!-- Property items will be populated here -->
            </div>
        </div>
        
        <div class="center-panel">
            <div class="chart-header">
                <div>
                    <div class="asset-name">종목을 선택하세요</div>
                    <div class="asset-description"></div>
                </div>
                <div class="asset-price">-</div>
            </div>
            
            <div class="chart-container">
                <div class="interval-selector">
                    <div class="interval active" data-interval="1m">1분</div>
                    <div class="interval" data-interval="5m">5분</div>
                    <div class="interval" data-interval="15m">15분</div>
                    <div class="interval" data-interval="1h">1시간</div>
                    <div class="interval" data-interval="1d">1일</div>
                </div>
                <div class="chart-controls">
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="zoom-in">+</button>
                        <button class="zoom-btn" id="zoom-out">-</button>
                    </div>
                    <button class="reset-zoom-btn" id="reset-zoom">초기화</button>
                </div>
                <div id="chart"></div>
                <div class="chart-placeholder">종목을 선택하세요</div>
                <canvas id="chart-canvas" style="width: 100%; height: 100%;"></canvas>
            </div>
            
            <div class="trading-panel">
                <div class="trade-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trade-price">가격</label>
                            <input type="number" id="trade-price" readonly>
                        </div>
                        <div class="form-group">
                            <label for="trade-quantity">수량</label>
                            <input type="number" id="trade-quantity" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="trade-total">총액</label>
                            <input type="number" id="trade-total" readonly>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-buy" id="btn-buy">매수</button>
                        <button class="btn btn-sell" id="btn-sell">매도</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="portfolio-header">포트폴리오</div>
            <div class="portfolio-list">
                <!-- Portfolio items will be populated here -->
            </div>
            
            <div class="transactions-header">최근 거래 내역</div>
            <div class="transactions-list">
                <!-- Transaction items will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Property Detail Modal -->
    <div class="modal-overlay" id="property-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">부동산 정보</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <form id="property-form" class="property-form">
                    <div class="form-group form-group-full">
                        <label for="property-name">이름</label>
                        <input type="text" id="property-name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="property-price">가격</label>
                        <input type="number" id="property-price" readonly>
                    </div>
                    <div class="form-group">
                        <label for="property-size">크기 (㎡)</label>
                        <input type="number" id="property-size" readonly>
                    </div>
                    <div class="form-group">
                        <label for="property-units">세대수</label>
                        <input type="number" id="property-units" readonly>
                    </div>
                    <div class="form-group">
                        <label for="property-occupied">입주 세대수</label>
                        <input type="number" id="property-occupied" readonly>
                    </div>
                    <div class="form-group form-group-full">
                        <img src="/api/placeholder/400/320" alt="부동산 이미지" id="property-image" class="property-image">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-close-property">닫기</button>
                <button class="btn-modal btn-primary" id="btn-buy-property">구매</button>
            </div>
        </div>
    </div>
    
    <!-- Tenant Modal -->
    <div class="modal-overlay" id="tenant-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">새로운 세입자</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <p>새로운 세입자가 <span id="tenant-property-name"></span>에 입주하고 싶어합니다.</p>
                <p>월세: <span id="tenant-rent"></span>원</p>
                <p>계약 기간: <span id="tenant-period"></span>개월</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-reject-tenant">거절</button>
                <button class="btn-modal btn-primary" id="btn-accept-tenant">수락</button>
            </div>
        </div>
    </div>
    
    <!-- Bills Modal -->
    <div class="modal-overlay" id="bills-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">일일 청산</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <p>오늘 하루가 끝났습니다. 다음 비용을 정산해야 합니다:</p>
                <div id="bills-list">
                    <!-- Bills will be populated here -->
                </div>
                <p>총액: <span id="bills-total"></span>원</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-danger" id="btn-ignore-bills">대출로 처리</button>
                <button class="btn-modal btn-primary" id="btn-pay-bills">납부</button>
            </div>
        </div>
    </div>
    
    <!-- Day Summary Modal -->
    <div class="modal-overlay" id="day-summary-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">하루 요약</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <div class="day-summary" id="day-summary">
                    <!-- Day summary will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-quit-game">게임 종료</button>
                <button class="btn-modal btn-primary" id="btn-continue-game">계속하기</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Buy Modal -->
    <div class="confirm-modal" id="confirm-buy-modal">
        <div class="confirm-header">매수 확인</div>
        <div class="confirm-content">
            <p><span id="confirm-buy-asset"></span> <span id="confirm-buy-quantity"></span>주를 <span id="confirm-buy-price"></span>원에 매수하시겠습니까?</p>
            <p>총 금액: <span id="confirm-buy-total"></span>원</p>
        </div>
        <div class="confirm-footer">
            <button class="btn-modal btn-secondary" id="cancel-buy">취소</button>
            <button class="btn-modal btn-primary" id="confirm-buy">매수</button>
        </div>
    </div>
    
    <!-- Confirm Sell Modal -->
    <div class="confirm-modal" id="confirm-sell-modal">
        <div class="confirm-header">매도 확인</div>
        <div class="confirm-content">
            <p><span id="confirm-sell-asset"></span> <span id="confirm-sell-quantity"></span>주를 <span id="confirm-sell-price"></span>원에 매도하시겠습니까?</p>
            <p>총 금액: <span id="confirm-sell-total"></span>원</p>
        </div>
        <div class="confirm-footer">
            <button class="btn-modal btn-secondary" id="cancel-sell">취소</button>
            <button class="btn-modal btn-primary" id="confirm-sell">매도</button>
        </div>
    </div>
    
    <!-- Load Game Modal -->
    <div class="modal-overlay" id="load-game-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">게임 불러오기</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <p>저장된 게임 파일을 선택하세요:</p>
                <div class="form-group">
                    <input type="file" id="load-game-file" accept=".json">
                </div>
                <div class="load-game-error" id="load-game-error" style="color: var(--negative-color); margin-top: 10px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-cancel-load-file">취소</button>
                <button class="btn-modal btn-primary" id="btn-confirm-load-file">불러오기</button>
            </div>
        </div>
    </div>
    
    <!-- Bankruptcy Modal -->
    <div class="modal-overlay" id="bankruptcy-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">파산!</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <p>대출 금액이 1,000만원을 초과하여 파산하였습니다.</p>
                <p>게임이 종료됩니다.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-primary" id="btn-restart-game">새 게임</button>
            </div>
        </div>
    </div>
    
    <!-- Loan Manager Modal -->
    <div class="modal-overlay" id="loan-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">대출 관리</div>
                <div class="modal-close">&times;</div>
            </div>
            <div class="modal-content">
                <div class="loan-info">
                    <h3>현재 대출 현황</h3>
                    <p>현재 대출 금액: <span id="current-loan">₩0</span></p>
                    <p>현재 이자율: <span id="current-interest-rate">5.0%</span></p>
                    <p>신용 등급: <span id="credit-rating">A</span></p>
                    <p>대출 한도: <span id="loan-limit">₩50,000,000</span></p>
                </div>
                
                <div class="loan-history">
                    <h3>대출 이력</h3>
                    <div id="loan-history-list" class="loan-history-list">
                        <!-- 대출 이력이 여기에 표시됩니다 -->
                    </div>
                </div>
                
                <div class="loan-actions">
                    <h3>대출 신청</h3>
                    <div class="loan-form">
                        <div class="form-group">
                            <label for="loan-amount">대출 금액</label>
                            <input type="number" id="loan-amount" min="1000000" step="1000000" value="5000000">
                        </div>
                        <div class="form-group">
                            <label for="loan-term">상환 기간 (일)</label>
                            <select id="loan-term">
                                <option value="7">7일</option>
                                <option value="14">14일</option>
                                <option value="30" selected>30일</option>
                            </select>
                        </div>
                        <p>예상 총 이자: <span id="estimated-interest">₩0</span></p>
                        <button class="btn-modal btn-primary" id="btn-apply-loan">대출 신청</button>
                    </div>
                    
                    <h3>대출 상환</h3>
                    <div class="loan-repay-form">
                        <div class="form-group">
                            <label for="repay-amount">상환 금액</label>
                            <input type="number" id="repay-amount" min="1000000" step="1000000" value="1000000">
                        </div>
                        <button class="btn-modal btn-primary" id="btn-repay-loan">대출 상환</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-close-loan">닫기</button>
            </div>
        </div>
    </div>
    
    <!-- Game Intro Modal -->
    <div class="modal-overlay" id="intro-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">주식 & 부동산 시뮬레이터</div>
            </div>
            <div class="modal-content">
                <h3>게임 소개</h3>
                <p>주식과 부동산을 매매하여 자산을 불려보세요! 시작 자금은 1,000만원이며, 대출이 1,000만원을 초과하면 파산합니다.</p>
                
                <h3>튜토리얼</h3>
                <ul>
                    <li>좌측 패널에서 주식 또는 부동산 탭을 선택할 수 있습니다.</li>
                    <li>주식은 실시간으로 가격이 변동되며, 매수/매도를 통해 수익을 올릴 수 있습니다.</li>
                    <li>부동산은 구매 후 세입자가 입주하면 월세 수입이 발생합니다.</li>
                    <li>하루가 끝나면 청산 비용(관리비, 세금 등)이 발생합니다.</li>
                    <li>일시정지, 저장하기, 불러오기 기능을 통해 게임을 관리할 수 있습니다.</li>
                </ul>
                
                <h3>팁</h3>
                <p>주식은 단기 수익에, 부동산은 장기 수익에 유리합니다. 분산 투자로 리스크를 관리하세요!</p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-secondary" id="btn-load-intro">불러오기</button>
                <button class="btn-modal btn-primary" id="btn-start-game">새 게임 시작</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <script>
        // 상수 및 게임 상태 초기화
        const CONSTANTS = {
        REFRESH_INTERVAL: 500, // 0.5초마다 갱신
        TIME_SCALE: 180, // 180초 = 게임 내 1시간 (3배 느림)
        BASE_INTEREST_RATE: 0.05, // 기본 대출 이자율 5%
        BANKRUPTCY_THRESHOLD: 10000000, // 파산 기준 1000만원
        CREDIT_RATINGS: {
            'A': { interestMultiplier: 1.0, loanLimitMultiplier: 1.0 },
            'B': { interestMultiplier: 1.2, loanLimitMultiplier: 0.8 },
            'C': { interestMultiplier: 1.5, loanLimitMultiplier: 0.6 },
            'D': { interestMultiplier: 2.0, loanLimitMultiplier: 0.4 },
            'E': { interestMultiplier: 3.0, loanLimitMultiplier: 0.2 }
        },
        PROPERTY_IMAGES: [
            'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&h=600',
            'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?w=800&h=600',
            'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&h=600',
            'https://images.unsplash.com/photo-1576941089067-2de3c901e126?w=800&h=600',
            'https://images.unsplash.com/photo-1605276374104-dee2a0ed3cd6?w=800&h=600',
            'https://images.unsplash.com/photo-1600047509807-ba8f99d2cdde?w=800&h=600',
            'https://images.unsplash.com/photo-1493809842364-78817add7ffb?w=800&h=600',
            'https://images.unsplash.com/photo-1600585154526-990dced4db3d?w=800&h=600',
            'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800&h=600',
            'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800&h=600',
            'https://images.unsplash.com/photo-1576941089067-2de3c901e126?w=800&h=600',
            'https://images.unsplash.com/photo-1600566752355-35792bedcfea?w=800&h=600',
            'https://images.unsplash.com/photo-1605146769289-440113cc3d00?w=800&h=600',
            'https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=800&h=600',
            'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&h=600'
        ]
    };
        
        // 게임 상태 객체
        let gameState = {
            balance: 10000000, // 1000만원
            loan: 0,
            time: { hour: 8, minute: 0 }, // 게임은 8:00에 시작
            day: 1,
            running: false, // 시작 버튼 클릭 전까지 일시정지
            paused: false,
            selectedAsset: null,
            selectedAssetType: null, // 'stock' 또는 'property'
            stocks: [],
            properties: [],
            portfolio: [],
            transactions: [],
            daySummary: [],
            chartInterval: '1m',
            chartData: {},
            propertySortMethod: 'name', // 기본 정렬 방식
            creditRating: 'A', // 신용 등급 (A, B, C, D, E)
            loanHistory: [], // 대출 이력
            activeLoans: [], // 활성 대출 목록
            loanLimit: 50000000 // 대출 한도 (5000만원)
        };
        
        // 차트 줌 상태
        let chartZoom = {
            scale: 1,
            offsetX: 0,
            minScale: 0.5,
            maxScale: 5,
            isDragging: false,
            startX: 0,
            startOffsetX: 0
        };
        
        // DOM 요소 캐싱
        const DOM = {
            // 헤더 정보
            balanceValue: document.querySelector('.balance-value'),
            loanValue: document.querySelector('.loan-value'),
            timeValue: document.querySelector('.time-value'),
            dayValue: document.querySelector('.day-value'),
            
            // 패널 요소
            stockList: document.querySelector('.stock-list'),
            realEstateList: document.querySelector('.real-estate-list'),
            tabs: document.querySelectorAll('.tab'),
            
            // 차트 및 자산 정보
            assetName: document.querySelector('.asset-name'),
            assetDescription: document.querySelector('.asset-description'),
            assetPrice: document.querySelector('.asset-price'),
            chartContainer: document.getElementById('chart'),
            chartPlaceholder: document.querySelector('.chart-placeholder'),
            chartCanvas: document.getElementById('chart-canvas'),
            intervals: document.querySelectorAll('.interval'),
            
            // 거래 폼
            tradePrice: document.getElementById('trade-price'),
            tradeQuantity: document.getElementById('trade-quantity'),
            tradeTotal: document.getElementById('trade-total'),
            buyButton: document.getElementById('btn-buy'),
            sellButton: document.getElementById('btn-sell'),
            
            // 포트폴리오 및 거래 내역
            portfolioList: document.querySelector('.portfolio-list'),
            transactionsList: document.querySelector('.transactions-list'),
            
            // 모달
            propertyModal: document.getElementById('property-modal'),
            tenantModal: document.getElementById('tenant-modal'),
            billsModal: document.getElementById('bills-modal'),
            daySummaryModal: document.getElementById('day-summary-modal'),
            bankruptcyModal: document.getElementById('bankruptcy-modal'),
            introModal: document.getElementById('intro-modal'),
            
            // 부동산 폼 요소
            propertyName: document.getElementById('property-name'),
            propertyPrice: document.getElementById('property-price'),
            propertySize: document.getElementById('property-size'),
            propertyUnits: document.getElementById('property-units'),
            propertyOccupied: document.getElementById('property-occupied'),
            propertyImage: document.getElementById('property-image')
        };
        
        // 게임 초기화
        function initGame() {
            // UI 초기화
            setupMobileView();
            updateUI();
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // 인트로 모달 표시
            showModal(DOM.introModal);
        }
        
        // 모바일 뷰 설정
        function setupMobileView() {
            const checkMobileView = () => {
                const isMobile = window.innerWidth <= 900;
                const mobileInfo = document.querySelector('.mobile-account-info');
                
                if (isMobile) {
                    mobileInfo.style.display = 'flex';
                    document.querySelector('.account-info').style.display = 'none';
                } else {
                    mobileInfo.style.display = 'none';
                    document.querySelector('.account-info').style.display = 'flex';
                }
            };
            
            // 초기 확인
            checkMobileView();
            
            // 창 크기 변경 시 확인
            window.addEventListener('resize', checkMobileView);
        }
        
        // 새 게임 시작
        function startNewGame() {
            // 초기 주식 데이터 생성
            generateStocks();
            
            // 부동산 생성
            generateProperties();
            
            // 대출 한도 초기화
            updateLoanLimit();
            
            // UI 업데이트
            updateUI();
            
            // 게임 타이머 시작
            setInterval(updateGameTime, CONSTANTS.REFRESH_INTERVAL);
            
            // 주식 가격 주기적 업데이트
            setInterval(updateStockPrices, CONSTANTS.REFRESH_INTERVAL);
            
            // 게임 시작
            gameState.running = true;
            
            // 인트로 모달 숨기기
            hideModal(DOM.introModal);
        }
        
        // 주식 생성
        function generateStocks() {
            const stockNames = [
                { name: '삼성전자', code: '005930', sector: '전자' },
                { name: 'SK하이닉스', code: '000660', sector: '반도체' },
                { name: '네이버', code: '035420', sector: 'IT' },
                { name: '카카오', code: '035720', sector: 'IT' },
                { name: '현대차', code: '005380', sector: '자동차' },
                { name: 'LG화학', code: '051910', sector: '화학' },
                { name: '셀트리온', code: '068270', sector: '제약' },
                { name: '한국전력', code: '015760', sector: '유틸리티' },
                { name: '롯데케미칼', code: '011170', sector: '화학' },
                { name: 'KB금융', code: '105560', sector: '금융' }
            ];
            
            gameState.stocks = stockNames.map(stock => {
                const basePrice = Math.floor(Math.random() * 200000) + 10000;
                return {
                    name: stock.name,
                    code: stock.code,
                    sector: stock.sector,
                    price: basePrice,
                    prevPrice: basePrice,
                    high: basePrice * 1.05,
                    low: basePrice * 0.95,
                    volatility: Math.random() * 0.03 + 0.01, // 1-4% 변동성
                    trend: Math.random() * 0.4 - 0.2, // -0.2 ~ 0.2 트렌드 (약간의 상승 또는 하락 편향)
                    history: []
                };
            });
            
            // 차트 데이터 초기화
            gameState.chartData = {};
            gameState.stocks.forEach(stock => {
                gameState.chartData[stock.code] = generateInitialChartData(stock);
            });
            
            // 주식 목록 렌더링
            renderStockList();
        }
        
        // 부동산 생성
        function generateProperties() {
            const propertyTypes = [
                { type: '오피스텔', units: [4, 10], pricePerUnit: [50000000, 80000000], size: [20, 35] },
                { type: '빌라', units: [6, 15], pricePerUnit: [70000000, 120000000], size: [35, 60] },
                { type: '아파트', units: [15, 30], pricePerUnit: [100000000, 180000000], size: [60, 90] },
                { type: '상가', units: [2, 8], pricePerUnit: [150000000, 300000000], size: [50, 150] }
            ];
            
            gameState.properties = [];
            
            const districts = ['강남구', '서초구', '송파구', '마포구', '영등포구', '성동구', '강서구', '용산구'];
            
            // 로컬 플레이스홀더 이미지 사용
            const placeholderImages = [];
            for (let i = 1; i <= 8; i++) {
                placeholderImages.push(`/api/placeholder/400/320?text=Property_${i}`);
            }
            
            for (let i = 0; i < 15; i++) {
                const propertyType = propertyTypes[Math.floor(Math.random() * propertyTypes.length)];
                const district = districts[Math.floor(Math.random() * districts.length)];
                const unitCount = Math.floor(Math.random() * (propertyType.units[1] - propertyType.units[0] + 1)) + propertyType.units[0];
                const pricePerUnit = Math.floor(Math.random() * (propertyType.pricePerUnit[1] - propertyType.pricePerUnit[0] + 1)) + propertyType.pricePerUnit[0];
                const size = Math.floor(Math.random() * (propertyType.size[1] - propertyType.size[0] + 1)) + propertyType.size[0];
                
                const property = {
                    id: i + 1,
                    name: `${district} ${propertyType.type} ${i + 1}호`,
                    type: propertyType.type,
                    district: district,
                    units: unitCount,
                    occupied: 0,
                    size: size * unitCount,
                    price: unitCount * pricePerUnit,
                    rentalIncome: 0,
                    expenses: Math.floor(unitCount * size * 5000), // 크기와 세대 기반 관리비
                    popularity: Math.random() * 0.6 + 0.2, // 20-80% 인기도
                    tenants: [],
                    imageUrl: placeholderImages[i % placeholderImages.length]
                };
                
                gameState.properties.push(property);
            }
            
            // 부동산 목록 렌더링
            renderPropertyList();
        }
        
        // 주식의 초기 차트 데이터 생성
        function generateInitialChartData(stock) {
            const intervals = ['1m', '5m', '15m', '1h', '1d'];
            const data = {};
            
            intervals.forEach(interval => {
                data[interval] = [];
                
                // 캔들 수
                let candleCount;
                switch (interval) {
                    case '1m': candleCount = 60; break;
                    case '5m': candleCount = 60; break;
                    case '15m': candleCount = 40; break;
                    case '1h': candleCount = 24; break;
                    case '1d': candleCount = 30; break;
                }
                
                // 시작 시간
                let time = new Date();
                time.setHours(0, 0, 0, 0);
                
                // 시간 증가량 (밀리초)
                let timeIncrement;
                switch (interval) {
                    case '1m': timeIncrement = 60 * 1000; break;
                    case '5m': timeIncrement = 5 * 60 * 1000; break;
                    case '15m': timeIncrement = 15 * 60 * 1000; break;
                    case '1h': timeIncrement = 60 * 60 * 1000; break;
                    case '1d': timeIncrement = 24 * 60 * 60 * 1000; break;
                }
                
                // 과거 데이터 생성
                let price = stock.price;
                
                for (let i = 0; i < candleCount; i++) {
                    time = new Date(time.getTime() - timeIncrement);
                    
                    // 랜덤 가격 변동
                    const change = (Math.random() - 0.5 + stock.trend) * stock.volatility * price;
                    const open = price;
                    price += change;
                    
                    // 고가, 저가 추가 (약간의 랜덤성)
                    const highLowRange = Math.abs(change) * 1.5;
                    const high = Math.max(open, price) + Math.random() * highLowRange;
                    const low = Math.min(open, price) - Math.random() * highLowRange;
                    
                    data[interval].unshift({
                        time: time.getTime() / 1000,
                        open: open,
                        high: high,
                        low: low,
                        close: price
                    });
                }
            });
            
            return data;
        }
        
        // 게임 시간 업데이트
        function updateGameTime() {
            if (!gameState.running || gameState.paused) return;
            
            // 게임 시간 증가
            gameState.time.minute += CONSTANTS.REFRESH_INTERVAL / CONSTANTS.TIME_SCALE;
            
            // 시간 증가 처리
            if (gameState.time.minute >= 60) {
                gameState.time.hour += 1;
                gameState.time.minute = 0;
                
                // 시간당 대출 이자 업데이트
                updateLoanInterest();
            }
            
            // 일차 변경 처리
            if (gameState.time.hour >= 24) {
                gameState.time.hour = 0;
                gameState.day += 1;
                processDayEnd();
                updateActiveLoans(); // 활성 대출 상태 업데이트
            }
            
            // 취침 시간
            if (gameState.time.hour === 22) {
                gameState.running = false;
                generateDailyBills();
                showModal(DOM.billsModal);
            }
            
            // UI 업데이트
            updateTimeDisplay();
        }
        
        // 대출 이자 업데이트
        function updateLoanInterest() {
            // 기존 자동 대출에 대한 이자 처리
            if (gameState.loan > 0) {
                const effectiveRate = getCurrentInterestRate();
                const hourlyInterest = gameState.loan * (effectiveRate / 24 / 365);
                gameState.loan += hourlyInterest;
                checkBankruptcy();
            }
            
            // 활성 대출에 대한 이자 처리
            gameState.activeLoans.forEach(loan => {
                const hourlyInterest = loan.amount * (loan.interestRate / 24 / 365);
                loan.accruedInterest += hourlyInterest;
            });
        }
        
        // 활성 대출 상태 업데이트
        function updateActiveLoans() {
            // 만기된 대출 처리
            const currentLoans = [...gameState.activeLoans];
            gameState.activeLoans = [];
            
            currentLoans.forEach(loan => {
                loan.daysLeft--;
                
                if (loan.daysLeft <= 0) {
                    // 만기된 대출, 자동으로 총액을 기존 대출로 통합
                    const totalAmount = loan.amount + loan.accruedInterest;
                    gameState.loan += totalAmount;
                    
                    // 대출 이력에 추가
                    gameState.loanHistory.push({
                        type: '만기 통합',
                        amount: totalAmount,
                        date: gameState.day,
                        interestRate: loan.interestRate
                    });
                    
                    // 신용 등급 하락
                    downgradeCreditRating();
                    
                    showToast(`대출 만기: ${formatCurrency(totalAmount)}가 기존 대출로 통합되었습니다.`, 'warning');
                } else {
                    // 아직 만기되지 않은 대출
                    gameState.activeLoans.push(loan);
                }
            });
            
            // 대출 총액 계산
            calculateTotalLoan();
        }
        
        // 시간 표시 업데이트
        function updateTimeDisplay() {
            const hour = String(Math.floor(gameState.time.hour)).padStart(2, '0');
            const minute = String(Math.floor(gameState.time.minute)).padStart(2, '0');
            
            // 모든 시간 표시 요소 업데이트
            document.querySelectorAll('.time-value').forEach(el => {
                el.textContent = `${hour}:${minute}`;
            });
            
            // 모든 날짜 표시 요소 업데이트
            document.querySelectorAll('.day-value').forEach(el => {
                el.textContent = `${gameState.day}일차`;
            });
        }
        
        // 일과 종료 처리
        function processDayEnd() {
            // 일일 요약 생성
            generateDaySummary();
            
            // 일일 값 초기화
            gameState.daySummary = [];
        }
        
        // 주식 가격 업데이트
        function updateStockPrices() {
            if (!gameState.running || gameState.paused) return;
            
            gameState.stocks.forEach(stock => {
                // 변동성과 트렌드 기반 가격 변화 계산
                const change = (Math.random() - 0.5 + stock.trend) * stock.volatility * stock.price;
                
                // 주식 가격 업데이트
                stock.prevPrice = stock.price;
                stock.price += change;
                
                // 고가 및 저가 업데이트
                if (stock.price > stock.high) stock.high = stock.price;
                if (stock.price < stock.low) stock.low = stock.price;
                
                // 이력에 추가
                stock.history.push({
                    time: Date.now(),
                    price: stock.price
                });
                
                // 이력 크기 제한
                if (stock.history.length > 100) {
                    stock.history.shift();
                }
                
                // 현재 선택된 간격에 대한 차트 데이터 업데이트
                if (gameState.chartData[stock.code]) {
                    const now = new Date();
                    const intervalData = gameState.chartData[stock.code][gameState.chartInterval];
                    
                    if (intervalData && intervalData.length > 0) {
                        let lastCandle = intervalData[intervalData.length - 1];
                        const currentTime = now.getTime() / 1000;
                        
                        // 간격에 따라 새 캔들이 필요한지 결정
                        let newCandleNeeded = false;
                        switch (gameState.chartInterval) {
                            case '1m':
                                newCandleNeeded = Math.floor(currentTime / 60) > Math.floor(lastCandle.time / 60);
                                break;
                            case '5m':
                                newCandleNeeded = Math.floor(currentTime / 300) > Math.floor(lastCandle.time / 300);
                                break;
                            case '15m':
                                newCandleNeeded = Math.floor(currentTime / 900) > Math.floor(lastCandle.time / 900);
                                break;
                            case '1h':
                                newCandleNeeded = Math.floor(currentTime / 3600) > Math.floor(lastCandle.time / 3600);
                                break;
                            case '1d':
                                newCandleNeeded = Math.floor(currentTime / 86400) > Math.floor(lastCandle.time / 86400);
                                break;
                        }
                        
                        if (newCandleNeeded) {
                            // 새 캔들 추가
                            intervalData.push({
                                time: currentTime,
                                open: stock.price,
                                high: stock.price,
                                low: stock.price,
                                close: stock.price
                            });
                            
                            // 캔들 수 제한
                            if (intervalData.length > 100) {
                                intervalData.shift();
                            }
                        } else {
                            // 마지막 캔들 업데이트
                            lastCandle.close = stock.price;
                            lastCandle.high = Math.max(lastCandle.high, stock.price);
                            lastCandle.low = Math.min(lastCandle.low, stock.price);
                        }
                    }
                }
            });
            
            // 필요한 경우 UI 업데이트
            if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                if (stock) {
                    updateAssetInfo(stock);
                    
                    // 업데이트된 데이터로 차트 다시 렌더링
                    renderChart(stock);
                }
            }
            
            // 포트폴리오 가치 업데이트
            updatePortfolio();
            
            // 주식 목록 표시 업데이트
            renderStockList();
        }
        
        // 파산 검사
        function checkBankruptcy() {
            // 총 대출 금액 계산
            const totalLoanAmount = calculateTotalLoan();
            
            if (totalLoanAmount >= CONSTANTS.BANKRUPTCY_THRESHOLD) {
                gameState.running = false;
                showModal(DOM.bankruptcyModal);
                showToast('파산! 대출 금액이 1,000만원을 초과했습니다.', 'error', 5000);
            }
        }
        
        // 총 대출 금액 계산
        function calculateTotalLoan() {
            // 기존 자동 대출
            let totalLoan = gameState.loan;
            
            // 활성 대출 원금 + 이자
            gameState.activeLoans.forEach(loan => {
                totalLoan += loan.amount + loan.accruedInterest;
            });
            
            return totalLoan;
        }
        
        // 현재 이자율 계산
        function getCurrentInterestRate() {
            const baseRate = CONSTANTS.BASE_INTEREST_RATE;
            const creditMultiplier = CONSTANTS.CREDIT_RATINGS[gameState.creditRating].interestMultiplier;
            return baseRate * creditMultiplier;
        }
        
        // 신용 등급 하락
        function downgradeCreditRating() {
            const ratings = Object.keys(CONSTANTS.CREDIT_RATINGS);
            const currentIndex = ratings.indexOf(gameState.creditRating);
            
            if (currentIndex < ratings.length - 1) {
                gameState.creditRating = ratings[currentIndex + 1];
                
                // 대출 한도 업데이트
                updateLoanLimit();
                
                showToast(`신용 등급이 ${gameState.creditRating}로 하락했습니다.`, 'warning');
            }
        }
        
        // 신용 등급 상승
        function upgradeCreditRating() {
            const ratings = Object.keys(CONSTANTS.CREDIT_RATINGS);
            const currentIndex = ratings.indexOf(gameState.creditRating);
            
            if (currentIndex > 0) {
                gameState.creditRating = ratings[currentIndex - 1];
                
                // 대출 한도 업데이트
                updateLoanLimit();
                
                showToast(`신용 등급이 ${gameState.creditRating}로 상승했습니다.`, 'success');
            }
        }
        
        // 대출 한도 업데이트
        function updateLoanLimit() {
            const baseLimit = 50000000; // 5천만원 기본 한도
            const limitMultiplier = CONSTANTS.CREDIT_RATINGS[gameState.creditRating].loanLimitMultiplier;
            gameState.loanLimit = baseLimit * limitMultiplier;
        }
        
        // UI 업데이트
        function updateUI() {
            // 모든 잔액 표시 업데이트
            document.querySelectorAll('.balance-value').forEach(el => {
                el.textContent = formatCurrency(gameState.balance);
            });
            
            // 모든 대출 표시 업데이트
            document.querySelectorAll('.loan-value').forEach(el => {
                el.textContent = formatCurrency(gameState.loan);
            });
            
            updateTimeDisplay();
        }
        
        // 통화 형식 포맷팅
        function formatCurrency(amount) {
            return '₩' + Math.floor(amount).toLocaleString();
        }
        
        // 백분율 형식 포맷팅
        function formatPercentage(percent) {
            return percent.toFixed(2) + '%';
        }
        
        // 게임 일시정지 토글
        function toggleGamePause() {
            gameState.paused = !gameState.paused;
            
            const pauseBtn = document.getElementById('pause-game');
            if (gameState.paused) {
                pauseBtn.textContent = '재개하기';
                showToast('게임이 일시정지되었습니다.', 'info');
            } else {
                pauseBtn.textContent = '일시정지';
                showToast('게임이 재개되었습니다.', 'info');
            }
        }
        
        // 게임 저장 (파일로 다운로드)
        function saveGame() {
            try {
                // 게임 상태 직렬화
                const saveData = JSON.stringify(gameState, null, 2);
                
                // 파일명 생성 (날짜 포함)
                const date = new Date();
                const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
                const fileName = `stock_simulator_save_${dateStr}.json`;
                
                // Blob 객체 생성
                const blob = new Blob([saveData], { type: 'application/json' });
                
                // 다운로드 링크 생성 및 클릭
                const downloadUrl = window.URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.download = fileName;
                
                // DOM에 추가하여 클릭
                document.body.appendChild(downloadLink);
                
                // 다운로드 시작 (강제 클릭)
                downloadLink.click();
                
                // 다운로드 시작 후 정리
                setTimeout(() => {
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(downloadLink);
                    showToast('게임이 파일로 저장되었습니다.', 'success');
                }, 100);
            } catch (error) {
                console.error('저장 오류:', error);
                showToast('저장에 실패했습니다: ' + error.message, 'error');
            }
        }
        
        // 게임 불러오기 모달 표시
        function showLoadGameModal() {
            // 에러 메시지 초기화
            const errorElement = document.getElementById('load-game-error');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // 파일 선택 입력 초기화
            const fileInput = document.getElementById('load-game-file');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // 인트로 모달 숨기기 (열려있을 경우)
            const introModal = document.getElementById('intro-modal');
            if (introModal && introModal.classList.contains('show')) {
                hideModal(introModal);
                
                // 약간의 지연 후 로드 모달 표시
                setTimeout(() => {
                    // 모달 표시
                    showModal(document.getElementById('load-game-modal'));
                }, 300); // 애니메이션 시간 이후
            } else {
                // 모달 즉시 표시
                showModal(document.getElementById('load-game-modal'));
            }
        }
        
        // 선택한 파일에서 게임 불러오기
        function loadGameFromFile() {
            const fileInput = document.getElementById('load-game-file');
            const errorElement = document.getElementById('load-game-error');
            
            // 파일 선택 확인
            if (!fileInput.files || fileInput.files.length === 0) {
                errorElement.textContent = '파일을 선택해주세요.';
                errorElement.style.display = 'block';
                return;
            }
            
            const file = fileInput.files[0];
            
            // 파일 크기 확인 (최대 10MB)
            if (file.size > 10 * 1024 * 1024) {
                errorElement.textContent = '파일 크기가 너무 큽니다. (최대 10MB)';
                errorElement.style.display = 'block';
                return;
            }
            
            // FileReader를 사용하여 파일 읽기
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log("File loaded, content:", e.target.result.substring(0, 100) + "...");
                    
                    // JSON 파싱
                    const loadedState = JSON.parse(e.target.result);
                    console.log("JSON parsed successfully", Object.keys(loadedState));
                    
                    // 필수 필드 확인
                    if (!validateGameState(loadedState)) {
                        errorElement.textContent = '올바른 게임 저장 파일이 아닙니다.';
                        errorElement.style.display = 'block';
                        return;
                    }
                    
                    // 게임 상태 업데이트 - 깊은 복사로 수정
                    gameState = JSON.parse(JSON.stringify(loadedState));
                    console.log("Game state updated", Object.keys(gameState));
                    
                    // 누락된 필드 초기화 (구버전 호환성)
                    initMissingFields();
                    
                    // 메인 타이머 초기화를 위한 딜레이
                    setTimeout(() => {
                        // DOM 요소 다시 캐싱 (필요시)
                        refreshDOMCache();
                        
                        // UI 업데이트
                        updateUI();
                        renderStockList();
                        renderPropertyList();
                        updatePortfolio();
                        renderTransactions();
                        
                        // 모달 순서대로 숨기기
                        hideModal(document.getElementById('load-game-modal'));
                        hideModal(document.getElementById('intro-modal'));
                        
                        // 로드 확인
                        showToast('게임을 성공적으로 불러왔습니다.', 'success');
                        console.log("Game loaded successfully");
                        
                        // 게임이 멈춰있으면 일시정지 표시
                        if (gameState.paused) {
                            document.getElementById('pause-game').textContent = '재개하기';
                        }
                        
                        // 게임 실행 상태 확인 - 게임이 진행 중이었다면 계속 실행
                        if (gameState.running && !gameState.paused) {
                            gameState.running = true; // 명시적으로 설정
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('파일 파싱 오류:', error);
                    errorElement.textContent = '파일을 읽는 중 오류가 발생했습니다: ' + error.message;
                    errorElement.style.display = 'block';
                }
            };
            
            reader.onerror = function(e) {
                console.error("FileReader error:", e);
                errorElement.textContent = '파일을 읽는 중 오류가 발생했습니다.';
                errorElement.style.display = 'block';
            };
            
            // 파일을 텍스트로 읽기
            reader.readAsText(file);
        }
        
        // DOM 요소 다시 캐싱 (필요시)
        function refreshDOMCache() {
            // 필요한 DOM 요소 다시 캐싱
            DOM.stockList = document.querySelector('.stock-list');
            DOM.realEstateList = document.querySelector('.real-estate-list');
            DOM.portfolioList = document.querySelector('.portfolio-list');
            DOM.transactionsList = document.querySelector('.transactions-list');
        }
        
        // 게임 상태 유효성 검사
        function validateGameState(state) {
            // 필수 필드 확인
            const requiredFields = ['balance', 'loan', 'time', 'day', 'stocks', 'properties', 'portfolio', 'transactions'];
            
            for (const field of requiredFields) {
                if (!(field in state)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 누락된 필드 초기화 (이전 버전 저장 파일 호환)
        function initMissingFields() {
            // 신용 등급 시스템이 없는 이전 버전 호환
            if (!gameState.creditRating) {
                gameState.creditRating = 'A';
            }
            
            if (!gameState.loanHistory) {
                gameState.loanHistory = [];
            }
            
            if (!gameState.activeLoans) {
                gameState.activeLoans = [];
            }
            
            if (!gameState.loanLimit) {
                gameState.loanLimit = 50000000;
            }
            
            // 부동산 이미지 URL 확인 및 수정
            if (gameState.properties && gameState.properties.length > 0) {
                // 부동산 이미지 URL 확인 및 교체
                gameState.properties.forEach((property, index) => {
                    if (!property.imageUrl || property.imageUrl.includes('unsplash.com')) {
                        // 외부 URL이거나 누락된 이미지인 경우 플레이스홀더로 교체
                        property.imageUrl = `/api/placeholder/400/320?text=Property_${index + 1}`;
                    }
                });
            }
            
            // 대출 한도 업데이트
            updateLoanLimit();
        }
        
        // 부동산 정렬
        function sortProperties(method) {
            gameState.propertySortMethod = method;
            
            const sortButtons = document.querySelectorAll('.sort-btn');
            sortButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sort === method) {
                    btn.classList.add('active');
                }
            });
            
            let sortedProperties = [...gameState.properties];
            
            switch (method) {
                case 'name':
                    sortedProperties.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-asc':
                    sortedProperties.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    sortedProperties.sort((a, b) => b.price - a.price);
                    break;
                case 'units':
                    sortedProperties.sort((a, b) => b.units - a.units);
                    break;
            }
            
            gameState.properties = sortedProperties;
            renderPropertyList();
            
            showToast(`부동산을 ${
                method === 'name' ? '이름순' : 
                method === 'price-asc' ? '가격 낮은순' : 
                method === 'price-desc' ? '가격 높은순' : 
                '세대수순'
            }으로 정렬했습니다.`, 'info');
        }
        
        // 주식 목록 렌더링
        function renderStockList() {
            DOM.stockList.innerHTML = '';
            
            gameState.stocks.forEach(stock => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                stockItem.dataset.code = stock.code;
                
                const priceChange = stock.price - stock.prevPrice;
                const priceChangePercent = (priceChange / stock.prevPrice) * 100;
                const changeClass = priceChange >= 0 ? 'positive' : 'negative';
                
                stockItem.innerHTML = `
                    <div class="stock-name">${stock.name} <span style="font-size: 12px; color: #8e939d;">${stock.code}</span></div>
                    <div class="stock-price">
                        <span class="price-value">${formatCurrency(stock.price)}</span>
                        <span class="price-change ${changeClass}">${formatPercentage(priceChangePercent)}</span>
                    </div>
                `;
                
                stockItem.addEventListener('click', () => selectStock(stock.code));
                DOM.stockList.appendChild(stockItem);
            });
        }
        
        // 부동산 목록 렌더링
        function renderPropertyList() {
            const container = document.querySelector('.real-estate-list');
            const sortControls = container.querySelector('.sort-controls');
            
            // 정렬 컨트롤 이후의 내용만 지우기
            while (container.lastChild !== sortControls) {
                container.removeChild(container.lastChild);
            }
            
            gameState.properties.forEach(property => {
                const propertyItem = document.createElement('div');
                propertyItem.className = 'property-item';
                propertyItem.dataset.id = property.id;
                
                // 사용자가 이 부동산을 소유하는지 확인
                const isOwned = gameState.portfolio.some(item => 
                    item.type === 'property' && item.id === property.id
                );
                
                // 이미지 URL 유효성 검사 (없거나 로드 실패 시 대체 이미지 사용)
                const imageUrl = property.imageUrl || `/api/placeholder/400/320?text=${encodeURIComponent(property.name)}`;
                
                propertyItem.innerHTML = `
                    <div class="property-name">${property.name}</div>
                    <div class="property-price">
                        <span class="price-value">${formatCurrency(property.price)}</span>
                        <span>${isOwned ? '소유 중' : '매물'}</span>
                    </div>
                    <div class="property-details">
                        <div>${property.district} | ${property.size}㎡ | ${property.units}세대</div>
                    </div>
                    <img src="${imageUrl}" alt="${property.name}" class="property-image-small" onerror="this.src='/api/placeholder/400/320?text=Error';">
                `;
                
                propertyItem.addEventListener('click', () => selectProperty(property.id));
                container.appendChild(propertyItem);
            });
        }
        
        // 주식 선택
        function selectStock(code) {
            gameState.selectedAsset = code;
            gameState.selectedAssetType = 'stock';
            
            const stock = gameState.stocks.find(s => s.code === code);
            if (!stock) return;
            
            updateAssetInfo(stock);
            
            // 선택한 주식의 차트 표시
            DOM.chartCanvas.style.display = 'block';
            DOM.chartPlaceholder.style.display = 'none';
            renderChart(stock);
            
            // 거래 폼 업데이트
            DOM.tradePrice.value = stock.price.toFixed(0);
            updateTradeTotal();
            
            // 거래 버튼 활성화
            DOM.buyButton.disabled = false;
            DOM.sellButton.disabled = !hasStockInPortfolio(stock.code);
        }
        
        // 부동산 선택
        function selectProperty(id) {
            gameState.selectedAsset = id;
            gameState.selectedAssetType = 'property';
            
            const property = gameState.properties.find(p => p.id === id);
            if (!property) return;
            
            // 이미 소유하고 있는지 확인
            const isOwned = gameState.portfolio.some(item => 
                item.type === 'property' && item.id === property.id
            );
            
            if (isOwned) {
                // 부동산 상세 정보 표시
                updateAssetInfo(property);
                DOM.chartCanvas.style.display = 'none';
                DOM.chartPlaceholder.style.display = 'flex';
                DOM.chartPlaceholder.textContent = '부동산은 차트를 제공하지 않습니다';
            } else {
                // 부동산 구매 모달 표시
                showPropertyModal(property);
            }
        }
        
        // 자산 정보 표시 업데이트
        function updateAssetInfo(asset) {
            if (gameState.selectedAssetType === 'stock') {
                const stock = asset;
                DOM.assetName.textContent = `${stock.name} (${stock.code})`;
                DOM.assetDescription.textContent = `${stock.sector} | 고가: ${formatCurrency(stock.high)} | 저가: ${formatCurrency(stock.low)}`;
                
                const priceChangePercent = ((stock.price - stock.prevPrice) / stock.prevPrice) * 100;
                DOM.assetPrice.textContent = `${formatCurrency(stock.price)} (${priceChangePercent >= 0 ? '+' : ''}${formatPercentage(priceChangePercent)})`;
                DOM.assetPrice.className = 'asset-price ' + (priceChangePercent >= 0 ? 'positive' : 'negative');
                
                // 거래 폼 업데이트
                DOM.tradePrice.value = stock.price.toFixed(0);
                updateTradeTotal();
            } else if (gameState.selectedAssetType === 'property') {
                const property = asset;
                DOM.assetName.textContent = property.name;
                DOM.assetDescription.textContent = `${property.district} | ${property.size}㎡ | ${property.units}세대 (${property.occupied}세대 입주중)`;
                DOM.assetPrice.textContent = formatCurrency(property.price);
                DOM.assetPrice.className = 'asset-price';
            }
        }
        
        // 선택한 주식의 차트 Canvas로 렌더링 
        function renderChart(stock) {
            const canvas = DOM.chartCanvas;
            if (!canvas) return;
            
            DOM.chartPlaceholder.style.display = 'none';
            canvas.style.display = 'block';
            
            // 선택한 간격의 차트 데이터 가져오기
            const chartData = gameState.chartData[stock.code][gameState.chartInterval];
            if (!chartData || chartData.length === 0) {
                DOM.chartPlaceholder.style.display = 'flex';
                DOM.chartPlaceholder.textContent = '차트 데이터가 없습니다';
                canvas.style.display = 'none';
                return;
            }
            
            // 캔버스 크기 설정
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            // 캔버스 지우기
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 배경 설정
            ctx.fillStyle = '#131722';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 가격 범위 계산
            let minPrice = Infinity;
            let maxPrice = -Infinity;
            
            chartData.forEach(candle => {
                minPrice = Math.min(minPrice, candle.low);
                maxPrice = Math.max(maxPrice, candle.high);
            });
            
            // 여백 추가
            const pricePadding = (maxPrice - minPrice) * 0.1;
            minPrice = minPrice - pricePadding;
            maxPrice = maxPrice + pricePadding;
            
            // 차트 치수
            const chartWidth = rect.width;
            const chartHeight = rect.height;
            const padding = { top: 20, right: 50, bottom: 30, left: 60 };
            const innerWidth = chartWidth - padding.left - padding.right;
            const innerHeight = chartHeight - padding.top - padding.bottom;
            
            // 줌에 따른 가시 범위 계산
            const visibleCandleCount = Math.ceil(chartData.length / chartZoom.scale);
            const startIdx = Math.max(0, Math.min(
                chartData.length - visibleCandleCount,
                Math.floor(chartZoom.offsetX / (innerWidth / chartData.length) * chartZoom.scale)
            ));
            const endIdx = Math.min(chartData.length, startIdx + visibleCandleCount);
            const visibleData = chartData.slice(startIdx, endIdx);
            
            // 줌을 고려한 스케일 계산
            const xScale = innerWidth / visibleData.length;
            const yScale = innerHeight / (maxPrice - minPrice);
            
            // 그리드 그리기
            ctx.strokeStyle = '#1e2230';
            ctx.lineWidth = 1;
            
            // 수평 그리드 선
            const yGridLines = 5;
            for (let i = 0; i <= yGridLines; i++) {
                const y = padding.top + (i / yGridLines) * innerHeight;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(chartWidth - padding.right, y);
                ctx.stroke();
                
                // 가격 레이블
                const price = maxPrice - (i / yGridLines) * (maxPrice - minPrice);
                ctx.fillStyle = '#d1d4dc';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(0), padding.left - 5, y + 3);
            }
            
            // 수직 그리드 선
            const xGridLines = Math.min(visibleData.length, 10);
            for (let i = 0; i <= xGridLines; i++) {
                const x = padding.left + (i / xGridLines) * innerWidth;
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, chartHeight - padding.bottom);
                ctx.stroke();
                
                // 시간 레이블
                if (i < xGridLines) {
                    const dataIndex = Math.floor((i / xGridLines) * (visibleData.length - 1));
                    const date = new Date(visibleData[dataIndex].time * 1000);
                    const timeLabel = formatChartTime(date, gameState.chartInterval);
                    
                    ctx.fillStyle = '#d1d4dc';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(timeLabel, x, chartHeight - padding.bottom + 15);
                }
            }
            
            // 캔들스틱 그리기
            for (let i = 0; i < visibleData.length; i++) {
                const candle = visibleData[i];
                const x = padding.left + i * xScale;
                
                // 캔들 위치 계산
                const openY = padding.top + (maxPrice - candle.open) * yScale;
                const closeY = padding.top + (maxPrice - candle.close) * yScale;
                const highY = padding.top + (maxPrice - candle.high) * yScale;
                const lowY = padding.top + (maxPrice - candle.low) * yScale;
                
                // 캔들이 상승인지 하락인지 결정
                const isUp = candle.close >= candle.open;
                
                // 심지 그리기
                ctx.strokeStyle = isUp ? '#26a69a' : '#ef5350';
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // 캔들 몸통 그리기
                ctx.fillStyle = isUp ? '#26a69a' : '#ef5350';
                const candleWidth = Math.max(1, xScale * 0.8);
                const halfCandleWidth = candleWidth / 2;
                
                // 가시성을 위한 최소 높이 보장
                const candleHeight = Math.max(1, Math.abs(closeY - openY));
                
                ctx.fillRect(
                    x - halfCandleWidth,
                    isUp ? closeY : openY,
                    candleWidth,
                    candleHeight
                );
            }
            
            // 현재 가격선 그리기
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 3]);
            
            const currentPriceY = padding.top + (maxPrice - stock.price) * yScale;
            
            ctx.beginPath();
            ctx.moveTo(padding.left, currentPriceY);
            ctx.lineTo(chartWidth - padding.right, currentPriceY);
            ctx.stroke();
            
            // 라인 대시 초기화
            ctx.setLineDash([]);
            
            // 현재 가격 레이블
            ctx.fillStyle = '#ffff00';
            ctx.font = 'bold 10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(
                stock.price.toFixed(0),
                chartWidth - padding.right + 5,
                currentPriceY + 3
            );
            
            // 줌 표시기 그리기
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(
                `줌: ${(chartZoom.scale * 100).toFixed(0)}%`,
                chartWidth - padding.right - 10,
                padding.top + 20
            );
        }
        
        // 차트 시간 레이블 포맷팅
        function formatChartTime(date, interval) {
            switch (interval) {
                case '1m':
                case '5m':
                case '15m':
                    return date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
                case '1h':
                    return date.getHours() + ':00';
                case '1d':
                    return (date.getMonth() + 1) + '/' + date.getDate();
                default:
                    return '';
            }
        }
        
        // 차트 줌 설정
        function setupChartZoom() {
            const canvas = DOM.chartCanvas;
            if (!canvas) return;
            
            // 마우스 휠 줌
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(
                    chartZoom.minScale,
                    Math.min(chartZoom.maxScale, chartZoom.scale + delta)
                );
                
                // 스케일 조정
                chartZoom.scale = newScale;
                
                // 주식이 선택되어 있으면 차트 렌더링
                if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                    const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                    if (stock) {
                        renderChart(stock);
                    }
                }
            });
            
            // 마우스 드래그로 팬
            canvas.addEventListener('mousedown', function(e) {
                chartZoom.isDragging = true;
                chartZoom.startX = e.clientX;
                chartZoom.startOffsetX = chartZoom.offsetX;
            });
            
            document.addEventListener('mousemove', function(e) {
                if (chartZoom.isDragging) {
                    const dx = e.clientX - chartZoom.startX;
                    chartZoom.offsetX = Math.max(0, chartZoom.startOffsetX - dx);
                    
                    // 주식이 선택되어 있으면 차트 렌더링
                    if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                        const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                        if (stock) {
                            renderChart(stock);
                        }
                    }
                }
            });
            
            document.addEventListener('mouseup', function() {
                chartZoom.isDragging = false;
            });
            
            // 줌 버튼
            document.getElementById('zoom-in').addEventListener('click', function() {
                chartZoom.scale = Math.min(chartZoom.maxScale, chartZoom.scale + 0.2);
                
                // 주식이 선택되어 있으면 차트 렌더링
                if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                    const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                    if (stock) {
                        renderChart(stock);
                    }
                }
            });
            
            document.getElementById('zoom-out').addEventListener('click', function() {
                chartZoom.scale = Math.max(chartZoom.minScale, chartZoom.scale - 0.2);
                
                // 주식이 선택되어 있으면 차트 렌더링
                if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                    const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                    if (stock) {
                        renderChart(stock);
                    }
                }
            });
            
            // 줌 초기화
            document.getElementById('reset-zoom').addEventListener('click', function() {
                chartZoom.scale = 1;
                chartZoom.offsetX = 0;
                
                // 주식이 선택되어 있으면 차트 렌더링
                if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                    const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                    if (stock) {
                        renderChart(stock);
                    }
                }
            });
        }
        
        // 거래 총액 업데이트
        function updateTradeTotal() {
            const price = parseFloat(DOM.tradePrice.value);
            const quantity = parseInt(DOM.tradeQuantity.value);
            
            if (!isNaN(price) && !isNaN(quantity)) {
                DOM.tradeTotal.value = (price * quantity).toFixed(0);
            }
        }
        
        // 매수 준비
        function prepareBuyStock() {
            if (!gameState.selectedAsset || gameState.selectedAssetType !== 'stock') return;
            
            const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
            if (!stock) return;
            
            const quantity = parseInt(DOM.tradeQuantity.value);
            const totalCost = stock.price * quantity;
            
            if (isNaN(quantity) || quantity <= 0) {
                showToast('유효한 수량을 입력하세요.', 'error');
                return;
            }
            
            if (totalCost > gameState.balance) {
                showToast('잔액이 부족합니다.', 'error');
                return;
            }
            
            // 확인 모달 값 설정
            document.getElementById('confirm-buy-asset').textContent = stock.name;
            document.getElementById('confirm-buy-quantity').textContent = quantity;
            document.getElementById('confirm-buy-price').textContent = formatCurrency(stock.price);
            document.getElementById('confirm-buy-total').textContent = formatCurrency(totalCost);
            
            // 확인 모달 표시
            document.getElementById('confirm-buy-modal').style.display = 'block';
        }
        
        // 매수 확인
        function confirmBuyStock() {
            if (!gameState.selectedAsset || gameState.selectedAssetType !== 'stock') return;
            
            const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
            if (!stock) return;
            
            const quantity = parseInt(DOM.tradeQuantity.value);
            const totalCost = stock.price * quantity;
            
            // 잔액에서 비용 차감
            gameState.balance -= totalCost;
            
            // 포트폴리오에 추가 또는 기존 항목 업데이트
            const existingPosition = gameState.portfolio.find(item => 
                item.type === 'stock' && item.code === stock.code
            );
            
            if (existingPosition) {
                // 새 평균 가격 계산
                const totalValue = existingPosition.avgPrice * existingPosition.quantity + totalCost;
                const newQuantity = existingPosition.quantity + quantity;
                existingPosition.avgPrice = totalValue / newQuantity;
                existingPosition.quantity = newQuantity;
            } else {
                gameState.portfolio.push({
                    type: 'stock',
                    code: stock.code,
                    name: stock.name,
                    quantity: quantity,
                    avgPrice: stock.price
                });
            }
            
            // 거래 내역 추가
            gameState.transactions.unshift({
                type: '매수',
                asset: stock.name,
                price: stock.price,
                quantity: quantity,
                total: totalCost,
                time: new Date()
            });
            
            // 일일 요약에 추가
            gameState.daySummary.push({
                type: '주식 매수',
                asset: stock.name,
                amount: totalCost,
                time: { ...gameState.time }
            });
            
            // UI 업데이트
            updateUI();
            updatePortfolio();
            renderTransactions();
            DOM.sellButton.disabled = false;
            
            // 확인 모달 숨기기
            document.getElementById('confirm-buy-modal').style.display = 'none';
            
            // 토스트 표시
            showToast(`${stock.name} ${quantity}주를 매수했습니다.`, 'success');
        }
        
        // 매도 준비
        function prepareSellStock() {
            if (!gameState.selectedAsset || gameState.selectedAssetType !== 'stock') return;
            
            const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
            if (!stock) return;
            
            const position = gameState.portfolio.find(item => 
                item.type === 'stock' && item.code === stock.code
            );
            
            if (!position) {
                showToast('해당 주식을 보유하고 있지 않습니다.', 'error');
                return;
            }
            
            const quantity = parseInt(DOM.tradeQuantity.value);
            const totalValue = stock.price * quantity;
            
            if (isNaN(quantity) || quantity <= 0) {
                showToast('유효한 수량을 입력하세요.', 'error');
                return;
            }
            
            if (quantity > position.quantity) {
                showToast('보유 수량보다 많이 매도할 수 없습니다.', 'error');
                return;
            }
            
            // 확인 모달 값 설정
            document.getElementById('confirm-sell-asset').textContent = stock.name;
            document.getElementById('confirm-sell-quantity').textContent = quantity;
            document.getElementById('confirm-sell-price').textContent = formatCurrency(stock.price);
            document.getElementById('confirm-sell-total').textContent = formatCurrency(totalValue);
            
            // 확인 모달 표시
            document.getElementById('confirm-sell-modal').style.display = 'block';
        }
        
        // 매도 확인
        function confirmSellStock() {
            if (!gameState.selectedAsset || gameState.selectedAssetType !== 'stock') return;
            
            const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
            if (!stock) return;
            
            const position = gameState.portfolio.find(item => 
                item.type === 'stock' && item.code === stock.code
            );
            
            if (!position) return;
            
            const quantity = parseInt(DOM.tradeQuantity.value);
            const totalValue = stock.price * quantity;
            
            // 잔액에 가치 추가
            gameState.balance += totalValue;
            
            // 포트폴리오 업데이트
            if (quantity === position.quantity) {
                // 모두 판매한 경우 포지션 제거
                gameState.portfolio = gameState.portfolio.filter(item => 
                    !(item.type === 'stock' && item.code === stock.code)
                );
                DOM.sellButton.disabled = true;
            } else {
                // 수량 업데이트
                position.quantity -= quantity;
            }
            
            // 거래 내역 추가
            gameState.transactions.unshift({
                type: '매도',
                asset: stock.name,
                price: stock.price,
                quantity: quantity,
                total: totalValue,
                time: new Date()
            });
            
            // 일일 요약에 추가
            gameState.daySummary.push({
                type: '주식 매도',
                asset: stock.name,
                amount: totalValue,
                time: { ...gameState.time }
            });
            
            // UI 업데이트
            updateUI();
            updatePortfolio();
            renderTransactions();
            
            // 확인 모달 숨기기
            document.getElementById('confirm-sell-modal').style.display = 'none';
            
            // 토스트 표시
            showToast(`${stock.name} ${quantity}주를 매도했습니다.`, 'success');
        }
        
        // 부동산 모달 표시
        function showPropertyModal(property) {
            DOM.propertyName.value = property.name;
            DOM.propertyPrice.value = property.price;
            DOM.propertySize.value = property.size;
            DOM.propertyUnits.value = property.units;
            DOM.propertyOccupied.value = property.occupied;
            
            // 이미지 URL 검사 및 설정
            const imageUrl = property.imageUrl || `/api/placeholder/400/320?text=${encodeURIComponent(property.name)}`;
            DOM.propertyImage.src = imageUrl;
            
            // 이미지 오류 처리
            DOM.propertyImage.onerror = function() {
                this.src = '/api/placeholder/400/320?text=Image_Not_Found';
            };
            
            document.getElementById('btn-buy-property').onclick = () => buyProperty(property.id);
            
            showModal(DOM.propertyModal);
        }
        
        // 부동산 구매
        function buyProperty(id) {
            const property = gameState.properties.find(p => p.id === id);
            if (!property) return;
            
            if (property.price > gameState.balance) {
                showToast('잔액이 부족합니다.', 'error');
                return;
            }
            
            // 잔액에서 비용 차감
            gameState.balance -= property.price;
            
            // 포트폴리오에 추가
            gameState.portfolio.push({
                type: 'property',
                id: property.id,
                name: property.name,
                purchasePrice: property.price,
                currentValue: property.price
            });
            
            // 거래 내역 추가
            gameState.transactions.unshift({
                type: '부동산 구매',
                asset: property.name,
                price: property.price,
                quantity: 1,
                total: property.price,
                time: new Date()
            });
            
            // 일일 요약에 추가
            gameState.daySummary.push({
                type: '부동산 구매',
                asset: property.name,
                amount: property.price,
                time: { ...gameState.time }
            });
            
            // UI 업데이트
            updateUI();
            updatePortfolio();
            renderTransactions();
            renderPropertyList();
            
            // 모달 숨기기
            hideModal(DOM.propertyModal);
            
            // 토스트 표시
            showToast(`${property.name}을(를) 구매했습니다.`, 'success');
        }
        
        // 포트폴리오 표시 업데이트
        function updatePortfolio() {
            // 현재 가치 계산
            gameState.portfolio.forEach(item => {
                if (item.type === 'stock') {
                    const stock = gameState.stocks.find(s => s.code === item.code);
                    if (stock) {
                        item.currentValue = stock.price * item.quantity;
                    }
                } else if (item.type === 'property') {
                    const property = gameState.properties.find(p => p.id === item.id);
                    if (property) {
                        // 부동산 가치는 현재 변경되지 않음
                        item.currentValue = property.price;
                    }
                }
            });
            
            // 포트폴리오 목록 렌더링
            renderPortfolio();
        }
        
        // 포트폴리오 렌더링
        function renderPortfolio() {
            DOM.portfolioList.innerHTML = '';
            
            if (gameState.portfolio.length === 0) {
                DOM.portfolioList.innerHTML = '<div class="portfolio-item">보유 자산이 없습니다.</div>';
                return;
            }
            
            gameState.portfolio.forEach(item => {
                const portfolioItem = document.createElement('div');
                portfolioItem.className = 'portfolio-item';
                
                if (item.type === 'stock') {
                    const profitLoss = item.currentValue - (item.avgPrice * item.quantity);
                    const profitLossPercent = (profitLoss / (item.avgPrice * item.quantity)) * 100;
                    const changeClass = profitLoss >= 0 ? 'positive' : 'negative';
                    
                    portfolioItem.innerHTML = `
                        <div class="portfolio-name">${item.name}</div>
                        <div class="portfolio-details">
                            <span>${item.quantity}주</span>
                            <span>${formatCurrency(item.currentValue)}</span>
                        </div>
                        <div class="portfolio-details">
                            <span>평균가 ${formatCurrency(item.avgPrice)}</span>
                            <span class="${changeClass}">${formatPercentage(profitLossPercent)}</span>
                        </div>
                    `;
                } else if (item.type === 'property') {
                    const property = gameState.properties.find(p => p.id === item.id);
                    
                    let rentalIncome = 0;
                    if (property) {
                        rentalIncome = property.tenants.reduce((sum, tenant) => sum + tenant.rent, 0);
                    }
                    
                    portfolioItem.innerHTML = `
                        <div class="portfolio-name">${item.name}</div>
                        <div class="portfolio-details">
                            <span>가치</span>
                            <span>${formatCurrency(item.currentValue)}</span>
                        </div>
                        <div class="portfolio-details">
                            <span>월세 수입</span>
                            <span>${formatCurrency(rentalIncome)} / 월</span>
                        </div>
                    `;
                }
                
                DOM.portfolioList.appendChild(portfolioItem);
            });
        }
        
        // 거래 내역 렌더링
        function renderTransactions() {
            DOM.transactionsList.innerHTML = '';
            
            if (gameState.transactions.length === 0) {
                DOM.transactionsList.innerHTML = '<div class="transaction-item">거래 내역이 없습니다.</div>';
                return;
            }
            
            // 최근 10개 거래만 표시
            const recentTransactions = gameState.transactions.slice(0, 10);
            
            recentTransactions.forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                const typeClass = transaction.type.includes('매수') || transaction.type.includes('구매') ? 'negative' : 'positive';
                
                transactionItem.innerHTML = `
                    <div class="transaction-type ${typeClass}">${transaction.type} - ${transaction.asset}</div>
                    <div class="transaction-details">
                        <span>${formatCurrency(transaction.price)} × ${transaction.quantity}</span>
                        <span>${formatCurrency(transaction.total)}</span>
                    </div>
                    <div class="transaction-details">
                        <span>${transaction.time.toLocaleTimeString()}</span>
                    </div>
                `;
                
                DOM.transactionsList.appendChild(transactionItem);
            });
        }
        
        // 일일 청구서 생성
        function generateDailyBills() {
            const billsList = document.getElementById('bills-list');
            billsList.innerHTML = '';
            
            let totalBills = 0;
            const bills = [];
            
            // 소유한 각 부동산에 대한 청구서 생성
            gameState.portfolio.forEach(item => {
                if (item.type === 'property') {
                    const property = gameState.properties.find(p => p.id === item.id);
                    if (property) {
                        // 관리비
                        const managementFee = property.size * 1000; // 제곱미터당 1,000원
                        bills.push({
                            property: property.name,
                            type: '관리비',
                            amount: managementFee
                        });
                        totalBills += managementFee;
                        
                        // 전기세
                        const electricityFee = property.units * 15000; // 세대당 15,000원
                        bills.push({
                            property: property.name,
                            type: '전기세',
                            amount: electricityFee
                        });
                        totalBills += electricityFee;
                        
                        // 수도세
                        const waterFee = property.units * 8000; // 세대당 8,000원
                        bills.push({
                            property: property.name,
                            type: '수도세',
                            amount: waterFee
                        });
                        totalBills += waterFee;
                        
                        // 재산세 (월별 할부)
                        const propertyTax = property.price * 0.002 / 12; // 연간 0.2% 세금, 월별 지불
                        bills.push({
                            property: property.name,
                            type: '재산세',
                            amount: propertyTax
                        });
                        totalBills += propertyTax;
                    }
                }
            });
            
            // 부동산이 없는 경우, 기본 생활비 표시
            if (bills.length === 0) {
                const livingExpenses = 50000; // 하루당 50,000원
                bills.push({
                    property: '기본',
                    type: '생활비',
                    amount: livingExpenses
                });
                totalBills += livingExpenses;
            }
            
            // 청구서 표시
            bills.forEach(bill => {
                const billItem = document.createElement('div');
                billItem.className = 'bill-item';
                billItem.innerHTML = `
                    <span>${bill.property} - ${bill.type}</span>
                    <span>${formatCurrency(bill.amount)}</span>
                `;
                billsList.appendChild(billItem);
            });
            
            document.getElementById('bills-total').textContent = formatCurrency(totalBills);
            
            // 청구서 데이터 저장
            gameState.currentBills = {
                bills: bills,
                total: totalBills
            };
        }
        
        // 청구서 납부
        function payBills() {
            if (!gameState.currentBills) return;
            
            const totalBills = gameState.currentBills.total;
            
            if (totalBills > gameState.balance) {
                // 지불할 충분한 돈이 없으면 대출 발생
                gameState.loan += totalBills;
                gameState.daySummary.push({
                    type: '청산 비용 대출',
                    amount: totalBills,
                    time: { ...gameState.time }
                });
                
                showToast(`잔액 부족: ${formatCurrency(totalBills)}가 대출로 처리되었습니다.`, 'warning');
            } else {
                // 잔액에서 지불
                gameState.balance -= totalBills;
                gameState.daySummary.push({
                    type: '청산 비용 지불',
                    amount: totalBills,
                    time: { ...gameState.time }
                });
                
                showToast(`${formatCurrency(totalBills)}의 청산 비용을 지불했습니다.`, 'info');
            }
            
            // UI 업데이트
            updateUI();
            
            // 청구서 모달 숨기기 및 일일 요약 표시
            hideModal(DOM.billsModal);
            
            // 부동산에 대한 세입자 생성 (인기도 기반 확률)
            generateNewTenants();
        }
        
        // 새 세입자 생성
        function generateNewTenants() {
            const ownedProperties = gameState.portfolio
                .filter(item => item.type === 'property')
                .map(item => gameState.properties.find(p => p.id === item.id))
                .filter(property => property && property.occupied < property.units);
            
            if (ownedProperties.length === 0) {
                // 사용 가능한 부동산이 없으면 일일 요약으로 진행
                showDaySummary();
                return;
            }
            
            // 사용 가능한 유닛이 있는 랜덤 부동산 선택
            const property = ownedProperties[Math.floor(Math.random() * ownedProperties.length)];
            
            // 인기도 기반 확률 성공 시에만 세입자 표시
            if (Math.random() > property.popularity) {
                // 이번에는 세입자 없음
                showDaySummary();
                return;
            }
            
            // 세입자 생성
            const rentBase = property.price * 0.006 / property.units; // 월별 부동산 가치의 0.6%, 유닛으로 나눔
            const rentVariation = rentBase * 0.2; // 20% 변동
            const rent = rentBase + (Math.random() * 2 - 1) * rentVariation;
            const period = Math.floor(Math.random() * 10) + 6; // 6-15개월 기간
            
            const tenant = {
                id: Date.now(),
                rent: rent,
                period: period,
                monthsLeft: period,
                propertyId: property.id
            };
            
            // 현재 세입자 저장
            gameState.currentTenant = tenant;
            
            // 세입자 모달 표시
            document.getElementById('tenant-property-name').textContent = property.name;
            document.getElementById('tenant-rent').textContent = formatCurrency(tenant.rent);
            document.getElementById('tenant-period').textContent = tenant.period;
            
            document.getElementById('btn-accept-tenant').onclick = acceptTenant;
            document.getElementById('btn-reject-tenant').onclick = rejectTenant;
            
            showModal(DOM.tenantModal);
        }
        
        // 새 세입자 수락
        function acceptTenant() {
            if (!gameState.currentTenant) return;
            
            const tenant = gameState.currentTenant;
            const property = gameState.properties.find(p => p.id === tenant.propertyId);
            
            if (property && property.occupied < property.units) {
                // 부동산에 세입자 추가
                property.tenants.push(tenant);
                property.occupied += 1;
                property.rentalIncome += tenant.rent;
                
                // 일일 요약에 추가
                gameState.daySummary.push({
                    type: '새 세입자',
                    property: property.name,
                    rent: tenant.rent,
                    time: { ...gameState.time }
                });
                
                // UI 업데이트
                renderPropertyList();
                updatePortfolio();
                
                // 토스트 표시
                showToast(`${property.name}에 새 세입자가 입주했습니다. 월세: ${formatCurrency(tenant.rent)}`, 'success');
            }
            
            // 모달 숨기기 및 일일 요약 표시
            hideModal(DOM.tenantModal);
            showDaySummary();
        }
        
        // 세입자 거절
        function rejectTenant() {
            hideModal(DOM.tenantModal);
            showToast('새 세입자 요청을 거절했습니다.', 'info');
            showDaySummary();
        }
        
        // 일일 요약 표시
        function showDaySummary() {
            const summaryContainer = document.getElementById('day-summary');
            summaryContainer.innerHTML = '';
            
            if (gameState.daySummary.length === 0) {
                summaryContainer.innerHTML = '<div class="summary-item">오늘은 특별한 활동이 없었습니다.</div>';
            } else {
                gameState.daySummary.forEach(item => {
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    
                    let content = '';
                    switch (item.type) {
                        case '주식 매수':
                            content = `<strong>${formatTime(item.time)}</strong> - ${item.asset} 주식을 ${formatCurrency(item.amount)}에 매수했습니다.`;
                            break;
                        case '주식 매도':
                            content = `<strong>${formatTime(item.time)}</strong> - ${item.asset} 주식을 ${formatCurrency(item.amount)}에 매도했습니다.`;
                            break;
                        case '부동산 구매':
                            content = `<strong>${formatTime(item.time)}</strong> - ${item.asset}을(를) ${formatCurrency(item.amount)}에 구매했습니다.`;
                            break;
                        case '청산 비용 지불':
                            content = `<strong>${formatTime(item.time)}</strong> - 고지서 ${formatCurrency(item.amount)}을 납부했습니다.`;
                            break;
                        case '청산 비용 대출':
                            content = `<strong>${formatTime(item.time)}</strong> - 고지서 ${formatCurrency(item.amount)}을 납부하지 못해 대출이 발생했습니다.`;
                            break;
                        case '새 세입자':
                            content = `<strong>${formatTime(item.time)}</strong> - ${item.property}에 월세 ${formatCurrency(item.rent)}의 새 세입자가 입주했습니다.`;
                            break;
                        default:
                            content = `<strong>${formatTime(item.time)}</strong> - ${item.type}`;
                    }
                    
                    summaryItem.innerHTML = content;
                    summaryContainer.appendChild(summaryItem);
                });
            }
            
            // 월세 수입 있는 경우 추가
            let totalRentalIncome = 0;
            gameState.portfolio.forEach(item => {
                if (item.type === 'property') {
                    const property = gameState.properties.find(p => p.id === item.id);
                    if (property && property.tenants.length > 0) {
                        totalRentalIncome += property.tenants.reduce((sum, tenant) => sum + tenant.rent, 0);
                    }
                }
            });
            
            if (totalRentalIncome > 0) {
                const rentalItem = document.createElement('div');
                rentalItem.className = 'summary-item';
                rentalItem.innerHTML = `<strong>월세 수입</strong> - 총 ${formatCurrency(totalRentalIncome)}의 월세를 받았습니다.`;
                summaryContainer.appendChild(rentalItem);
                
                // 잔액에 추가
                gameState.balance += totalRentalIncome;
                updateUI();
            }
            
            // 일일 요약 모달 표시
            showModal(DOM.daySummaryModal);
        }
        
        // 시간 포맷
        function formatTime(time) {
            const hour = String(time.hour).padStart(2, '0');
            const minute = String(Math.floor(time.minute)).padStart(2, '0');
            return `${hour}:${minute}`;
        }
        
        // 일일 요약 후 게임 계속
        function continueGame() {
            hideModal(DOM.daySummaryModal);
            
            // 게임 시간 8:00으로 초기화
            gameState.time.hour = 8;
            gameState.time.minute = 0;
            
            // 게임 다시 시작
            gameState.running = true;
            
            // 시간 표시 업데이트
            updateTimeDisplay();
            
            // 토스트 표시
            showToast('새로운 하루가 시작되었습니다!', 'success');
        }
        
        // 포트폴리오에 주식이 있는지 확인
        function hasStockInPortfolio(code) {
            return gameState.portfolio.some(item => 
                item.type === 'stock' && item.code === code && item.quantity > 0
            );
        }
        
        // 일일 요약 생성
        function generateDaySummary() {
            // 이 함수는 각 날의 끝에 호출됨
            // 일일 요약 항목은 gameState.daySummary에 하루 동안 수집됨
        }
        
        // 토스트 메시지 표시
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = message;
            
            toastContainer.appendChild(toast);
            
            // 지정된 시간 후 제거
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.remove();
                }, 700); // 애니메이션 지속 시간
            }, duration);
        }
        
        // 모달 표시
        function showModal(modal) {
            // 모든 모달 숨기기 (z-index 문제 방지)
            const allModals = document.querySelectorAll('.modal-overlay');
            allModals.forEach(m => {
                if (m !== modal) {
                    m.style.display = 'none';
                    m.classList.remove('show');
                }
            });
            
            // 요청한 모달 표시
            modal.style.display = 'flex';
            // 애니메이션 효과를 위한 약간의 지연
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 모달 숨기기
        function hideModal(modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // 애니메이션 지속 시간
        }
        
        // 대출 관리자 모달 표시
        function showLoanManager() {
            // 현재 대출 정보 업데이트
            document.getElementById('current-loan').textContent = formatCurrency(calculateTotalLoan());
            document.getElementById('current-interest-rate').textContent = (getCurrentInterestRate() * 100).toFixed(1) + '%';
            document.getElementById('credit-rating').textContent = gameState.creditRating;
            document.getElementById('loan-limit').textContent = formatCurrency(gameState.loanLimit);
            
            // 대출 이력 표시
            renderLoanHistory();
            
            // 대출 상환 입력 필드 초기화
            document.getElementById('repay-amount').value = Math.min(1000000, gameState.balance);
            document.getElementById('repay-amount').max = gameState.balance;
            
            // 예상 이자 계산
            updateEstimatedInterest();
            
            // 모달 표시
            showModal(document.getElementById('loan-modal'));
        }
        
        // 대출 이력 렌더링
        function renderLoanHistory() {
            const historyList = document.getElementById('loan-history-list');
            historyList.innerHTML = '';
            
            if (gameState.loanHistory.length === 0) {
                historyList.innerHTML = '<div class="loan-history-item">대출 이력이 없습니다.</div>';
                return;
            }
            
            // 최근 항목부터 표시
            gameState.loanHistory.slice().reverse().forEach(loan => {
                const historyItem = document.createElement('div');
                historyItem.className = 'loan-history-item';
                
                historyItem.innerHTML = `
                    <span>${loan.type}: ${formatCurrency(loan.amount)}</span>
                    <span>${loan.date}일차 | ${(loan.interestRate * 100).toFixed(1)}%</span>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 예상 이자 업데이트
        function updateEstimatedInterest() {
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const term = parseInt(document.getElementById('loan-term').value);
            const rate = getCurrentInterestRate();
            
            if (!isNaN(amount) && !isNaN(term)) {
                // 간단한 이자 계산 (원금 * 이자율 * 기간/365)
                const interest = amount * rate * (term / 365);
                document.getElementById('estimated-interest').textContent = formatCurrency(interest);
            }
        }
        
        // 대출 신청
        function applyForLoan() {
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const term = parseInt(document.getElementById('loan-term').value);
            const rate = getCurrentInterestRate();
            
            if (isNaN(amount) || amount <= 0) {
                showToast('유효한 대출 금액을 입력하세요.', 'error');
                return;
            }
            
            // 대출 한도 확인
            const totalLoan = calculateTotalLoan();
            if (totalLoan + amount > gameState.loanLimit) {
                showToast('대출 한도를 초과했습니다.', 'error');
                return;
            }
            
            // 대출 생성
            const loan = {
                amount: amount,
                initialAmount: amount,
                term: term,
                daysLeft: term,
                interestRate: rate,
                accruedInterest: 0,
                date: gameState.day
            };
            
            // 활성 대출에 추가
            gameState.activeLoans.push(loan);
            
            // 대출 이력에 추가
            gameState.loanHistory.push({
                type: '대출 신청',
                amount: amount,
                date: gameState.day,
                interestRate: rate
            });
            
            // 잔액에 추가
            gameState.balance += amount;
            
            // UI 업데이트
            updateUI();
            
            // 대출 관리자 업데이트
            showLoanManager();
            
            showToast(`${formatCurrency(amount)}의 대출이 승인되었습니다.`, 'success');
        }
        
        // 대출 상환
        function repayLoan() {
            const amount = parseFloat(document.getElementById('repay-amount').value);
            
            if (isNaN(amount) || amount <= 0) {
                showToast('유효한 상환 금액을 입력하세요.', 'error');
                return;
            }
            
            if (amount > gameState.balance) {
                showToast('잔액이 부족합니다.', 'error');
                return;
            }
            
            let remainingAmount = amount;
            
            // 먼저 기존 대출 상환
            if (gameState.loan > 0) {
                const paymentToBaseLoad = Math.min(remainingAmount, gameState.loan);
                gameState.loan -= paymentToBaseLoad;
                remainingAmount -= paymentToBaseLoad;
            }
            
            // 남은 금액으로 활성 대출 상환 (오래된 대출부터)
            if (remainingAmount > 0 && gameState.activeLoans.length > 0) {
                // 오래된 대출부터 정렬
                gameState.activeLoans.sort((a, b) => a.date - b.date);
                
                for (let i = 0; i < gameState.activeLoans.length; i++) {
                    if (remainingAmount <= 0) break;
                    
                    const loan = gameState.activeLoans[i];
                    const totalLoanAmount = loan.amount + loan.accruedInterest;
                    
                    if (remainingAmount >= totalLoanAmount) {
                        // 대출을 완전히 상환
                        remainingAmount -= totalLoanAmount;
                        
                        // 대출 이력에 추가
                        gameState.loanHistory.push({
                            type: '대출 완전 상환',
                            amount: totalLoanAmount,
                            date: gameState.day,
                            interestRate: loan.interestRate
                        });
                        
                        // 활성 대출에서 제거
                        gameState.activeLoans.splice(i, 1);
                        i--;
                        
                        // 시간 내에 완전 상환하면 신용 등급 상승 가능성
                        if (loan.term - loan.daysLeft < loan.term / 2) {
                            // 50% 확률로 신용등급 상승
                            if (Math.random() < 0.5) {
                                upgradeCreditRating();
                            }
                        }
                    } else {
                        // 부분 상환 (이자부터 상환)
                        if (loan.accruedInterest > 0) {
                            const interestPayment = Math.min(remainingAmount, loan.accruedInterest);
                            loan.accruedInterest -= interestPayment;
                            remainingAmount -= interestPayment;
                        }
                        
                        // 나머지는 원금 상환
                        if (remainingAmount > 0) {
                            loan.amount -= remainingAmount;
                            remainingAmount = 0;
                        }
                        
                        // 대출 이력에 추가
                        gameState.loanHistory.push({
                            type: '대출 부분 상환',
                            amount: amount - remainingAmount,
                            date: gameState.day,
                            interestRate: loan.interestRate
                        });
                    }
                }
            }
            
            // 잔액 차감
            gameState.balance -= amount;
            
            // UI 업데이트
            updateUI();
            
            // 대출 관리자 업데이트
            showLoanManager();
            
            showToast(`${formatCurrency(amount)}의 대출을 상환했습니다.`, 'success');
        }
        
        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 탭 선택
            DOM.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // 활성 탭 업데이트
                    DOM.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 해당 목록 표시
                    document.querySelector('.stock-list').classList.remove('active');
                    document.querySelector('.real-estate-list').classList.remove('active');
                    document.querySelector(`.${tabName}-list`).classList.add('active');
                    
                    showToast(`${tabName === 'stock' ? '주식' : '부동산'} 탭으로 전환했습니다.`, 'info');
                });
            });
            
            // 차트 간격 선택
            DOM.intervals.forEach(interval => {
                interval.addEventListener('click', () => {
                    const intervalValue = interval.dataset.interval;
                    
                    // 활성 간격 업데이트
                    DOM.intervals.forEach(i => i.classList.remove('active'));
                    interval.classList.add('active');
                    
                    // 차트 간격 업데이트
                    gameState.chartInterval = intervalValue;
                    
                    // 주식이 선택된 경우 차트 업데이트
                    if (gameState.selectedAsset && gameState.selectedAssetType === 'stock') {
                        const stock = gameState.stocks.find(s => s.code === gameState.selectedAsset);
                        if (stock) {
                            renderChart(stock);
                            
                            // 토스트 표시
                            const intervalText = {
                                '1m': '1분',
                                '5m': '5분',
                                '15m': '15분',
                                '1h': '1시간',
                                '1d': '1일'
                            }[intervalValue];
                            
                            showToast(`차트 간격을 ${intervalText}으로 변경했습니다.`, 'info');
                        }
                    }
                });
            });
            
            // 거래 폼 이벤트
            DOM.tradeQuantity.addEventListener('input', updateTradeTotal);
            DOM.buyButton.addEventListener('click', prepareBuyStock);
            DOM.sellButton.addEventListener('click', prepareSellStock);
            
            // 매수 확인 버튼
            document.getElementById('confirm-buy').addEventListener('click', confirmBuyStock);
            document.getElementById('cancel-buy').addEventListener('click', () => {
                document.getElementById('confirm-buy-modal').style.display = 'none';
            });
            
            // 매도 확인 버튼
            document.getElementById('confirm-sell').addEventListener('click', confirmSellStock);
            document.getElementById('cancel-sell').addEventListener('click', () => {
                document.getElementById('confirm-sell-modal').style.display = 'none';
            });
            
            // 게임 일시정지 버튼
            document.getElementById('pause-game').addEventListener('click', toggleGamePause);
            
            // 대출 관리 버튼
            document.getElementById('loan-manager').addEventListener('click', showLoanManager);
            
            // 대출 모달 이벤트
            document.getElementById('loan-amount').addEventListener('input', updateEstimatedInterest);
            document.getElementById('loan-term').addEventListener('change', updateEstimatedInterest);
            document.getElementById('btn-apply-loan').addEventListener('click', applyForLoan);
            document.getElementById('btn-repay-loan').addEventListener('click', repayLoan);
            document.getElementById('btn-close-loan').addEventListener('click', () => {
                hideModal(document.getElementById('loan-modal'));
            });
            
            // 게임 저장 버튼
            document.getElementById('save-game').addEventListener('click', saveGame);
            
            // 게임 불러오기 버튼
            document.getElementById('load-game').addEventListener('click', showLoadGameModal);
            
            // 파일에서 게임 불러오기 버튼
            document.getElementById('btn-confirm-load-file').addEventListener('click', loadGameFromFile);
            document.getElementById('btn-cancel-load-file').addEventListener('click', () => {
                hideModal(document.getElementById('load-game-modal'));
            });
            
            // 불러오기 모달 닫기 버튼
            document.querySelector('#load-game-modal .modal-close').addEventListener('click', () => {
                hideModal(document.getElementById('load-game-modal'));
            });
            
            // 인트로 모달 버튼
            document.getElementById('btn-start-game').addEventListener('click', startNewGame);
            document.getElementById('btn-load-intro').addEventListener('click', showLoadGameModal);
            
            // 부동산 정렬 버튼
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    sortProperties(btn.dataset.sort);
                });
            });
            
            // 모달 닫기 버튼
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    const modal = closeBtn.closest('.modal-overlay');
                    hideModal(modal);
                });
            });
            
            // 부동산 모달 버튼
            document.getElementById('btn-close-property').addEventListener('click', () => {
                hideModal(DOM.propertyModal);
            });
            
            // 청구서 모달 버튼
            document.getElementById('btn-pay-bills').addEventListener('click', payBills);
            document.getElementById('btn-ignore-bills').addEventListener('click', payBills);
            
            // 일일 요약 모달 버튼
            document.getElementById('btn-continue-game').addEventListener('click', continueGame);
            document.getElementById('btn-quit-game').addEventListener('click', () => {
                alert('게임을 종료합니다.');
                location.reload();
            });
            
            // 파산 모달 버튼
            document.getElementById('btn-restart-game').addEventListener('click', () => {
                location.reload();
            });
            
            // 차트 줌 설정
            setupChartZoom();
        }
        
        // 페이지 로드 시 게임 초기화
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
