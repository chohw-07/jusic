<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>종합 금융 시뮬레이션 - 프리미엄</title>
  <!-- 필요한 라이브러리 로드 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.3.0/luxon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-luxon/1.3.1/chartjs-adapter-luxon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.0/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary-color: #1565c0;
      --primary-light: #e3f2fd;
      --primary-dark: #0d47a1;
      --success-color: #00b894;
      --danger-color: #d63031;
      --warning-color: #fdcb6e;
      --info-color: #0984e3;
      --background-light: #f8f9fa;
      --background-dark: #2d3436;
      --text-light: #f5f5f5;
      --text-dark: #2d3436;
      --border-color: #dfe6e9;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.15);
      --transition: all 0.3s ease;
      --korea-up: #d63031; /* Korean markets show increase in red */
      --korea-down: #0984e3; /* Korean markets show decrease in blue */
      --card-background: #ffffff;
      --modal-overlay: rgba(0, 0, 0, 0.6);
    }

    .dark-mode {
      --primary-color: #3498db;
      --primary-light: #2c3e50;
      --primary-dark: #2980b9;
      --background-light: #1e272e;
      --background-dark: #0c1419;
      --text-light: #ecf0f1;
      --text-dark: #bdc3c7;
      --border-color: #34495e;
      --card-background: #2c3e50;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: var(--background-light);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: var(--transition);
    }

    /* 헤더 스타일 */
    header {
      background: var(--primary-color);
      color: var(--text-light);
      padding: 0.8rem 1rem;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 10;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .logo {
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
    }

    .logo i {
      margin-right: 8px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .theme-toggle {
      cursor: pointer;
      background: none;
      border: none;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .save-load-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .header-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: var(--text-light);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: var(--transition);
    }

    .header-button i {
      margin-right: 4px;
      font-size: 1.1rem;
    }

    .header-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .header-stats {
      display: flex;
      gap: 1.5rem;
      margin-left: auto;
      margin-right: 1.5rem;
    }

    .header-stat {
      text-align: right;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      transition: var(--transition);
    }

    .header-stat:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .header-stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .header-stat-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* 뉴스 티커 스타일 */
    .news-ticker-container {
      background: var(--primary-dark);
      color: var(--text-light);
      padding: 0.6rem 0;
      overflow: hidden;
      position: relative;
      white-space: nowrap;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .news-ticker {
      display: inline-block;
      padding-left: 100%;
      animation: news-ticker-animation 35s linear infinite;
      font-size: 0.95rem;
    }

    @keyframes news-ticker-animation {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-100%, 0, 0); }
    }

    .news-ticker:hover {
      animation-play-state: paused;
    }

    .news-ticker-item {
      display: inline-block;
      margin-right: 3rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      transition: var(--transition);
      cursor: pointer;
    }

    .news-ticker-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .news-ticker-item i {
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    .news-ticker-item.positive {
      color: #a5d6a7;
    }

    .news-ticker-item.negative {
      color: #ef9a9a;
    }

    .news-ticker-time {
      font-size: 0.8rem;
      margin-left: 0.5rem;
      opacity: 0.8;
    }

    /* 메인 컨테이너 */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* 메인 내비게이션 */
    .main-nav {
      background: var(--primary-color);
      width: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
      box-shadow: var(--shadow);
      z-index: 5;
    }

    .nav-item {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      padding: 0.8rem 0;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.2);
    }

    .nav-item i {
      font-size: 1.6rem;
      margin-bottom: 0.3rem;
    }

    .nav-label {
      font-size: 0.7rem;
      text-align: center;
    }

    .badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 사이드바 스타일 */
    .sidebar {
      width: 320px;
      height: 100%;
      background: var(--card-background);
      box-shadow: var(--shadow);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: var(--transition);
      z-index: 4;
    }

    .sidebar-tabs {
      display: flex;
      background: var(--primary-light);
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-tab {
      flex: 1;
      padding: 0.8rem;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
    }

    .sidebar-tab.active {
      background: var(--card-background);
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }

    .sidebar-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.5);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 포트폴리오 스타일 */
    .portfolio-summary {
      background: var(--primary-light);
      border-radius: 8px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    .portfolio-balance {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .portfolio-description {
      color: var(--text-dark);
      opacity: 0.8;
      font-size: 0.9rem;
    }

    .portfolio-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .portfolio-stat {
      flex: 1;
      min-width: calc(50% - 0.5rem);
      text-align: center;
      background: var(--card-background);
      border-radius: 8px;
      padding: 0.8rem;
      box-shadow: var(--shadow);
    }

    .portfolio-stat-value {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .portfolio-stat-label {
      font-size: 0.8rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .section-title {
      font-size: 1.2rem;
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title-actions {
      display: flex;
      gap: 0.5rem;
    }

    .section-title-action {
      cursor: pointer;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .empty-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-dark);
      opacity: 0.7;
      font-style: italic;
    }

    .holding-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.8rem;
      background: var(--card-background);
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
    }

    .holding-item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .holding-info {
      flex: 1;
    }

    .holding-name {
      font-weight: 600;
    }

    .holding-symbol {
      font-size: 0.8rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .holding-stats {
      text-align: right;
    }

    .holding-shares {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .holding-value {
      font-weight: 600;
    }

    .price-change {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .price-change.positive {
      color: var(--korea-up);
    }

    .price-change.negative {
      color: var(--korea-down);
    }

    .price-change i {
      margin-right: 4px;
      font-size: 1rem;
    }

    /* 주식 테이블 스타일 */
    .stock-table-container {
      position: relative;
      overflow: hidden;
    }

    .stock-filter {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .stock-filter-input {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
      background: var(--card-background);
      color: var(--text-dark);
    }

    .stock-filter-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .stock-filter-select {
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
      background: var(--card-background);
      color: var(--text-dark);
    }

    .stock-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 0.5rem;
    }

    .stock-table th {
      padding: 0.8rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-dark);
      opacity: 0.8;
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 0;
      background: var(--card-background);
      z-index: 1;
      cursor: pointer;
    }

    .stock-table th:hover {
      color: var(--primary-color);
    }

    .stock-table th i {
      vertical-align: middle;
      font-size: 1rem;
      margin-left: 0.2rem;
    }

    .stock-table tbody tr {
      background: var(--card-background);
      box-shadow: var(--shadow);
      border-radius: 8px;
      transition: var(--transition);
    }

    .stock-table tbody tr:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      cursor: pointer;
    }

    .stock-table td {
      padding: 1rem 0.8rem;
    }

    .stock-table td:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .stock-table td:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .stock-name {
      font-weight: 600;
    }

    .stock-symbol {
      font-size: 0.8rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .stock-price {
      font-weight: 600;
      text-align: right;
    }

    .stock-change {
      text-align: right;
      font-weight: 600;
    }

    .stock-change.positive {
      color: var(--korea-up);
    }

    .stock-change.negative {
      color: var(--korea-down);
    }

    /* 부동산 탭 스타일 */
    .real-estate-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .property-card {
      background: var(--card-background);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      cursor: pointer;
    }

    .property-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .property-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .property-badge {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .property-badge.owned {
      background: var(--success-color);
      color: white;
    }

    .property-badge.premium {
      background: var(--warning-color);
      color: var(--text-dark);
    }

    .property-name {
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
    }

    .property-location {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.7;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }

    .property-location i {
      margin-right: 0.3rem;
      font-size: 1rem;
    }

    .property-details {
      display: flex;
      margin: 0.8rem 0;
      gap: 1rem;
    }

    .property-detail {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .property-detail i {
      margin-right: 0.3rem;
      opacity: 0.7;
    }

    .property-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 0.8rem;
      border-top: 1px solid var(--border-color);
      padding-top: 0.8rem;
    }

    .property-price {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .property-income {
      color: var(--success-color);
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
    }

    .property-income i {
      margin-right: 0.3rem;
    }

    /* 대출 탭 스타일 */
    .loan-summary {
      background: var(--primary-light);
      border-radius: 8px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    .loan-total {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--danger-color);
    }

    .loan-warning {
      display: flex;
      align-items: center;
      color: var(--danger-color);
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .loan-warning i {
      margin-right: 0.5rem;
    }

    .loan-progress {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 0.8rem 0;
      overflow: hidden;
    }

    .loan-progress-bar {
      height: 100%;
      background: var(--danger-color);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .loan-safe {
      background: var(--success-color);
    }

    .loan-warn {
      background: var(--warning-color);
    }

    .loan-danger {
      background: var(--danger-color);
    }

    .loan-stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .loan-stat {
      flex: 1;
      background: var(--card-background);
      padding: 0.8rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .loan-stat-value {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .loan-stat-label {
      font-size: 0.8rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .loan-products {
      margin-top: 1.5rem;
    }

    .loan-product {
      background: var(--card-background);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
    }

    .loan-product:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .loan-product-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .loan-product-name {
      font-weight: 600;
    }

    .loan-product-rate {
      color: var(--danger-color);
      font-weight: 600;
    }

    .loan-product-description {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.8;
      margin-bottom: 0.8rem;
    }

    .loan-product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .loan-product-terms {
      font-size: 0.9rem;
    }

    .loan-product-action {
      padding: 0.4rem 0.8rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .loan-product-action:hover {
      background: var(--primary-dark);
    }

    .active-loans {
      margin-top: 1.5rem;
    }

    .loan-item {
      background: var(--card-background);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }

    .loan-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .loan-item-name {
      font-weight: 600;
    }

    .loan-item-amount {
      font-weight: 600;
    }

    .loan-item-details {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.8;
      margin-bottom: 0.8rem;
    }

    .loan-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .loan-item-payment {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }

    .loan-item-next {
      color: var(--danger-color);
      margin-left: 0.5rem;
    }

    .loan-item-action {
      padding: 0.4rem 0.8rem;
      background: var(--success-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .loan-item-action:hover {
      background: #009b7d;
    }

    /* 메인 콘텐츠 영역 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      overflow-y: auto;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }

    .stock-header {
      display: flex;
      flex-direction: column;
    }

    .stock-title {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      margin-bottom: 0.3rem;
    }

    .stock-subtitle {
      color: var(--text-dark);
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stock-subtitle-item {
      display: flex;
      align-items: center;
    }

    .stock-subtitle-item i {
      margin-right: 0.4rem;
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .current-price-container {
      text-align: right;
    }

    .current-price {
      font-size: 2rem;
      font-weight: 700;
    }

    .price-change-container {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.8rem;
      margin-top: 0.3rem;
    }

    /* 차트 컨테이너 */
    .chart-container {
      flex: 1;
      min-height: 400px;
      background: var(--card-background);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .chart-controls {
      display: flex;
      align-items: center;
    }

    .chart-periods {
      display: flex;
      gap: 0.3rem;
      margin-right: 1rem;
    }

    .chart-period {
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: var(--transition);
      background: var(--background-light);
    }

    .chart-period.active {
      background: var(--primary-color);
      color: white;
    }

    .chart-types {
      display: flex;
      gap: 0.3rem;
      margin-right: 1rem;
    }

    .chart-type {
      padding: 0.4rem;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
      background: var(--background-light);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-type.active {
      background: var(--primary-color);
      color: white;
    }

    .chart-indicators {
      display: flex;
      gap: 0.3rem;
    }

    .chart-indicator {
      padding: 0.4rem;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
      background: var(--background-light);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-indicator.active {
      background: var(--primary-color);
      color: white;
    }

    .chart-wrapper {
      width: 100%;
      height: 350px;
      position: relative;
    }

    /* 거래 패널 */
    .trade-panel {
      background: var(--card-background);
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
    }

    .trade-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      background: var(--background-light);
    }

    .trade-tab {
      flex: 1;
      text-align: center;
      padding: 0.8rem;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .trade-tab.buy.active {
      background: var(--korea-up);
      color: white;
    }

    .trade-tab.sell.active {
      background: var(--korea-down);
      color: white;
    }

    .trade-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-row {
      display: flex;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    .form-label {
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }

    .form-label i {
      margin-right: 0.4rem;
      opacity: 0.7;
    }

    .form-input {
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--card-background);
      color: var(--text-dark);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
    }

    .form-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--border-color);
      outline: none;
      margin-top: 0.5rem;
    }

    .form-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      transition: var(--transition);
    }

    .form-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .trade-summary {
      background: var(--background-light);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .summary-row.total {
      font-weight: 700;
      padding-top: 0.5rem;
      margin-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }

    .trade-button {
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
    }

    .trade-button.buy {
      background: var(--korea-up);
      color: white;
    }

    .trade-button.buy:hover {
      filter: brightness(1.1);
    }

    .trade-button.sell {
      background: var(--korea-down);
      color: white;
    }

    .trade-button.sell:hover {
      filter: brightness(1.1);
    }

    /* 차트 정보 표시 */
    .chart-info {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }

    .chart-data-group {
      display: flex;
      gap: 2rem;
    }

    .chart-data {
      min-width: 120px;
    }

    .chart-data-label {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.7;
      margin-bottom: 0.3rem;
    }

    .chart-data-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* 모달 스타일 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--card-background);
      border-radius: 8px;
      box-shadow: var(--shadow-hover);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-dark);
      opacity: 0.7;
      transition: opacity 0.3s;
    }

    .modal-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    .modal-button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-button.secondary {
      background: var(--background-light);
      color: var(--text-dark);
    }

    .modal-button.secondary:hover {
      background: var(--border-color);
    }

    .modal-button.primary {
      background: var(--primary-color);
      color: white;
    }

    .modal-button.primary:hover {
      background: var(--primary-dark);
    }

    .modal-button.danger {
      background: var(--danger-color);
      color: white;
    }

    .modal-button.danger:hover {
      background: #c0392b;
    }

    /* 프로퍼티 상세 모달 */
    .property-details-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .property-detail-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .property-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .property-detail-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .property-detail-price {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .property-detail-location {
      display: flex;
      align-items: center;
      color: var(--text-dark);
      opacity: 0.8;
    }

    .property-detail-location i {
      margin-right: 0.5rem;
    }

    .property-specs {
      display: flex;
      gap: 1.5rem;
      margin: 1rem 0;
    }

    .property-spec {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .property-spec-value {
      font-weight: 600;
      font-size: 1.2rem;
    }

    .property-spec-label {
      font-size: 0.9rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .property-description {
      line-height: 1.7;
    }

    .property-financials {
      background: var(--background-light);
      padding: 1rem;
      border-radius: 8px;
    }

    .financial-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .financial-item:last-child {
      margin-bottom: 0;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
      font-weight: 600;
    }

    /* 뉴스 모달 */
    .news-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .news-date {
      color: var(--text-dark);
      opacity: 0.7;
      font-size: 0.9rem;
    }

    .news-impact {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .news-impact.positive {
      background: rgba(0, 184, 148, 0.2);
      color: var(--success-color);
    }

    .news-impact.negative {
      background: rgba(214, 48, 49, 0.2);
      color: var(--danger-color);
    }

    .news-impact.neutral {
      background: rgba(9, 132, 227, 0.2);
      color: var(--info-color);
    }

    .news-body {
      line-height: 1.7;
    }

    .affected-stocks {
      margin-top: 1rem;
    }

    .affected-stock {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      background: var(--background-light);
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .affected-stock-name {
      font-weight: 600;
    }

    .affected-stock-impact {
      font-weight: 600;
    }

    .affected-stock-impact.positive {
      color: var(--korea-up);
    }

    .affected-stock-impact.negative {
      color: var(--korea-down);
    }

    /* 대출 신청 모달 */
    .loan-application {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .loan-application-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1rem;
    }

    .loan-application-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .loan-application-subtitle {
      color: var(--text-dark);
      opacity: 0.8;
    }

    .loan-application-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .loan-slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: var(--text-dark);
      opacity: 0.7;
    }

    .loan-calculation {
      background: var(--background-light);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .loan-calculation-title {
      font-weight: 600;
      margin-bottom: 0.8rem;
    }

    .loan-term-options {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .loan-term-option {
      flex: 1;
      padding: 0.8rem;
      border-radius: 4px;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .loan-term-option.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* 매수/매도 확인 모달 */
    .order-confirmation {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .order-type {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .order-type.buy {
      background: rgba(214, 48, 49, 0.2);
      color: var(--korea-up);
    }

    .order-type.sell {
      background: rgba(9, 132, 227, 0.2);
      color: var(--korea-down);
    }

    .order-details {
      background: var(--background-light);
      padding: 1rem;
      border-radius: 8px;
    }

    /* 알림 스타일 */
    .notification-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      pointer-events: none;
    }

    .notification {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      background: var(--card-background);
      color: var(--text-dark);
      box-shadow: var(--shadow-hover);
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 400px;
      transform: translateX(120%);
      animation: slide-in 0.3s forwards, fade-out 0.3s 2.7s forwards;
      pointer-events: auto;
    }

    @keyframes slide-in {
      to { transform: translateX(0); }
    }

    @keyframes fade-out {
      to { opacity: 0; }
    }

    .notification i {
      margin-right: 0.8rem;
      font-size: 1.5rem;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .notification-message {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .notification.success {
      border-left: 4px solid var(--success-color);
    }

    .notification.success i {
      color: var(--success-color);
    }

    .notification.error {
      border-left: 4px solid var(--danger-color);
    }

    .notification.error i {
      color: var(--danger-color);
    }

    .notification.info {
      border-left: 4px solid var(--info-color);
    }

    .notification.info i {
      color: var(--info-color);
    }

    .notification.warning {
      border-left: 4px solid var(--warning-color);
    }

    .notification.warning i {
      color: var(--warning-color);
    }

    /* 로더 스타일 */
    .loader {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .loader-spinner {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-light);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loader-text {
      margin-top: 1rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 반응형 디자인 */
    @media (max-width: 1200px) {
      .header-stat {
        display: none;
      }
      
      .header-stat:first-child {
        display: block;
      }
    }

    @media (max-width: 1024px) {
      .main-container {
        flex-direction: column;
      }

      .main-nav {
        width: 100%;
        height: 60px;
        flex-direction: row;
        justify-content: center;
      }

      .nav-item {
        flex-direction: row;
        padding: 0 1rem;
      }

      .nav-item i {
        margin-right: 0.5rem;
        margin-bottom: 0;
      }

      .badge {
        top: 0.2rem;
        right: 0.2rem;
      }

      .sidebar {
        width: 100%;
        max-height: 400px;
      }

      .chart-container {
        min-height: 300px;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .header-stats {
        margin-left: 0;
        width: 100%;
        justify-content: space-around;
      }

      .content-header {
        flex-direction: column;
        gap: 1rem;
      }

      .current-price-container {
        text-align: left;
      }

      .price-change-container {
        justify-content: flex-start;
      }

      .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .chart-controls {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .chart-periods {
        margin-right: 0;
      }

      .chart-types {
        margin-right: 0;
      }

      .chart-info {
        flex-direction: column;
        gap: 1rem;
      }

      .chart-data-group {
        justify-content: space-between;
      }

      .form-row {
        flex-direction: column;
      }

      .property-specs {
        flex-wrap: wrap;
        gap: 1rem;
      }
    }

    /* 아이콘 */
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="material-icons">trending_up</i>
        종합 금융 시뮬레이션
      </div>
      <div class="header-stats">
        <div class="header-stat" id="kospi-container">
          <div class="header-stat-label">KOSPI</div>
          <div class="header-stat-value" id="kospi-index">2,862.86 <span class="price-change positive">+0.75%</span></div>
        </div>
        <div class="header-stat" id="kosdaq-container">
          <div class="header-stat-label">KOSDAQ</div>
          <div class="header-stat-value" id="kosdaq-index">946.78 <span class="price-change negative">-0.32%</span></div>
        </div>
        <div class="header-stat" id="usd-krw-container">
          <div class="header-stat-label">USD/KRW</div>
          <div class="header-stat-value" id="usd-krw">1,356.20 <span class="price-change positive">+0.15%</span></div>
        </div>
      </div>
      <div class="header-actions">
        <div class="save-load-buttons">
          <button class="header-button" id="saveButton">
            <i class="material-icons">save</i>
            저장
          </button>
          <button class="header-button" id="loadButton">
            <i class="material-icons">file_upload</i>
            불러오기
          </button>
        </div>
        <button class="theme-toggle" id="themeToggle">
          <i class="material-icons">brightness_4</i>
        </button>
      </div>
    </div>
  </header>

  <div class="news-ticker-container">
    <div class="news-ticker" id="newsTicker">
      <!-- 뉴스 항목들은 자바스크립트로 동적 생성됩니다 -->
    </div>
  </div>

  <div class="main-container">
    <nav class="main-nav">
      <div class="nav-item active" data-tab="stock">
        <i class="material-icons">candlestick_chart</i>
        <span class="nav-label">주식</span>
      </div>
      <div class="nav-item" data-tab="realestate">
        <i class="material-icons">apartment</i>
        <span class="nav-label">부동산</span>
      </div>
      <div class="nav-item" data-tab="loans">
        <i class="material-icons">account_balance</i>
        <span class="nav-label">대출</span>
        <span class="badge" id="loanAlert" style="display: none;">!</span>
      </div>
      <div class="nav-item" data-tab="news">
        <i class="material-icons">feed</i>
        <span class="nav-label">뉴스</span>
        <span class="badge" id="newsAlert" style="display: none;">N</span>
      </div>
    </nav>

    <div class="sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-tab="portfolio">포트폴리오</div>
        <div class="sidebar-tab" data-tab="market">시장 동향</div>
      </div>

      <div class="sidebar-content">
        <div class="tab-content active" id="portfolio-tab">
          <div class="portfolio-summary">
            <div class="portfolio-balance" id="totalBalance">₩1,000,000</div>
            <div class="portfolio-description" id="totalValue">총 자산 평가액</div>
            <div class="portfolio-stats">
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" id="cashBalance">₩1,000,000</div>
                <div class="portfolio-stat-label">보유 현금</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" id="stocksValue">₩0</div>
                <div class="portfolio-stat-label">주식 평가액</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" id="realEstateValue">₩0</div>
                <div class="portfolio-stat-label">부동산 평가액</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" id="passiveIncome">₩0 / 일</div>
                <div class="portfolio-stat-label">수동 수입</div>
              </div>
            </div>
          </div>

          <h2 class="section-title">
            보유 주식
            <div class="section-title-actions">
              <i class="material-icons section-title-action" id="portfolioSort" title="정렬">sort</i>
            </div>
          </h2>
          <div id="holdingsList">
            <div class="empty-message">
              보유 중인 주식이 없습니다.<br>
              시장에서 주식을 구매해보세요.
            </div>
          </div>

          <h2 class="section-title">
            보유 부동산
          </h2>
          <div id="propertiesList">
            <div class="empty-message">
              보유 중인 부동산이 없습니다.<br>
              부동산 탭에서 자산을 구매해보세요.
            </div>
          </div>
        </div>

        <div class="tab-content" id="market-tab">
          <div class="stock-filter">
            <input type="text" class="stock-filter-input" id="stockSearch" placeholder="종목명 또는 코드 검색...">
            <select class="stock-filter-select" id="sectorFilter">
              <option value="all">전체 섹터</option>
              <!-- 섹터 옵션은 자바스크립트로 동적 생성됩니다 -->
            </select>
          </div>
          <div class="stock-table-container">
            <table class="stock-table" id="stocksTable">
              <thead>
                <tr>
                  <th data-sort="name">종목명 <i class="material-icons">unfold_more</i></th>
                  <th data-sort="price">현재가 <i class="material-icons">unfold_more</i></th>
                  <th data-sort="change">변동률 <i class="material-icons">unfold_more</i></th>
                </tr>
              </thead>
              <tbody>
                <!-- 주식 목록은 자바스크립트로 동적 생성됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content" id="stockContent">
      <div class="content-header">
        <div class="stock-header">
          <div class="stock-title" id="selectedStockName">종목을 선택하세요</div>
          <div class="stock-subtitle">
            <span id="selectedStockSymbol"></span>
            <span class="stock-subtitle-item" id="selectedStockSector">
              <i class="material-icons">category</i>
              <span></span>
            </span>
          </div>
        </div>
        <div class="current-price-container">
          <div class="current-price" id="currentPrice">-</div>
          <div class="price-change-container">
            <div class="price-change" id="priceChange"></div>
            <div class="price-change" id="priceDayRange"></div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">가격 차트</div>
          <div class="chart-controls">
            <div class="chart-periods">
              <div class="chart-period active" data-period="day">1일</div>
              <div class="chart-period" data-period="week">1주</div>
              <div class="chart-period" data-period="month">1개월</div>
              <div class="chart-period" data-period="year">1년</div>
            </div>
            <div class="chart-types">
              <div class="chart-type active" data-type="line" title="라인 차트">
                <i class="material-icons">show_chart</i>
              </div>
              <div class="chart-type" data-type="candlestick" title="캔들스틱 차트">
                <i class="material-icons">candlestick_chart</i>
              </div>
            </div>
            <div class="chart-indicators">
              <div class="chart-indicator" data-indicator="volume" title="거래량">
                <i class="material-icons">bar_chart</i>
              </div>
              <div class="chart-indicator" data-indicator="ma" title="이동평균선">
                <i class="material-icons">timeline</i>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="stockChart"></canvas>
        </div>
        <div class="chart-info">
          <div class="chart-data-group">
            <div class="chart-data">
              <div class="chart-data-label">시가</div>
              <div class="chart-data-value" id="stockOpen">-</div>
            </div>
            <div class="chart-data">
              <div class="chart-data-label">고가</div>
              <div class="chart-data-value" id="stockHigh">-</div>
            </div>
            <div class="chart-data">
              <div class="chart-data-label">저가</div>
              <div class="chart-data-value" id="stockLow">-</div>
            </div>
          </div>
          <div class="chart-data-group">
            <div class="chart-data">
              <div class="chart-data-label">거래량</div>
              <div class="chart-data-value" id="stockVolume">-</div>
            </div>
            <div class="chart-data">
              <div class="chart-data-label">52주 최고</div>
              <div class="chart-data-value" id="stock52High">-</div>
            </div>
            <div class="chart-data">
              <div class="chart-data-label">52주 최저</div>
              <div class="chart-data-value" id="stock52Low">-</div>
            </div>
          </div>
        </div>
      </div>

      <div class="trade-panel">
        <div class="trade-tabs">
          <div class="trade-tab buy active" data-trade="buy">매수</div>
          <div class="trade-tab sell" data-trade="sell">매도</div>
        </div>

        <div class="trade-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">
                <i class="material-icons">payments</i>
                주문 가격
              </label>
              <input type="text" class="form-input" id="tradePrice" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">
                <i class="material-icons">swap_vert</i>
                주문 수량
              </label>
              <input type="number" class="form-input" id="tradeQuantity" placeholder="수량 입력" min="1" value="1">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">매수 가능 수량: <span id="maxBuyable">0</span>주</label>
            <input type="range" class="form-slider" id="quantitySlider" min="0" max="100" value="1">
          </div>

          <div class="trade-summary" id="tradeSummary">
            <div class="summary-row">
              <div>주문 가격:</div>
              <div id="orderPrice">-</div>
            </div>
            <div class="summary-row">
              <div>주문 수량:</div>
              <div id="orderQuantity">-</div>
            </div>
            <div class="summary-row">
              <div>수수료 (0.15%):</div>
              <div id="orderFee">-</div>
            </div>
            <div class="summary-row total">
              <div>총 금액:</div>
              <div id="orderTotal">-</div>
            </div>
          </div>

          <button class="trade-button buy" id="tradeButton">매수 주문</button>
        </div>
      </div>
    </div>

    <div class="main-content" id="realEstateContent" style="display: none;">
      <div class="content-header">
        <div class="stock-header">
          <div class="stock-title">부동산 투자</div>
          <div class="stock-subtitle">부동산에 투자하여 안정적인 수동 수입을 창출하세요.</div>
        </div>
      </div>

      <div class="real-estate-list" id="realEstateList">
        <!-- 부동산 목록은 자바스크립트로 동적 생성됩니다 -->
      </div>
    </div>

    <div class="main-content" id="loansContent" style="display: none;">
      <div class="content-header">
        <div class="stock-header">
          <div class="stock-title">금융 대출</div>
          <div class="stock-subtitle">자금이 필요할 때 다양한 대출 상품을 이용하세요.</div>
        </div>
      </div>

      <div class="loan-summary">
        <div class="loan-total" id="totalDebt">₩0</div>
        <div class="portfolio-description">총 부채</div>
        
        <div class="loan-progress" id="debtProgressBar">
          <div class="loan-progress-bar loan-safe" style="width: 0%"></div>
        </div>
        
        <div class="loan-warning" id="loanWarning" style="display: none;">
          <i class="material-icons">warning</i>
          <span>대출금 상환에 주의하세요. 100만원 초과 시 파산합니다.</span>
        </div>
        
        <div class="loan-stats">
          <div class="loan-stat">
            <div class="loan-stat-value" id="totalMonthlyPayment">₩0</div>
            <div class="loan-stat-label">월 상환액</div>
          </div>
          <div class="loan-stat">
            <div class="loan-stat-value" id="nextPaymentDate">-</div>
            <div class="loan-stat-label">다음 상환일</div>
          </div>
          <div class="loan-stat">
            <div class="loan-stat-value" id="loanLimit">₩1,000,000</div>
            <div class="loan-stat-label">최대 대출 한도</div>
          </div>
        </div>
      </div>

      <h2 class="section-title">대출 상품</h2>
      <div class="loan-products" id="loanProducts">
        <!-- 대출 상품 목록은 자바스크립트로 동적 생성됩니다 -->
      </div>

      <h2 class="section-title">진행 중인 대출</h2>
      <div class="active-loans" id="activeLoans">
        <div class="empty-message">
          진행 중인 대출이 없습니다.
        </div>
      </div>
    </div>

    <div class="main-content" id="newsContent" style="display: none;">
      <div class="content-header">
        <div class="stock-header">
          <div class="stock-title">금융 뉴스</div>
          <div class="stock-subtitle">시장에 영향을 미치는 최신 뉴스를 확인하세요.</div>
        </div>
      </div>

      <div class="stock-filter">
        <input type="text" class="stock-filter-input" id="newsSearch" placeholder="뉴스 검색...">
        <select class="stock-filter-select" id="newsFilter">
          <option value="all">전체 뉴스</option>
          <option value="positive">호재 뉴스</option>
          <option value="negative">악재 뉴스</option>
          <option value="sector">산업 뉴스</option>
          <option value="global">글로벌 뉴스</option>
        </select>
      </div>

      <div id="newsList">
        <!-- 뉴스 목록은 자바스크립트로 동적 생성됩니다 -->
      </div>
    </div>
  </div>

  <!-- 모달: 부동산 상세 -->
  <div class="modal-overlay" id="propertyModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">부동산 상세 정보</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="property-details-container">
          <div class="property-detail-info">
            <div class="property-detail-header">
              <div class="property-detail-title" id="propertyDetailName"></div>
              <div class="property-detail-price" id="propertyDetailPrice"></div>
            </div>
            <div class="property-detail-location" id="propertyDetailLocation">
              <i class="material-icons">location_on</i>
              <span></span>
            </div>
            <div class="property-specs">
              <div class="property-spec">
                <div class="property-spec-value" id="propertySize"></div>
                <div class="property-spec-label">면적</div>
              </div>
              <div class="property-spec">
                <div class="property-spec-value" id="propertyType"></div>
                <div class="property-spec-label">유형</div>
              </div>
              <div class="property-spec">
                <div class="property-spec-value" id="propertyYear"></div>
                <div class="property-spec-label">건축년도</div>
              </div>
            </div>
            <div class="property-description" id="propertyDescription"></div>
            <div class="property-financials">
              <div class="financial-item">
                <div>매입가:</div>
                <div id="propertyPurchasePrice"></div>
              </div>
              <div class="financial-item">
                <div>세금 및 수수료 (2.5%):</div>
                <div id="propertyTaxFees"></div>
              </div>
              <div class="financial-item">
                <div>예상 월세 수입:</div>
                <div id="propertyRentalIncome"></div>
              </div>
              <div class="financial-item">
                <div>월 관리비:</div>
                <div id="propertyMaintenanceFee"></div>
              </div>
              <div class="financial-item">
                <div>순 월 수입:</div>
                <div id="propertyNetIncome"></div>
              </div>
              <div class="financial-item">
                <div>연 수익률:</div>
                <div id="propertyROI"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="propertyCloseButton">닫기</button>
        <button class="modal-button primary" id="propertyBuyButton">매입하기</button>
      </div>
    </div>
  </div>

  <!-- 모달: 뉴스 상세 -->
  <div class="modal-overlay" id="newsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="newsTitle">뉴스 제목</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="news-content">
          <div class="news-date" id="newsDate"></div>
          <div class="news-impact" id="newsImpact"></div>
          <div class="news-body" id="newsBody"></div>
          
          <h3 class="section-title">영향 받는 종목</h3>
          <div class="affected-stocks" id="affectedStocks">
            <!-- 영향 받는 종목 목록은 자바스크립트로 동적 생성됩니다 -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="newsCloseButton">닫기</button>
      </div>
    </div>
  </div>

  <!-- 모달: 대출 신청 -->
  <div class="modal-overlay" id="loanModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="loanTitle">대출 신청</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="loan-application">
          <div class="loan-application-header">
            <div class="loan-application-title" id="loanProductName"></div>
            <div class="loan-application-subtitle" id="loanProductDescription"></div>
          </div>
          
          <div class="loan-application-form">
            <div class="form-group">
              <label class="form-label">대출 금액</label>
              <input type="text" class="form-input" id="loanAmount" placeholder="0">
              <input type="range" class="form-slider" id="loanAmountSlider" min="0" max="100" value="0">
              <div class="loan-slider-labels">
                <span id="minLoanAmount">₩0</span>
                <span id="maxLoanAmount">₩0</span>
              </div>
            </div>
            
            <div class="loan-term-options" id="loanTermOptions">
              <div class="loan-term-option" data-term="6">6개월</div>
              <div class="loan-term-option" data-term="12">12개월</div>
              <div class="loan-term-option active" data-term="24">24개월</div>
              <div class="loan-term-option" data-term="36">36개월</div>
            </div>
            
            <div class="loan-calculation">
              <div class="loan-calculation-title">대출 계산</div>
              <div class="summary-row">
                <div>대출 금액:</div>
                <div id="loanSummaryAmount">₩0</div>
              </div>
              <div class="summary-row">
                <div>대출 기간:</div>
                <div id="loanSummaryTerm">24개월</div>
              </div>
              <div class="summary-row">
                <div>금리:</div>
                <div id="loanSummaryRate">0.0%</div>
              </div>
              <div class="summary-row">
                <div>총 이자:</div>
                <div id="loanSummaryInterest">₩0</div>
              </div>
              <div class="summary-row">
                <div>월 상환액:</div>
                <div id="loanSummaryMonthly">₩0</div>
              </div>
              <div class="summary-row total">
                <div>총 상환액:</div>
                <div id="loanSummaryTotal">₩0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="loanCloseButton">취소</button>
        <button class="modal-button primary" id="loanApplyButton">대출 신청</button>
      </div>
    </div>
  </div>

  <!-- 모달: 대출 상환 -->
  <div class="modal-overlay" id="repayModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">대출 상환</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="loan-application">
          <div class="loan-application-header">
            <div class="loan-application-title" id="repayLoanName"></div>
            <div class="loan-application-subtitle">남은 대출금을 상환합니다.</div>
          </div>
          
          <div class="loan-calculation">
            <div class="summary-row">
              <div>남은 원금:</div>
              <div id="repayRemainingPrincipal">₩0</div>
            </div>
            <div class="summary-row">
              <div>남은 이자:</div>
              <div id="repayRemainingInterest">₩0</div>
            </div>
            <div class="summary-row">
              <div>조기 상환 수수료:</div>
              <div id="repayEarlyFee">₩0</div>
            </div>
            <div class="summary-row total">
              <div>총 상환액:</div>
              <div id="repayTotal">₩0</div>
            </div>
          </div>
          
          <div class="loan-warning" id="repayWarning" style="margin-top: 1rem; display: none;">
            <i class="material-icons">warning</i>
            <span>현재 보유 현금으로 전액 상환할 수 없습니다.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="repayCloseButton">취소</button>
        <button class="modal-button primary" id="repayButton">상환하기</button>
      </div>
    </div>
  </div>

  <!-- 모달: 거래 확인 -->
  <div class="modal-overlay" id="orderModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">주문 확인</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="order-confirmation">
          <div class="order-type buy" id="orderType">매수 주문</div>
          <div id="orderStockName" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;"></div>
          
          <div class="order-details">
            <div class="summary-row">
              <div>주문 가격:</div>
              <div id="confirmOrderPrice">-</div>
            </div>
            <div class="summary-row">
              <div>주문 수량:</div>
              <div id="confirmOrderQuantity">-</div>
            </div>
            <div class="summary-row">
              <div>수수료 (0.15%):</div>
              <div id="confirmOrderFee">-</div>
            </div>
            <div class="summary-row total">
              <div>총 금액:</div>
              <div id="confirmOrderTotal">-</div>
            </div>
          </div>
          
          <div class="loan-warning" style="margin-top: 1rem;">
            <i class="material-icons">info</i>
            <span>주문 체결 후에는 취소할 수 없습니다.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="orderCancelButton">취소</button>
        <button class="modal-button primary" id="orderConfirmButton">확인</button>
      </div>
    </div>
  </div>

  <!-- 모달: 저장 및 불러오기 -->
  <div class="modal-overlay" id="saveLoadModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="saveLoadTitle">시뮬레이션 저장</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="saveContent">
          <p style="margin-bottom: 1rem;">현재 시뮬레이션 상태를 JSON 파일로 저장합니다.</p>
          <div class="form-group">
            <label class="form-label">파일명</label>
            <input type="text" class="form-input" id="saveFileName" value="financial_simulation.json">
          </div>
          <div class="loan-calculation" style="margin-top: 1rem;">
            <div class="summary-row">
              <div>총 자산:</div>
              <div id="saveTotalAssets">₩0</div>
            </div>
            <div class="summary-row">
              <div>보유 주식:</div>
              <div id="saveStockCount">0종목</div>
            </div>
            <div class="summary-row">
              <div>보유 부동산:</div>
              <div id="savePropertyCount">0건</div>
            </div>
            <div class="summary-row">
              <div>진행 중인 대출:</div>
              <div id="saveLoanCount">0건</div>
            </div>
          </div>
        </div>
        
        <div id="loadContent" style="display: none;">
          <p style="margin-bottom: 1rem;">저장된 시뮬레이션 파일을 불러옵니다.</p>
          <div class="form-group">
            <label class="form-label">JSON 파일 선택</label>
            <input type="file" id="loadFileInput" accept=".json">
          </div>
          <div id="loadFileInfo" style="margin-top: 1rem; display: none;">
            <div class="loan-calculation">
              <div class="summary-row">
                <div>저장 일자:</div>
                <div id="loadSaveDate">-</div>
              </div>
              <div class="summary-row">
                <div>총 자산:</div>
                <div id="loadTotalAssets">₩0</div>
              </div>
              <div class="summary-row">
                <div>보유 주식:</div>
                <div id="loadStockCount">0종목</div>
              </div>
              <div class="summary-row">
                <div>보유 부동산:</div>
                <div id="loadPropertyCount">0건</div>
              </div>
            </div>
          </div>
          <div class="loan-warning" id="loadWarning" style="margin-top: 1rem; display: none;">
            <i class="material-icons">warning</i>
            <span>현재 진행 중인 시뮬레이션이 모두 초기화됩니다. 계속하시겠습니까?</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button secondary" id="saveLoadCancelButton">취소</button>
        <button class="modal-button primary" id="saveButton">저장하기</button>
        <button class="modal-button primary" id="loadConfirmButton" style="display: none;">불러오기</button>
      </div>
    </div>
  </div>

  <!-- 모달: 파산 -->
  <div class="modal-overlay" id="bankruptcyModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">파산 선고</div>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center;">
          <i class="material-icons" style="font-size: 4rem; color: var(--danger-color); margin-bottom: 1rem;">gavel</i>
          <h2 style="margin-bottom: 1rem;">파산이 선고되었습니다</h2>
          <p style="margin-bottom: 2rem;">대출금 한도 ₩1,000,000을 초과하여 파산이 선고되었습니다.</p>
          <div style="font-weight: 600; margin-bottom: 0.5rem;">최종 재정 현황</div>
          <div class="loan-calculation" style="margin-bottom: 2rem;">
            <div class="summary-row">
              <div>총 자산:</div>
              <div id="bankruptcyTotalAssets">₩0</div>
            </div>
            <div class="summary-row">
              <div>총 부채:</div>
              <div id="bankruptcyTotalDebt">₩0</div>
            </div>
            <div class="summary-row total">
              <div>순자산:</div>
              <div id="bankruptcyNetWorth">₩0</div>
            </div>
          </div>
          <p>새로운 시뮬레이션을 시작하시겠습니까?</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-button danger" id="bankruptcyRestartButton">새로 시작하기</button>
      </div>
    </div>
  </div>

  <div class="notification-container" id="notificationContainer">
    <!-- 알림 메시지는 자바스크립트로 동적 생성됩니다 -->
  </div>

  <script>
    // ======================================================
    // 1. 주요 변수 및 상태 설정
    // ======================================================
    
    // 시뮬레이션 상태
    const simulation = {
      // 시뮬레이션 시간 관리
      currentDate: new Date(),
      daysPassed: 0,
      
      // 포트폴리오 상태
      portfolio: {
        cash: 1000000,  // 초기 현금 100만원
        holdings: {},   // 보유 주식 (예: { 'symbol': { quantity: 10, avgPrice: 50000 } })
        properties: {}, // 보유 부동산 (예: { 'id': { id: 'property1', purchasePrice: 500000000 } })
        loans: {},      // 대출 내역 (예: { 'id': { principal: 10000000, interest: 0.05, ... } })
        transactions: [], // 거래 내역
        lastUpdate: new Date()
      },
      
      // 시장 지수
      marketIndices: {
        kospi: { value: 2862.86, prevClose: 2841.28, change: 0.75 },
        kosdaq: { value: 946.78, prevClose: 949.81, change: -0.32 },
        usdkrw: { value: 1356.20, prevClose: 1354.17, change: 0.15 }
      },
      
      // 뉴스 관리
      news: {
        articles: [],     // 뉴스 기사 배열
        unread: 0,         // 읽지 않은 뉴스 수
        lastUpdate: new Date()
      },
      
      // 게임 설정
      settings: {
        taxRate: 0.0015,   // 거래 수수료 (0.15%)
        loanLimit: 1000000, // 대출 한도 (100만원)
        interestPenalty: 0.1, // 연체 이자 패널티 (10%)
        bankruptcyThreshold: 1000000, // 파산 기준액 (100만원)
        darkMode: false
      },
      
      // 게임 상태
      gameOver: false
    };
    
    // 차트 상태
    let selectedStock = null;  // 현재 선택된 주식
    let stockChart = null;     // 차트 객체
    let volumeChart = null;    // 거래량 차트 객체
    let chartType = 'line';    // 차트 타입 (캔들스틱 또는 라인)
    let chartPeriod = 'day';   // 차트 기간 (1일, 1주, 1개월, 1년)
    let activeIndicators = []; // 활성화된 지표
    
    // 거래 패널 상태
    let tradeType = 'buy';     // 거래 유형 (buy 또는 sell)
    
    // 현재 활성 콘텐츠
    let activeContent = 'stock'; // stock, realestate, loans, news
    
    // 선택된 부동산
    let selectedProperty = null;
    
    // 선택된 대출 상품
    let selectedLoan = null;
    
    // 선택된 뉴스
    let selectedNews = null;
    
    // 선택된 대출 상환
    let selectedRepayLoan = null;
    
    // 임시 로드 데이터
    let tempLoadData = null;
    
    // 시뮬레이션 설정
    const SIMULATION_INTERVAL = 1000;  // 시뮬레이션 간격 (1초)
    const MARKET_UPDATE_INTERVAL = 5000; // 시장 업데이트 간격 (5초)
    const NEWS_UPDATE_INTERVAL = 10000; // 뉴스 업데이트 간격 (10초)
    const DAY_CYCLE = 30000;   // 가상 1일 간격 (30초)
    const MAX_HISTORY = 500;          // 최대 기록 저장 개수
    const PRICE_VOLATILITY = 0.01;    // 가격 변동성 (1%)
    const NEWS_ITEMS_PER_UPDATE = 3;  // 한 번에 생성되는 뉴스 수
    
    // ======================================================
    // 2. 주식 데이터 정의
    // ======================================================
    
    // 대기업 리스트
    const largeCompanies = [
      { symbol: '005930', name: '삼성전자', sector: '전자', description: '한국 최대 전자기기 제조업체로 스마트폰, 반도체, TV 등을 생산' },
      { symbol: '000660', name: 'SK하이닉스', sector: '반도체', description: '세계적인 메모리 반도체 제조업체' },
      { symbol: '035420', name: 'NAVER', sector: 'IT 서비스', description: '한국 최대 인터넷 포털 서비스 기업' },
      { symbol: '051910', name: 'LG화학', sector: '화학', description: '배터리, 석유화학, 첨단소재를 생산하는 화학 기업' },
      { symbol: '005380', name: '현대자동차', sector: '자동차', description: '한국의 대표적인 자동차 제조사' },
      { symbol: '006400', name: '삼성SDI', sector: '전자부품', description: '2차전지, 전자재료 전문 제조업체' },
      { symbol: '012330', name: '현대모비스', sector: '자동차부품', description: '현대자동차그룹의 자동차 부품 제조업체' },
      { symbol: '035720', name: '카카오', sector: 'IT 서비스', description: '메신저, 모빌리티, 페이 등 다양한 인터넷 서비스 제공' },
      { symbol: '066570', name: 'LG전자', sector: '전자', description: '가전제품, 모바일, 사업용 제품을 제조하는 글로벌 기업' },
      { symbol: '005490', name: 'POSCO홀딩스', sector: '철강', description: '세계적인 철강 제조업체' },
      { symbol: '000270', name: '기아', sector: '자동차', description: '현대자동차그룹의 자동차 제조사' },
      { symbol: '055550', name: '신한지주', sector: '금융', description: '신한은행, 신한카드 등을 보유한 금융지주회사' },
      { symbol: '105560', name: 'KB금융', sector: '금융', description: '국민은행 등을 보유한 금융지주회사' },
      { symbol: '051900', name: 'LG생활건강', sector: '생활용품', description: '화장품, 생활용품, 음료 등을 생산하는 기업' },
      { symbol: '097950', name: 'CJ제일제당', sector: '식품', description: '식품, 소재, 바이오 분야의 글로벌 생활문화기업' }
    ];
    
    // 중소기업 및 중견기업 리스트
    const smallMediumCompanies = [
      { symbol: '060980', name: '웹젠', sector: '게임', description: '뮤 온라인 등 온라인 게임 개발 및 서비스 기업' },
      { symbol: '078340', name: '컴투스', sector: '게임', description: '모바일 게임 개발 및 퍼블리싱 기업' },
      { symbol: '036490', name: '미래에셋생명', sector: '보험', description: '미래에셋금융그룹의 생명보험사' },
      { symbol: '065350', name: '신성델타테크', sector: '기계', description: '반도체 장비 부품 제조업체' },
      { symbol: '085670', name: '에스티팜', sector: '제약', description: '올리고핵산 합성 원료의약품 제조업체' },
      { symbol: '161390', name: '한국타이어앤테크놀로지', sector: '자동차부품', description: '타이어 제조 전문 기업' },
      { symbol: '214320', name: '이노션', sector: '광고', description: '현대자동차그룹 광고대행사' },
      { symbol: '183490', name: '엔에이치엔', sector: 'IT 서비스', description: '한게임 등 게임 서비스 운영 기업' },
      { symbol: '066970', name: '엘앤에프', sector: '2차전지', description: '2차전지 양극재 제조업체' },
      { symbol: '096770', name: 'SK이노베이션', sector: '에너지', description: '석유정제 및 배터리 사업을 영위하는 기업' }
    ];
    
    // 중소형주 리스트
    const smallCapCompanies = [
      { symbol: '298540', name: '더네이쳐홀딩스', sector: '화장품', description: '네이처리퍼블릭 등 화장품 브랜드 보유' },
      { symbol: '272290', name: '이녹스첨단소재', sector: '전자부품', description: '디스플레이 소재 및 부품 제조업체' },
      { symbol: '243840', name: '신흥에스이씨', sector: '반도체', description: '반도체 장비 부품 제조업체' },
      { symbol: '033290', name: '코웰패션', sector: '패션', description: '여성 의류 및 잡화 제조업체' },
      { symbol: '214870', name: '뉴지랩', sector: '소프트웨어', description: 'AI 기반 데이터 분석 솔루션 제공업체' }
    ];
    
    // 모든 기업 합치기
    const companies = [...largeCompanies, ...smallMediumCompanies, ...smallCapCompanies];
    
    // 주식 초기 데이터 생성 함수
    function generateInitialStockData(companies) {
      const now = new Date();
      return companies.map(company => {
        // 각 기업별 초기 가격을 랜덤하게 설정 (섹터별로 비슷한 가격대 설정)
        let basePrice;
        
        switch(company.sector) {
          case '전자':
          case '반도체':
            basePrice = Math.floor(Math.random() * 50000) + 50000; // 5만~10만원
            break;
          case '자동차':
          case '자동차부품':
            basePrice = Math.floor(Math.random() * 30000) + 60000; // 6만~9만원
            break;
          case '화학':
          case '철강':
            basePrice = Math.floor(Math.random() * 40000) + 70000; // 7만~11만원
            break;
          case 'IT 서비스':
          case '게임':
            basePrice = Math.floor(Math.random() * 100000) + 200000; // 20만~30만원
            break;
          case '금융':
          case '지주회사':
            basePrice = Math.floor(Math.random() * 15000) + 35000; // 3.5만~5만원
            break;
          case '바이오':
          case '제약':
            basePrice = Math.floor(Math.random() * 60000) + 80000; // 8만~14만원
            break;
          default:
            basePrice = Math.floor(Math.random() * 50000) + 40000; // 4만~9만원
        }
        
        // 중소기업은 대체로 가격이 더 낮음
        if (smallMediumCompanies.some(c => c.symbol === company.symbol)) {
          basePrice = Math.max(5000, Math.floor(basePrice * 0.6)); // 대기업의 60% 수준
        }
        
        // 소형주는 더 낮은 가격
        if (smallCapCompanies.some(c => c.symbol === company.symbol)) {
          basePrice = Math.max(2000, Math.floor(basePrice * 0.3)); // 대기업의 30% 수준
        }
        
        // 1년치 일봉 데이터 생성 (365개 - 일별 데이터)
        const yearlyHistory = [];
        let yearPrice = basePrice * 0.7; // 1년 전 가격은 현재 가격의 70% 정도로 가정
        
        // 과거 365일의 일봉 데이터 생성
        for (let i = 365; i >= 0; i--) {
          const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000); // i일 전
          const dailyChange = (Math.random() - 0.48) * 0.03; // -1.5%~+1.5% 변동, 약간 상승 경향
          
          // 주말에는 거래가 없음
          const dayOfWeek = date.getDay();
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            continue;
          }
          
          yearPrice = Math.max(100, Math.round(yearPrice * (1 + dailyChange)));
          
          const open = yearPrice;
          const close = Math.max(100, Math.round(open * (1 + (Math.random() - 0.5) * 0.02)));
          const high = Math.max(open, close) * (1 + Math.random() * 0.01);
          const low = Math.min(open, close) * (1 - Math.random() * 0.01);
          const volume = Math.floor(Math.random() * 1000000) + 500000;
          
          yearlyHistory.push({
            time: date,
            open: open,
            high: high,
            low: low,
            close: close,
            volume: volume
          });
        }
        
        // 당일 분봉 데이터 생성 (390개 - 분단위 데이터, 6시간 30분)
        const intradayHistory = [];
        let currentPrice = basePrice;
        
        // 현재 시간 기준으로 9:00부터 15:30까지의 분봉 데이터 생성
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        let startTime = new Date(now);
        startTime.setHours(9, 0, 0, 0);
        
        // 만약 현재 시간이 15:30 이후면 당일 거래 완료로 간주하고 9:00부터 15:30까지 모든 데이터 생성
        // 그렇지 않으면 현재 시간까지만 생성
        let endMinute = (currentHour > 15 || (currentHour === 15 && currentMinute >= 30)) ? 390 : (currentHour - 9) * 60 + currentMinute;
        endMinute = Math.max(1, Math.min(390, endMinute)); // 1~390 사이 값으로 제한
        
        for (let i = 0; i < endMinute; i++) {
          const time = new Date(startTime.getTime() + i * 60000); // i분 후
          const minuteChange = (Math.random() - 0.5) * 0.005; // -0.25%~+0.25% 변동
          
          const open = currentPrice;
          currentPrice = Math.max(100, Math.round(currentPrice * (1 + minuteChange)));
          const high = Math.max(open, currentPrice) * (1 + Math.random() * 0.002);
          const low = Math.min(open, currentPrice) * (1 - Math.random() * 0.002);
          const close = currentPrice;
          const volume = Math.floor(Math.random() * 50000) + 10000;
          
          intradayHistory.push({
            time: time,
            open: open,
            high: high,
            low: low,
            close: close,
            volume: volume
          });
        }
        
        // 52주 최고/최저 계산
        const high52W = Math.max(...yearlyHistory.map(h => h.high));
        const low52W = Math.min(...yearlyHistory.map(h => h.low));
        
        // 당일 시가/고가/저가
        const dayOpen = intradayHistory.length > 0 ? intradayHistory[0].open : basePrice;
        const dayHigh = intradayHistory.length > 0 ? Math.max(...intradayHistory.map(h => h.high)) : basePrice * 1.02;
        const dayLow = intradayHistory.length > 0 ? Math.min(...intradayHistory.map(h => h.low)) : basePrice * 0.98;
        
        // 전일 종가
        const prevClose = yearlyHistory.length > 1 ? yearlyHistory[yearlyHistory.length - 2].close : basePrice * 0.99;
        
        return {
          symbol: company.symbol,
          name: company.name,
          sector: company.sector,
          description: company.description,
          currentPrice: currentPrice,
          prevClose: prevClose,
          dayOpen: dayOpen,
          dayHigh: dayHigh,
          dayLow: dayLow,
          high52W: high52W,
          low52W: low52W,
          yearlyHistory: yearlyHistory,
          intradayHistory: intradayHistory,
          news: [],
          volume: intradayHistory.reduce((sum, item) => sum + item.volume, 0),
          marketCap: currentPrice * (Math.floor(Math.random() * 1000000) + 1000000) // 시가총액 (현재가 * 발행주식수)
        };
      });
    }

    // 주식 데이터 생성
    const stocks = generateInitialStockData(companies);
    
    // ======================================================
    // 3. 부동산 데이터 정의
    // ======================================================
    
    // 부동산 타입별 기본 속성
    const propertyTypes = {
      apartment: { name: '아파트', maintenanceRate: 0.01, rentRate: 0.05 },
      officetel: { name: '오피스텔', maintenanceRate: 0.015, rentRate: 0.055 },
      commercial: { name: '상가', maintenanceRate: 0.02, rentRate: 0.07 },
      office: { name: '오피스', maintenanceRate: 0.025, rentRate: 0.06 },
      villa: { name: '빌라', maintenanceRate: 0.012, rentRate: 0.045 }
    };
    
    // 지역 정보
    const locations = [
      '서울 강남구', '서울 서초구', '서울 송파구', '서울 마포구', '서울 용산구',
      '서울 영등포구', '서울 강서구', '서울 노원구', '경기 성남시', '경기 수원시',
      '경기 용인시', '경기 화성시', '경기 부천시', '인천 연수구', '인천 남동구',
      '부산 해운대구', '부산 수영구', '대구 수성구', '대전 유성구', '광주 서구'
    ];
    
    // 부동산 데이터 생성 함수
    function generateRealEstateData() {
      const properties = [];
      
      // 아파트
      properties.push(
        { id: 'apt1', name: '래미안 퍼스티지', type: 'apartment', location: '서울 강남구', price: 1800000000, size: 109.5, year: 2015, premium: false },
        { id: 'apt2', name: '힐스테이트 에코', type: 'apartment', location: '서울 서초구', price: 1650000000, size: 114.2, year: 2017, premium: false },
        { id: 'apt3', name: '자이 더 익스클루시브', type: 'apartment', location: '서울 송파구', price: 1720000000, size: 101.8, year: 2016, premium: false },
        { id: 'apt4', name: '더샵 그레이스', type: 'apartment', location: '서울 마포구', price: 1320000000, size: 84.3, year: 2014, premium: false }
      );
      
      // 오피스텔
      properties.push(
        { id: 'off1', name: '디에이치 아너힐스', type: 'officetel', location: '서울 강남구', price: 680000000, size: 38.9, year: 2020, premium: false },
        { id: 'off2', name: '마크원 에비뉴', type: 'officetel', location: '서울 서초구', price: 720000000, size: 43.2, year: 2019, premium: false },
        { id: 'off3', name: '리버뷰 스테이', type: 'officetel', location: '서울 송파구', price: 650000000, size: 40.5, year: 2018, premium: false },
        { id: 'off4', name: '하모니 레지던스', type: 'officetel', location: '경기 성남시', price: 520000000, size: 44.8, year: 2017, premium: false }
      );
      
      // 상가
      properties.push(
        { id: 'com1', name: '가로수길 프라임', type: 'commercial', location: '서울 강남구', price: 3500000000, size: 152.4, year: 2015, premium: true },
        { id: 'com2', name: '명동 센트럴', type: 'commercial', location: '서울 중구', price: 4200000000, size: 178.9, year: 2010, premium: true },
        { id: 'com3', name: '홍대입구 플레이스', type: 'commercial', location: '서울 마포구', price: 2800000000, size: 143.6, year: 2012, premium: true },
        { id: 'com4', name: '판교 테크노밸리 스트리트', type: 'commercial', location: '경기 성남시', price: 2200000000, size: 165.8, year: 2016, premium: false }
      );
      
      // 오피스
      properties.push(
        { id: 'of1', name: '강남 파이낸스 센터', type: 'office', location: '서울 강남구', price: 12000000000, size: 856.4, year: 2012, premium: true },
        { id: 'of2', name: '여의도 IFC 타워', type: 'office', location: '서울 영등포구', price: 15000000000, size: 1245.7, year: 2011, premium: true },
        { id: 'of3', name: '선릉 IT 타워', type: 'office', location: '서울 강남구', price: 8500000000, size: 632.5, year: 2015, premium: true },
        { id: 'of4', name: '동탄 비즈니스 센터', type: 'office', location: '경기 화성시', price: 5200000000, size: 728.3, year: 2018, premium: false }
      );
      
      // 빌라
      properties.push(
        { id: 'v1', name: '청담 힐사이드', type: 'villa', location: '서울 강남구', price: 950000000, size: 118.6, year: 2016, premium: false },
        { id: 'v2', name: '서래 마을 테라스', type: 'villa', location: '서울 서초구', price: 880000000, size: 107.3, year: 2015, premium: false },
        { id: 'v3', name: '연남동 브라운스톤', type: 'villa', location: '서울 마포구', price: 750000000, size: 95.8, year: 2017, premium: false },
        { id: 'v4', name: '판교 타운하우스', type: 'villa', location: '경기 성남시', price: 680000000, size: 123.4, year: 2018, premium: false }
      );
      
      // 각 부동산의 투자 정보 계산
      return properties.map(property => {
        const typeInfo = propertyTypes[property.type];
        
        // 월세 수입
        const monthlyRent = Math.round(property.price * typeInfo.rentRate / 12);
        
        // 월 관리비
        const monthlyMaintenance = Math.round(property.price * typeInfo.maintenanceRate / 12);
        
        // 순 월 수입
        const netMonthlyIncome = monthlyRent - monthlyMaintenance;
        
        // 연 수익률
        const annualReturn = (netMonthlyIncome * 12) / property.price * 100;
        
        // 세금 및 수수료 (매입가의 2.5%)
        const taxAndFees = Math.round(property.price * 0.025);
        
        // 총 구매 비용
        const totalCost = property.price + taxAndFees;
        
        // 부동산 설명 생성
        let description = '';
        switch(property.type) {
          case 'apartment':
            description = `${property.location}에 위치한 ${property.size}㎡ 아파트로, ${property.year}년에 건축되었습니다. 편리한 교통과 우수한 생활 인프라를 갖추고 있습니다.`;
            break;
          case 'officetel':
            description = `${property.location}의 ${property.size}㎡ 오피스텔로, ${property.year}년에 준공되었습니다. 주거와 업무 공간으로 모두 활용 가능합니다.`;
            break;
          case 'commercial':
            description = `${property.location}에 위치한 ${property.size}㎡ 상가로, ${property.year}년에 건축되었습니다. 유동인구가 많은 위치에 있어 상업적 가치가 높습니다.`;
            break;
          case 'office':
            description = `${property.location}의 ${property.size}㎡ 오피스로, ${property.year}년에 준공되었습니다. 최신 시설을 갖춘 업무 공간입니다.`;
            break;
          case 'villa':
            description = `${property.location}에 위치한 ${property.size}㎡ 빌라로, ${property.year}년에 건축되었습니다. 조용한 주거 환경과 함께 편리한 생활을 누릴 수 있습니다.`;
            break;
        }
        
        return {
          ...property,
          typeInfo,
          monthlyRent,
          monthlyMaintenance,
          netMonthlyIncome,
          annualReturn,
          taxAndFees,
          totalCost,
          description,
          owned: false  // 초기에는 소유하지 않음
        };
      });
    }
    
    // 부동산 데이터 생성
    const realEstateProperties = generateRealEstateData();
    
    // ======================================================
    // 4. 대출 상품 정의
    // ======================================================
    
    // 대출 상품 목록
    const loanProducts = [
      {
        id: 'loan1',
        name: '신용 대출',
        description: '간단한 심사로 빠르게 이용할 수 있는 신용 대출 상품입니다.',
        minAmount: 500000,
        maxAmount: 50000000,
        interestRate: 0.12,  // 연 12%
        terms: [6, 12, 24, 36],  // 개월 단위
        earlyRepaymentFee: 0.02,  // 조기 상환 수수료 2%
        isSecured: false
      },
      {
        id: 'loan2',
        name: '담보 대출',
        description: '부동산을 담보로 낮은 금리의 대출을 이용할 수 있습니다.',
        minAmount: 10000000,
        maxAmount: 500000000,
        interestRate: 0.04,  // 연 4%
        terms: [12, 24, 36, 60],  // 개월 단위
        earlyRepaymentFee: 0.01,  // 조기 상환 수수료 1%
        isSecured: true
      },
      {
        id: 'loan3',
        name: '사업자 대출',
        description: '사업 운영에 필요한 자금을 조달할 수 있는 대출 상품입니다.',
        minAmount: 5000000,
        maxAmount: 100000000,
        interestRate: 0.08,  // 연 8%
        terms: [12, 24, 36],  // 개월 단위
        earlyRepaymentFee: 0.015,  // 조기 상환 수수료 1.5%
        isSecured: false
      },
      {
        id: 'loan4',
        name: '주택 담보 대출',
        description: '주택을 담보로 한 장기 대출 상품입니다.',
        minAmount: 50000000,
        maxAmount: 1000000000,
        interestRate: 0.035,  // 연 3.5%
        terms: [60, 120, 180, 240, 360],  // 개월 단위 (5년, 10년, 15년, 20년, 30년)
        earlyRepaymentFee: 0.02,  // 조기 상환 수수료 2%
        isSecured: true
      },
      {
        id: 'loan5',
        name: '단기 급전 대출',
        description: '긴급하게 자금이 필요할 때 이용할 수 있는 고금리 단기 대출입니다.',
        minAmount: 100000,
        maxAmount: 5000000,
        interestRate: 0.18,  // 연 18%
        terms: [1, 3, 6],  // 개월 단위
        earlyRepaymentFee: 0.03,  // 조기 상환 수수료 3%
        isSecured: false
      }
    ];
    
    // ======================================================
    // 5. 뉴스 데이터 및 이벤트 정의
    // ======================================================
    
    // 뉴스 이벤트 데이터 (대기업 관련)
    const largeCompanyNews = [
      // 호재성 뉴스 (긍정적 영향)
      { headline: "삼성전자, 혁신 신제품 발표로 주가 상승", symbol: "005930", impact: 0.03, type: "positive" },
      { headline: "SK하이닉스, 반도체 수요 폭증에 실적 개선 전망", symbol: "000660", impact: 0.04, type: "positive" },
      { headline: "NAVER, 글로벌 시장 진출 확대 전략 발표", symbol: "035420", impact: 0.025, type: "positive" },
      { headline: "LG화학, 친환경 배터리 신기술 개발 성공", symbol: "051910", impact: 0.045, type: "positive" },
      { headline: "현대자동차, 전기차 판매량 예상치 상회", symbol: "005380", impact: 0.035, type: "positive" },
      
      // 악재성 뉴스 (부정적 영향)
      { headline: "삼성전자, 반도체 경쟁 심화로 실적 우려", symbol: "005930", impact: -0.025, type: "negative" },
      { headline: "SK하이닉스, 글로벌 공급망 이슈로 생산 차질", symbol: "000660", impact: -0.035, type: "negative" },
      { headline: "NAVER, 해외 사업 확장 지연 소식", symbol: "035420", impact: -0.02, type: "negative" },
      { headline: "LG화학, 원자재 가격 상승으로 수익성 하락", symbol: "051910", impact: -0.03, type: "negative" },
      { headline: "현대자동차, 부품 수급 차질로 생산량 감소", symbol: "005380", impact: -0.025, type: "negative" }
    ];
    
    // 뉴스 이벤트 데이터 (중소기업 관련 추가)
    const smallMediumCompanyNews = [
      // 호재성 뉴스 (긍정적 영향)
      { headline: "웹젠, 신작 게임 흥행에 분기 실적 호조", symbol: "060980", impact: 0.05, type: "positive" },
      { headline: "컴투스, 글로벌 모바일 게임 시장 점유율 확대", symbol: "078340", impact: 0.045, type: "positive" },
      { headline: "미래에셋생명, 디지털 보험 상품 판매 호조", symbol: "036490", impact: 0.03, type: "positive" },
      { headline: "신성델타테크, 주요 고객사와 공급 계약 체결", symbol: "065350", impact: 0.055, type: "positive" },
      { headline: "에스티팜, 바이오 신약 임상 성공적 진행", symbol: "085670", impact: 0.06, type: "positive" },
      
      // 악재성 뉴스 (부정적 영향)
      { headline: "웹젠, 게임 출시 일정 연기로 주가 하락", symbol: "060980", impact: -0.04, type: "negative" },
      { headline: "컴투스, 모바일 게임 시장 경쟁 심화", symbol: "078340", impact: -0.035, type: "negative" },
      { headline: "미래에셋생명, 금리 인하로 보험 수익성 악화 우려", symbol: "036490", impact: -0.025, type: "negative" },
      { headline: "신성델타테크, 원자재 가격 상승으로 마진 압박", symbol: "065350", impact: -0.04, type: "negative" },
      { headline: "에스티팜, 신약 임상 결과 기대치 하회", symbol: "085670", impact: -0.05, type: "negative" }
    ];
    
    // 뉴스 이벤트 데이터 (소형주 관련 추가)
    const smallCapCompanyNews = [
      // 호재성 뉴스 (긍정적 영향)
      { headline: "더네이쳐홀딩스, 신규 화장품 라인 출시로 매출 증가", symbol: "298540", impact: 0.07, type: "positive" },
      { headline: "이녹스첨단소재, 디스플레이 신소재 개발 성공", symbol: "272290", impact: 0.065, type: "positive" },
      { headline: "신흥에스이씨, 반도체 장비 부품 수주 증가", symbol: "243840", impact: 0.06, type: "positive" },
      { headline: "코웰패션, 온라인 판매 확대로 실적 개선", symbol: "033290", impact: 0.055, type: "positive" },
      { headline: "뉴지랩, AI 솔루션 대기업 공급 계약 체결", symbol: "214870", impact: 0.08, type: "positive" },
      
      // 악재성 뉴스 (부정적 영향)
      { headline: "더네이쳐홀딩스, 중국 시장 경쟁 심화로 마진 하락", symbol: "298540", impact: -0.06, type: "negative" },
      { headline: "이녹스첨단소재, 원자재 가격 상승으로 원가 부담", symbol: "272290", impact: -0.055, type: "negative" },
      { headline: "신흥에스이씨, 고객사 투자 지연으로 수주 감소", symbol: "243840", impact: -0.05, type: "negative" },
      { headline: "코웰패션, 패션 업계 침체로 매출 감소", symbol: "033290", impact: -0.045, type: "negative" },
      { headline: "뉴지랩, 경쟁사 유사 기술 출시로 경쟁 심화", symbol: "214870", impact: -0.07, type: "negative" }
    ];
    
    // 산업별/글로벌 뉴스
    const sectorGlobalNews = [
      // 산업별 뉴스 (다양한 종목에 영향)
      { headline: "반도체 업종, 슈퍼 사이클 진입 전망에 투자자 관심 집중", symbols: ["005930", "000660", "058470"], impact: 0.025, type: "sector_positive" },
      { headline: "자동차 산업, 친환경차 전환 가속화로 부품 수요 증가", symbols: ["005380", "000270", "012330"], impact: 0.02, type: "sector_positive" },
      { headline: "반도체 업종, 공급 과잉 우려로 주가 조정", symbols: ["005930", "000660", "058470"], impact: -0.02, type: "sector_negative" },
      { headline: "자동차 산업, 원자재 가격 상승으로 원가 부담 가중", symbols: ["005380", "000270", "012330"], impact: -0.015, type: "sector_negative" },
      
      // 글로벌 이슈 뉴스 (전체 시장 영향)
      { headline: "미 연준, 금리 인상 속도 완화 시사에 글로벌 증시 상승", symbols: "all", impact: 0.015, type: "global_positive" },
      { headline: "글로벌 공급망 안정화 진전, 기업 실적 개선 기대감", symbols: "all", impact: 0.01, type: "global_positive" },
      { headline: "인플레이션 우려 지속, 긴축 가속화 가능성에 시장 불안", symbols: "all", impact: -0.015, type: "global_negative" },
      { headline: "글로벌 경기 침체 우려 확대로 위험자산 회피 심리 강화", symbols: "all", impact: -0.02, type: "global_negative" }
    ];
    
    // 뉴스 제목과 상세 내용
    const newsDetails = {
      // 긍정적 뉴스 상세 내용
      positive: [
        "최근 발표된 {company} 실적은 시장 예상치를 크게 상회했습니다. 전년 대비 매출은 {revenue}%, 영업이익은 {profit}% 증가했으며, 특히 {sector} 부문에서 두드러진 성장을 보였습니다. 회사는 향후에도 이러한 성장세가 지속될 것으로 전망하고 있습니다.",
        "{company}가 혁신적인 신제품 출시를 발표했습니다. 이번 제품은 기존 대비 효율성이 {efficiency}% 향상되었으며, {feature} 기능이 추가되어 시장에서 큰 호응을 얻을 것으로 예상됩니다. 증권가에서는 이번 신제품이 회사의 시장 점유율을 {market}%p 높일 것으로 전망하고 있습니다.",
        "{company}가 글로벌 시장 확대를 위한 신규 투자 계획을 발표했습니다. 향후 {period}년간 약 {investment}억 원을 투자하여 {region} 지역에 생산 시설을 확충하고, 현지 판매망을 강화할 예정입니다. 이번 투자로 회사의 글로벌 경쟁력이 한층 강화될 것으로 기대됩니다."
      ],
      
      // 부정적 뉴스 상세 내용
      negative: [
        "{company}의 최근 실적이 시장 예상치를 하회했습니다. 전년 대비 매출은 {revenue}% 감소했으며, 영업이익은 {profit}% 하락했습니다. 주요 원인으로는 {reason} 등이 지목되고 있으며, 회사는 구조조정과 비용 절감을 통해 수익성 개선에 나설 계획입니다.",
        "{company}의 주요 제품에서 품질 이슈가 발견되었습니다. 이번 이슈는 {issue} 관련 문제로, 전체 생산량의 약 {percentage}%에 영향을 미칠 것으로 예상됩니다. 회사는 즉각적인 대응책 마련과 함께 추가 조사를 진행하고 있습니다.",
        "{company}가 직면한 공급망 차질로 인해 생산 일정에 차질이 빚어지고 있습니다. 특히 {component} 부품 수급 문제로 인해 생산량이 {reduction}% 감소할 것으로 예상됩니다. 이로 인해 당분간 실적 부진이 불가피할 전망입니다."
      ],
      
      // 산업 뉴스 상세 내용
      sector_positive: [
        "{sector} 산업이 호황기에 진입하고 있습니다. 최근 {factor} 요인으로 인해 시장 수요가 크게 증가하고 있으며, 향후 {period}년간 연평균 {growth}%의 성장이 예상됩니다. 특히 {subsector} 분야의 성장세가 두드러질 것으로 전망됩니다.",
        "{sector} 산업에 대한 정부의 지원 정책이 확대됩니다. 정부는 향후 {period}년간 약 {support}조 원 규모의 지원 예산을 편성하고, {regulation} 관련 규제를 완화하기로 결정했습니다. 이를 통해 관련 기업들의 경쟁력 강화와 산업 생태계 활성화가 기대됩니다."
      ],
      
      // 산업 뉴스 부정적 내용
      sector_negative: [
        "{sector} 산업이 침체기에 접어들고 있습니다. {factor} 요인으로 인해 시장 수요가 감소하고 있으며, 향후 {period}년간 약 {decline}%의 시장 축소가 예상됩니다. 관련 기업들은 구조조정과 사업 다각화를 통해 위기를 극복하려는 움직임을 보이고 있습니다.",
        "{sector} 산업에 대한 규제가 강화될 전망입니다. 정부는 {regulation} 관련 규제를 강화하고, 업계 관행에 대한 감독을 강화할 계획입니다. 이로 인해 관련 기업들의 비용 부담이 증가하고 사업 환경이 악화될 것으로 우려됩니다."
      ],
      
      // 글로벌 긍정적 뉴스
      global_positive: [
        "글로벌 경제 회복 신호가 강화되고 있습니다. 주요국의 GDP 성장률이 예상치를 상회하고 있으며, 특히 {region} 지역에서 {growth}%의 높은 성장세를 보이고 있습니다. IMF와 세계은행은 올해 세계 경제 성장률 전망치를 상향 조정했습니다.",
        "국제 금융시장의 유동성이 풍부해지고 있습니다. 주요 중앙은행들의 통화정책 기조가 완화적으로 유지되면서 시장에 풍부한 자금이 공급되고 있으며, 이는 주식시장을 비롯한 위험자산 가격 상승으로 이어지고 있습니다."
      ],
      
      // 글로벌 부정적 뉴스
      global_negative: [
        "글로벌 경기 둔화 우려가 확산되고 있습니다. 주요국의 경제지표가 예상보다 부진한 모습을 보이고 있으며, 특히 {region} 지역에서 {decline}%의 성장 둔화가 관측되고 있습니다. 주요 경제 연구기관들은 세계 경제 성장률 전망치를 하향 조정하고 있습니다.",
        "인플레이션 압력이 지속되고 있습니다. 주요국의 소비자물가 상승률이 목표치를 상회하면서 중앙은행들의 긴축 정책 가속화 우려가 커지고 있습니다. 이는 기업 실적과 주식 시장에 부담 요인으로 작용할 전망입니다."
      ]
    };
    
    // 모든 뉴스 이벤트 합치기
    const newsEvents = [...largeCompanyNews, ...smallMediumCompanyNews, ...smallCapCompanyNews, ...sectorGlobalNews];
    
    // 뉴스 생성 함수
    function generateNewsArticle(event, date = new Date()) {
      // 기본 뉴스 정보
      const newsArticle = {
        id: `news_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
        headline: event.headline,
        date: date,
        type: event.type,
        impact: event.impact,
        read: false
      };
      
      // 영향받는 종목들
      if (event.symbol && event.symbol !== 'all') {
        newsArticle.affectedStocks = [{ symbol: event.symbol, impact: event.impact }];
      } else if (event.symbols && event.symbols !== 'all' && Array.isArray(event.symbols)) {
        newsArticle.affectedStocks = event.symbols.map(symbol => ({ symbol, impact: event.impact }));
      } else if (event.symbols === 'all') {
        newsArticle.affectedStocks = 'all';
      }
      
      // 상세 내용 생성
      let detailType = event.type;
      if (detailType.startsWith('sector_')) {
        detailType = 'sector_' + (event.impact > 0 ? 'positive' : 'negative');
      } else if (detailType.startsWith('global_')) {
        detailType = 'global_' + (event.impact > 0 ? 'positive' : 'negative');
      } else {
        detailType = event.impact > 0 ? 'positive' : 'negative';
      }
      
      // 상세 내용 템플릿 선택
      const templates = newsDetails[detailType] || [];
      if (templates.length > 0) {
        const template = templates[Math.floor(Math.random() * templates.length)];
        
        // 템플릿 파라미터 채우기
        let content = template;
        
        // 회사명 치환
        if (event.symbol && event.symbol !== 'all') {
          const company = stocks.find(s => s.symbol === event.symbol);
          if (company) {
            content = content.replace(/{company}/g, company.name);
            content = content.replace(/{sector}/g, company.sector);
          }
        }
        
        // 섹터 뉴스인 경우
        if (event.type.startsWith('sector_')) {
          // 해당 섹터 찾기
          let sector = '';
          if (event.symbols && Array.isArray(event.symbols) && event.symbols.length > 0) {
            const firstStock = stocks.find(s => s.symbol === event.symbols[0]);
            if (firstStock) {
              sector = firstStock.sector;
            }
          }
          content = content.replace(/{sector}/g, sector);
        }
        
        // 랜덤 수치 채우기
        content = content.replace(/{revenue}/g, (Math.random() * 15 + 5).toFixed(1));
        content = content.replace(/{profit}/g, (Math.random() * 20 + 10).toFixed(1));
        content = content.replace(/{efficiency}/g, (Math.random() * 20 + 10).toFixed(1));
        content = content.replace(/{market}/g, (Math.random() * 5 + 1).toFixed(1));
        content = content.replace(/{period}/g, Math.floor(Math.random() * 3) + 3);
        content = content.replace(/{investment}/g, (Math.random() * 5000 + 1000).toFixed(0));
        content = content.replace(/{region}/g, ['미국', '유럽', '중국', '동남아시아', '일본'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{feature}/g, ['AI 기반', '클라우드 연동', '에너지 효율', '보안 강화', '사용자 경험 최적화'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{reason}/g, ['원자재 가격 상승', '경쟁 심화', '수요 감소', '환율 변동', '물류비 증가'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{issue}/g, ['부품 결함', '소프트웨어 버그', '안전성 문제', '성능 저하', '호환성 이슈'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{percentage}/g, (Math.random() * 30 + 5).toFixed(1));
        content = content.replace(/{component}/g, ['반도체', '디스플레이', '배터리', '센서', '모터'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{reduction}/g, (Math.random() * 40 + 10).toFixed(1));
        content = content.replace(/{factor}/g, ['기술 혁신', '정부 지원', '소비 패턴 변화', '글로벌 수요 증가', '산업 구조 개편'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{growth}/g, (Math.random() * 10 + 5).toFixed(1));
        content = content.replace(/{decline}/g, (Math.random() * 5 + 1).toFixed(1));
        content = content.replace(/{subsector}/g, ['친환경', '디지털 전환', '스마트', '프리미엄', '서비스'][Math.floor(Math.random() * 5)]);
        content = content.replace(/{support}/g, Math.floor(Math.random() * 10) + 1);
        content = content.replace(/{regulation}/g, ['환경', '안전', '데이터', '금융', '소비자 보호'][Math.floor(Math.random() * 5)]);
        
        newsArticle.content = content;
      } else {
        // 템플릿이 없는 경우 기본 내용
        newsArticle.content = `${event.headline}에 관한 상세 내용입니다. 이 뉴스는 관련 주식의 가격에 ${event.impact > 0 ? '긍정적' : '부정적'} 영향을 미칠 것으로 예상됩니다.`;
      }
      
      return newsArticle;
    }
    
    // ======================================================
    // 6. UI 이벤트 핸들러 설정
    // ======================================================
    
    // DOM이 로드된 후 실행
    document.addEventListener('DOMContentLoaded', () => {
      // 메인 네비게이션 탭 전환
      document.querySelectorAll('.nav-item').forEach(navItem => {
        navItem.addEventListener('click', () => {
          // 이전 활성 탭 비활성화
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          navItem.classList.add('active');
          
          // 해당 콘텐츠 표시
          const tab = navItem.dataset.tab;
          activeContent = tab;
          
          // 모든 콘텐츠 숨기기
          document.querySelectorAll('.main-content').forEach(content => {
            content.style.display = 'none';
          });
          
          // 선택된 콘텐츠 표시
          document.getElementById(`${tab}Content`).style.display = 'flex';
          
          // 읽지 않은 뉴스 알림 처리
          if (tab === 'news') {
            document.getElementById('newsAlert').style.display = 'none';
            simulation.news.unread = 0;
          }
        });
      });
      
      // 사이드바 탭 전환
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // 이전 활성 탭 비활성화
          document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // 클릭한 탭 활성화
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
      
      // 주식 테이블 행 클릭 이벤트
      document.querySelector('#stocksTable tbody').addEventListener('click', (e) => {
        // 가장 가까운 tr 찾기
        const row = e.target.closest('tr');
        if (row) {
          const symbol = row.dataset.symbol;
          if (symbol) {
            selectStock(symbol);
          }
        }
      });
      
      // 차트 기간 변경
      document.querySelectorAll('.chart-period').forEach(period => {
        period.addEventListener('click', () => {
          // 이전 활성 기간 비활성화
          document.querySelectorAll('.chart-period').forEach(p => p.classList.remove('active'));
          
          // 클릭한 기간 활성화
          period.classList.add('active');
          chartPeriod = period.dataset.period;
          
          // 차트 업데이트
          if (selectedStock) {
            updateChart();
          }
        });
      });
      
      // 차트 타입 변경
      document.querySelectorAll('.chart-type').forEach(type => {
        type.addEventListener('click', () => {
          // 이전 활성 타입 비활성화
          document.querySelectorAll('.chart-type').forEach(t => t.classList.remove('active'));
          
          // 클릭한 타입 활성화
          type.classList.add('active');
          chartType = type.dataset.type;
          
          // 차트 업데이트
          if (selectedStock) {
            recreateChart();
          }
        });
      });
      
      // 차트 지표 변경
      document.querySelectorAll('.chart-indicator').forEach(indicator => {
        indicator.addEventListener('click', () => {
          const indicatorType = indicator.dataset.indicator;
          
          // 지표 토글
          if (indicator.classList.contains('active')) {
            indicator.classList.remove('active');
            activeIndicators = activeIndicators.filter(i => i !== indicatorType);
          } else {
            indicator.classList.add('active');
            activeIndicators.push(indicatorType);
          }
          
          // 차트 업데이트
          if (selectedStock) {
            updateChart();
          }
        });
      });
      
      // 거래 탭 변경
      document.querySelectorAll('.trade-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // 이전 활성 탭 비활성화
          document.querySelectorAll('.trade-tab').forEach(t => t.classList.remove('active'));
          
          // 클릭한 탭 활성화
          tab.classList.add('active');
          tradeType = tab.dataset.trade;
          
          // 거래 버튼 업데이트
          const tradeButton = document.getElementById('tradeButton');
          if (tradeType === 'buy') {
            tradeButton.textContent = '매수 주문';
            tradeButton.className = 'trade-button buy';
          } else {
            tradeButton.textContent = '매도 주문';
            tradeButton.className = 'trade-button sell';
          }
          
          // 거래 요약 업데이트
          updateTradeSummary();
        });
      });
      
      // 거래 수량 입력 변경 이벤트
      document.getElementById('tradeQuantity').addEventListener('input', () => {
        updateTradeSummary();
        updateQuantitySlider();
      });
      
      // 수량 슬라이더 변경 이벤트
      document.getElementById('quantitySlider').addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        document.getElementById('tradeQuantity').value = value;
        updateTradeSummary();
      });
      
      // 거래 버튼 클릭 이벤트
      document.getElementById('tradeButton').addEventListener('click', () => {
        if (!selectedStock) {
          showNotification('경고', '먼저 종목을 선택하세요.', 'error');
          return;
        }
        
        const quantity = parseInt(document.getElementById('tradeQuantity').value);
        if (isNaN(quantity) || quantity <= 0) {
          showNotification('경고', '올바른 수량을 입력하세요.', 'error');
          return;
        }
        
        // 주문 확인 모달 표시
        showOrderConfirmation(tradeType, selectedStock, quantity);
      });
      
      // 주식 검색 필터
      document.getElementById('stockSearch').addEventListener('input', filterStocksTable);
      document.getElementById('sectorFilter').addEventListener('change', filterStocksTable);
      
      // 테이블 정렬
      document.querySelectorAll('#stocksTable th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          sortStocksTable(th.dataset.sort);
        });
      });
      
      // 모달 닫기 버튼
      document.querySelectorAll('.modal-close, .modal-overlay').forEach(elem => {
        elem.addEventListener('click', (e) => {
          if (e.target === elem) {
            closeAllModals();
          }
        });
      });
      
      // 주문 확인 모달 버튼
      document.getElementById('orderCancelButton').addEventListener('click', closeAllModals);
      document.getElementById('orderConfirmButton').addEventListener('click', executeOrder);
      
      // 부동산 모달 버튼
      document.getElementById('propertyCloseButton').addEventListener('click', closeAllModals);
      document.getElementById('propertyBuyButton').addEventListener('click', purchaseProperty);
      
      // 뉴스 모달 버튼
      document.getElementById('newsCloseButton').addEventListener('click', closeAllModals);
      
      // 대출 모달 버튼
      document.getElementById('loanCloseButton').addEventListener('click', closeAllModals);
      document.getElementById('loanApplyButton').addEventListener('click', applyForLoan);
      
      // 대출 상환 모달 버튼
      document.getElementById('repayCloseButton').addEventListener('click', closeAllModals);
      document.getElementById('repayButton').addEventListener('click', repayLoan);
      
      // 대출 기간 옵션
      document.querySelectorAll('.loan-term-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.loan-term-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          // 대출 계산 업데이트
          if (selectedLoan) {
            calculateLoan();
          }
        });
      });
      
      // 대출 금액 슬라이더
      document.getElementById('loanAmount').addEventListener('input', () => {
        if (selectedLoan) {
          const amount = parseFloat(document.getElementById('loanAmount').value.replace(/[^\d.-]/g, ''));
          const slider = document.getElementById('loanAmountSlider');
          
          if (!isNaN(amount)) {
            const max = selectedLoan.maxAmount;
            const min = selectedLoan.minAmount;
            const percentage = Math.min(100, Math.max(0, ((amount - min) / (max - min)) * 100));
            
            slider.value = percentage;
            calculateLoan();
          }
        }
      });
      
      document.getElementById('loanAmountSlider').addEventListener('input', (e) => {
        if (selectedLoan) {
          const percentage = parseFloat(e.target.value);
          const max = selectedLoan.maxAmount;
          const min = selectedLoan.minAmount;
          const amount = Math.round(min + (percentage / 100) * (max - min));
          
          document.getElementById('loanAmount').value = formatCurrency(amount);
          calculateLoan();
        }
      });
      
      // 저장/불러오기 버튼
      document.getElementById('saveButton').addEventListener('click', () => {
        showSaveLoadModal('save');
      });
      
      document.getElementById('loadButton').addEventListener('click', () => {
        showSaveLoadModal('load');
      });
      
      document.getElementById('saveLoadCancelButton').addEventListener('click', closeAllModals);
      document.getElementById('saveButton').addEventListener('click', saveSimulation);
      document.getElementById('loadConfirmButton').addEventListener('click', loadSimulation);
      
      // 파일 업로드 처리
      document.getElementById('loadFileInput').addEventListener('change', handleFileUpload);
      
      // 파산 모달 버튼
      document.getElementById('bankruptcyRestartButton').addEventListener('click', restartSimulation);
      
      // 테마 토글
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // 포트폴리오 정렬 버튼
      document.getElementById('portfolioSort').addEventListener('click', sortPortfolio);
      
      // 섹터 필터 옵션 채우기
      populateSectorFilter();
      
      // 초기 렌더링
      renderStocksTable();
      updatePortfolioDisplay();
      renderRealEstateList();
      renderLoanProducts();
      renderNewsItems();
      
      // 첫 번째 주식 선택 (기본값)
      if (stocks.length > 0) {
        selectStock(stocks[0].symbol);
      }
    });
    
    // ======================================================
    // 7. 주식 선택 및 표시 함수
    // ======================================================
    
    // 주식 선택 함수
    function selectStock(symbol) {
      try {
        selectedStock = stocks.find(s => s.symbol === symbol);
        
        if (!selectedStock) {
          showNotification('오류', '종목을 찾을 수 없습니다.', 'error');
          return;
        }
        
        // 종목 정보 업데이트
        document.getElementById('selectedStockName').textContent = selectedStock.name;
        document.getElementById('selectedStockSymbol').textContent = selectedStock.symbol;
        document.getElementById('selectedStockSector').querySelector('span').textContent = selectedStock.sector;
        
        // 가격 정보 업데이트
        updateSelectedStockPrice();
        
        // 차트 업데이트
        recreateChart();
        
        // 거래 요약 업데이트
        updateTradeSummary();
        
        // 차트 정보 업데이트
        updateChartInfo();
        
        // 거래 가격 업데이트
        document.getElementById('tradePrice').value = formatCurrency(selectedStock.currentPrice);
        
        // 메인 콘텐츠 활성화 (주식 탭으로)
        if (activeContent !== 'stock') {
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          document.querySelector('.nav-item[data-tab="stock"]').classList.add('active');
          
          document.querySelectorAll('.main-content').forEach(content => {
            content.style.display = 'none';
          });
          
          document.getElementById('stockContent').style.display = 'flex';
          activeContent = 'stock';
        }
      } catch (error) {
        console.error('주식 선택 오류:', error);
        showNotification('오류', '주식 정보를 불러오는 중 오류가 발생했습니다.', 'error');
      }
    }
    
    // 선택된 주식 가격 정보 업데이트
    function updateSelectedStockPrice() {
      if (!selectedStock) return;
      
      const currentPrice = selectedStock.currentPrice;
      const prevClose = selectedStock.prevClose;
      const change = currentPrice - prevClose;
      const changePercent = (change / prevClose * 100).toFixed(2);
      
      document.getElementById('currentPrice').textContent = formatCurrency(currentPrice);
      
      const priceChangeElement = document.getElementById('priceChange');
      priceChangeElement.innerHTML = `
        <i class="material-icons">${change >= 0 ? 'arrow_upward' : 'arrow_downward'}</i>
        ${change >= 0 ? '+' : ''}${formatCurrency(change)} (${change >= 0 ? '+' : ''}${changePercent}%)
      `;
      priceChangeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
      
      // 일중 변동폭
      const dayRange = document.getElementById('priceDayRange');
      dayRange.textContent = `${formatCurrency(selectedStock.dayLow)} ~ ${formatCurrency(selectedStock.dayHigh)}`;
    }
    
    // 차트 정보 업데이트
    function updateChartInfo() {
      if (!selectedStock) return;
      
      document.getElementById('stockOpen').textContent = formatCurrency(selectedStock.dayOpen);
      document.getElementById('stockHigh').textContent = formatCurrency(selectedStock.dayHigh);
      document.getElementById('stockLow').textContent = formatCurrency(selectedStock.dayLow);
      document.getElementById('stockVolume').textContent = formatNumber(selectedStock.volume);
      document.getElementById('stock52High').textContent = formatCurrency(selectedStock.high52W);
      document.getElementById('stock52Low').textContent = formatCurrency(selectedStock.low52W);
    }
    
    // ======================================================
    // 8. 차트 관련 함수
    // ======================================================
    
    // 차트 완전히 새로 생성
    function recreateChart() {
      if (stockChart) {
        stockChart.destroy();
        stockChart = null;
      }
      
      if (volumeChart) {
        volumeChart.destroy();
        volumeChart = null;
      }
      
      createChart();
    }
    
    // 차트 생성 함수
    function createChart() {
      if (!selectedStock) return;
      
      try {
        const ctx = document.getElementById('stockChart').getContext('2d');
        const chartData = prepareChartData();
        
        // 차트 옵션
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: getTimeUnit(),
                displayFormats: {
                  hour: 'HH:mm',
                  day: 'MM-DD',
                  week: 'MM-DD',
                  month: 'YYYY-MM'
                }
              },
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              position: 'right',
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, true);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (context) => {
                  const datasetLabel = context.dataset.label || '';
                  const value = context.parsed.y;
                  return `${datasetLabel}: ${formatCurrency(value)}`;
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x'
              },
              zoom: {
                wheel: {
                  enabled: true
                },
                pinch: {
                  enabled: true
                },
                mode: 'x'
              }
            }
          }
        };
        
        // 차트 생성
        stockChart = new Chart(ctx, {
          type: chartType === 'candlestick' ? 'bar' : 'line',
          data: chartData,
          options: options
        });
        
        // 이동평균선 같은 추가 데이터셋 처리
        if (activeIndicators.includes('ma')) {
          addMovingAverages();
        }
        
        // 거래량 차트 생성 (지표에 포함된 경우)
        if (activeIndicators.includes('volume')) {
          createVolumeChart();
        }
      } catch (error) {
        console.error('차트 생성 오류:', error);
        showNotification('오류', '차트를 생성하는 중 오류가 발생했습니다.', 'error');
      }
    }
    
    // 시간 단위 얻기
    function getTimeUnit() {
      switch (chartPeriod) {
        case 'day': return 'hour';
        case 'week': return 'day';
        case 'month': return 'day';
        case 'year': return 'month';
        default: return 'hour';
      }
    }
    
    // 거래량 차트 생성
    function createVolumeChart() {
      if (!selectedStock) return;
      
      // 기존 거래량 차트 제거
      if (volumeChart) {
        volumeChart.destroy();
      }
      
      // 거래량 캔버스가 있는지 확인, 없으면 생성
      let volumeCanvas = document.getElementById('volumeChart');
      if (!volumeCanvas) {
        volumeCanvas = document.createElement('canvas');
        volumeCanvas.id = 'volumeChart';
        volumeCanvas.style.height = '100px';
        volumeCanvas.style.width = '100%';
        volumeCanvas.style.marginTop = '10px';
        
        const chartWrapper = document.querySelector('.chart-wrapper');
        chartWrapper.appendChild(volumeCanvas);
      }
      
      // 데이터 필터링 (기간에 따라)
      const filteredHistory = getFilteredHistory();
      
      // 거래량 데이터 준비
      const volumeData = {
        labels: filteredHistory.map(h => h.time),
        datasets: [{
          label: '거래량',
          data: filteredHistory.map((h, index) => ({
            x: h.time,
            y: h.volume
          })),
          backgroundColor: filteredHistory.map((h, index) => {
            if (index > 0 && h.close >= filteredHistory[index - 1].close) {
              return 'rgba(214, 48, 49, 0.5)'; // 상승 - 빨간색
            } else {
              return 'rgba(9, 132, 227, 0.5)'; // 하락 - 파란색
            }
          }),
          borderColor: filteredHistory.map((h, index) => {
            if (index > 0 && h.close >= filteredHistory[index - 1].close) {
              return 'rgba(214, 48, 49, 1)';
            } else {
              return 'rgba(9, 132, 227, 1)';
            }
          }),
          borderWidth: 1
        }]
      };
      
      // 거래량 차트 옵션
      const volumeOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: getTimeUnit(),
              displayFormats: {
                hour: 'HH:mm',
                day: 'MM-DD',
                week: 'MM-DD',
                month: 'YYYY-MM'
              }
            },
            grid: {
              display: false
            },
            ticks: {
              display: false
            }
          },
          y: {
            position: 'left',
            grid: {
              display: false
            },
            ticks: {
              callback: function(value) {
                if (value >= 1000000) {
                  return (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                  return (value / 1000).toFixed(1) + 'K';
                }
                return value;
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = context.parsed.y;
                return `거래량: ${formatNumber(value)}`;
              }
            }
          }
        }
      };
      
      // 차트 생성
      volumeChart = new Chart(volumeCanvas.getContext('2d'), {
        type: 'bar',
        data: volumeData,
        options: volumeOptions
      });
    }
    
    // 이동평균선 추가
    function addMovingAverages() {
      if (!selectedStock || !stockChart) return;
      
      // 기존 이동평균선 제거
      stockChart.data.datasets = stockChart.data.datasets.filter(dataset => !dataset.label.includes('이동평균'));
      
      // 데이터 필터링
      const filteredHistory = getFilteredHistory();
      const closePrices = filteredHistory.map(h => h.close);
      
      // 기간에 따른 이동평균 기간 설정
      const maLengths = [];
      switch (chartPeriod) {
        case 'day':
          maLengths.push({ days: 5, color: 'rgba(255, 99, 132, 1)', label: '5일' });
          maLengths.push({ days: 10, color: 'rgba(54, 162, 235, 1)', label: '10일' });
          break;
        case 'week':
          maLengths.push({ days: 5, color: 'rgba(255, 99, 132, 1)', label: '5일' });
          maLengths.push({ days: 20, color: 'rgba(54, 162, 235, 1)', label: '20일' });
          break;
        case 'month':
          maLengths.push({ days: 20, color: 'rgba(255, 99, 132, 1)', label: '20일' });
          maLengths.push({ days: 60, color: 'rgba(54, 162, 235, 1)', label: '60일' });
          break;
        case 'year':
          maLengths.push({ days: 60, color: 'rgba(255, 99, 132, 1)', label: '60일' });
          maLengths.push({ days: 120, color: 'rgba(54, 162, 235, 1)', label: '120일' });
          break;
      }
      
      // 각 이동평균선 추가
      maLengths.forEach(ma => {
        if (closePrices.length < ma.days) return;
        
        const maValues = [];
        for (let i = 0; i < closePrices.length; i++) {
          if (i < ma.days - 1) {
            maValues.push(null);
          } else {
            let sum = 0;
            for (let j = 0; j < ma.days; j++) {
              sum += closePrices[i - j];
            }
            maValues.push(sum / ma.days);
          }
        }
        
        // 이동평균선 데이터 추가
        stockChart.data.datasets.push({
          label: `${ma.label} 이동평균`,
          data: maValues.map((value, index) => ({
            x: filteredHistory[index].time,
            y: value
          })),
          borderColor: ma.color,
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1,
          type: 'line'
        });
      });
      
      stockChart.update();
    }
    
    // 차트 데이터 준비 함수
    function prepareChartData() {
      if (!selectedStock) return null;
      
      // 데이터 필터링 (기간에 따라)
      const filteredHistory = getFilteredHistory();
      
      // 차트 타입에 따라 다른 형식으로 데이터 준비
      if (chartType === 'candlestick') {
        // 캔들스틱 차트 데이터
        return {
          datasets: [{
            label: selectedStock.name,
            data: filteredHistory.map(h => ({
              x: h.time,
              o: h.open,
              h: h.high,
              l: h.low,
              c: h.close
            })),
            borderColor: (ctx) => {
              const item = ctx.raw || {};
              return item.o < item.c 
                ? 'rgba(214, 48, 49, 1)'  // 상승 - 빨간색 (한국식)
                : 'rgba(9, 132, 227, 1)'; // 하락 - 파란색 (한국식)
            },
            backgroundColor: (ctx) => {
              const item = ctx.raw || {};
              return item.o < item.c 
                ? 'rgba(214, 48, 49, 0.5)'  // 상승 - 빨간색 (한국식)
                : 'rgba(9, 132, 227, 0.5)'; // 하락 - 파란색 (한국식)
            },
            borderWidth: 1,
            barPercentage: 0.8,
            categoryPercentage: 0.8
          }]
        };
      } else {
        // 라인 차트 데이터
        return {
          datasets: [{
            label: selectedStock.name,
            data: filteredHistory.map(h => ({
              x: h.time,
              y: h.close
            })),
            borderColor: 'rgba(21, 101, 192, 1)',
            backgroundColor: 'rgba(21, 101, 192, 0.1)',
            borderWidth: 2,
            tension: 0.1,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 3
          }]
        };
      }
    }
    
    // 기간에 따른 데이터 필터링
    function getFilteredHistory() {
      if (!selectedStock) return [];
      
      const now = new Date();
      
      switch (chartPeriod) {
        case 'day':
          // 최근 1일 데이터 (분봉)
          return [...selectedStock.intradayHistory];
          
        case 'week':
          // 최근 7일 데이터 (일봉)
          const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return selectedStock.yearlyHistory.filter(h => new Date(h.time) > oneWeekAgo);
          
        case 'month':
          // 최근 30일 데이터 (일봉)
          const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          return selectedStock.yearlyHistory.filter(h => new Date(h.time) > oneMonthAgo);
          
        case 'year':
          // 1년 전체 데이터 (일봉)
          return [...selectedStock.yearlyHistory];
          
        default:
          return [...selectedStock.intradayHistory];
      }
    }
    
    // 차트 업데이트 함수
    function updateChart() {
      if (!selectedStock || !stockChart) return;
      
      try {
        // 차트 데이터 업데이트
        const chartData = prepareChartData();
        
        // 데이터 설정
        stockChart.data.datasets[0].data = chartData.datasets[0].data;
        
        // 이동평균선 갱신
        if (activeIndicators.includes('ma')) {
          addMovingAverages();
        }
        
        // 차트 업데이트
        stockChart.update();
        
        // 거래량 차트 처리
        if (activeIndicators.includes('volume')) {
          if (volumeChart) {
            // 기존 거래량 차트 업데이트
            const filteredHistory = getFilteredHistory();
            volumeChart.data.labels = filteredHistory.map(h => h.time);
            volumeChart.data.datasets[0].data = filteredHistory.map(h => ({
              x: h.time,
              y: h.volume
            }));
            volumeChart.update();
          } else {
            // 거래량 차트 생성
            createVolumeChart();
          }
        } else if (volumeChart) {
          // 거래량 차트 제거
          volumeChart.destroy();
          volumeChart = null;
          const volumeCanvas = document.getElementById('volumeChart');
          if (volumeCanvas) {
            volumeCanvas.remove();
          }
        }
      } catch (error) {
        console.error('차트 업데이트 오류:', error);
      }
    }
    
    // ======================================================
    // 9. 거래 관련 함수
    // ======================================================
    
    // 거래 요약 업데이트
    function updateTradeSummary() {
      if (!selectedStock) return;
      
      const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
      const price = selectedStock.currentPrice;
      const fee = Math.round(price * quantity * simulation.settings.taxRate);
      const total = price * quantity + (tradeType === 'buy' ? fee : -fee);
      
      document.getElementById('orderPrice').textContent = formatCurrency(price);
      document.getElementById('orderQuantity').textContent = `${formatNumber(quantity)}주`;
      document.getElementById('orderFee').textContent = formatCurrency(fee);
      document.getElementById('orderTotal').textContent = formatCurrency(total);
      
      // 최대 매수 가능 수량 계산
      const maxBuyable = Math.floor((simulation.portfolio.cash - fee) / price);
      document.getElementById('maxBuyable').textContent = formatNumber(Math.max(0, maxBuyable));
      
      // 수량 슬라이더 범위 업데이트
      updateQuantitySliderRange(maxBuyable);
    }
    
    // 수량 슬라이더 범위 업데이트
    function updateQuantitySliderRange(maxBuyable) {
      const slider = document.getElementById('quantitySlider');
      
      if (tradeType === 'buy') {
        slider.max = maxBuyable;
        slider.value = Math.min(slider.value, maxBuyable);
      } else {
        // 매도의 경우 보유 수량이 최대
        const holding = simulation.portfolio.holdings[selectedStock.symbol];
        const maxSellable = holding ? holding.quantity : 0;
        slider.max = maxSellable;
        slider.value = Math.min(slider.value, maxSellable);
      }
    }
    
    // 수량 슬라이더 값 업데이트
    function updateQuantitySlider() {
      const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
      const slider = document.getElementById('quantitySlider');
      slider.value = Math.min(quantity, slider.max);
    }
    
    // 주문 확인 모달 표시
    function showOrderConfirmation(type, stock, quantity) {
      if (!stock) return;
      
      const price = stock.currentPrice;
      const fee = Math.round(price * quantity * simulation.settings.taxRate);
      const total = price * quantity + (type === 'buy' ? fee : -fee);
      
      // 매수 시 현금 확인
      if (type === 'buy' && simulation.portfolio.cash < total) {
        showNotification('주문 실패', '현금이 부족합니다.', 'error');
        return;
      }
      
      // 매도 시 보유 수량 확인
      if (type === 'sell') {
        const holding = simulation.portfolio.holdings[stock.symbol];
        if (!holding || holding.quantity < quantity) {
          showNotification('주문 실패', '보유 주식이 부족합니다.', 'error');
          return;
        }
      }
      
      // 모달 데이터 설정
      document.getElementById('orderType').textContent = type === 'buy' ? '매수 주문' : '매도 주문';
      document.getElementById('orderType').className = `order-type ${type}`;
      document.getElementById('orderStockName').textContent = `${stock.name} (${stock.symbol})`;
      document.getElementById('confirmOrderPrice').textContent = formatCurrency(price);
      document.getElementById('confirmOrderQuantity').textContent = `${formatNumber(quantity)}주`;
      document.getElementById('confirmOrderFee').textContent = formatCurrency(fee);
      document.getElementById('confirmOrderTotal').textContent = formatCurrency(total);
      
      // 확인 버튼 스타일 변경
      const confirmButton = document.getElementById('orderConfirmButton');
      confirmButton.className = `modal-button ${type === 'buy' ? 'danger' : 'primary'}`;
      
      // 모달 표시
      document.getElementById('orderModal').classList.add('active');
    }
    
    // 주문 실행
    function executeOrder() {
      if (!selectedStock) {
        closeAllModals();
        return;
      }
      
      const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
      
      if (tradeType === 'buy') {
        buyStock(quantity);
      } else {
        sellStock(quantity);
      }
      
      closeAllModals();
    }
    
    // 매수 함수
    function buyStock(quantity) {
      if (!selectedStock) {
        showNotification('주문 실패', '먼저 종목을 선택하세요.', 'error');
        return;
      }
      
      const price = selectedStock.currentPrice;
      const fee = Math.round(price * quantity * simulation.settings.taxRate);
      const total = price * quantity + fee;
      
      // 현금 확인
      if (simulation.portfolio.cash < total) {
        showNotification('주문 실패', '현금이 부족합니다.', 'error');
        return;
      }
      
      // 현재 보유 주식 확인
      const holding = simulation.portfolio.holdings[selectedStock.symbol] || { quantity: 0, avgPrice: 0 };
      
      // 평균 매수 가격 계산
      const newTotalQuantity = holding.quantity + quantity;
      const newTotalCost = (holding.quantity * holding.avgPrice) + (quantity * price);
      const newAvgPrice = newTotalCost / newTotalQuantity;
      
      // 포트폴리오 업데이트
      simulation.portfolio.cash -= total;
      simulation.portfolio.holdings[selectedStock.symbol] = {
        quantity: newTotalQuantity,
        avgPrice: newAvgPrice
      };
      
      // 거래 내역에 추가
      simulation.portfolio.transactions.push({
        time: new Date(),
        symbol: selectedStock.symbol,
        name: selectedStock.name,
        type: 'buy',
        quantity: quantity,
        price: price,
        fee: fee,
        total: total
      });
      
      // UI 업데이트
      updatePortfolioDisplay();
      updateTradeSummary();
      
      showNotification('매수 완료', `${selectedStock.name} ${formatNumber(quantity)}주 매수 완료`, 'success');
    }
    
    // 매도 함수
    function sellStock(quantity) {
      if (!selectedStock) {
        showNotification('주문 실패', '먼저 종목을 선택하세요.', 'error');
        return;
      }
      
      // 보유 주식 확인
      const holding = simulation.portfolio.holdings[selectedStock.symbol];
      if (!holding || holding.quantity < quantity) {
        showNotification('주문 실패', '보유 주식이 부족합니다.', 'error');
        return;
      }
      
      const price = selectedStock.currentPrice;
      const fee = Math.round(price * quantity * simulation.settings.taxRate);
      const total = price * quantity - fee;
      
      // 포트폴리오 업데이트
      simulation.portfolio.cash += total;
      
      if (holding.quantity === quantity) {
        // 전량 매도
        delete simulation.portfolio.holdings[selectedStock.symbol];
      } else {
        // 일부 매도 (평균 가격은 변동 없음)
        simulation.portfolio.holdings[selectedStock.symbol].quantity -= quantity;
      }
      
      // 거래 내역에 추가
      simulation.portfolio.transactions.push({
        time: new Date(),
        symbol: selectedStock.symbol,
        name: selectedStock.name,
        type: 'sell',
        quantity: quantity,
        price: price,
        fee: fee,
        total: total
      });
      
      // UI 업데이트
      updatePortfolioDisplay();
      updateTradeSummary();
      
      showNotification('매도 완료', `${selectedStock.name} ${formatNumber(quantity)}주 매도 완료`, 'success');
    }
    
    // ======================================================
    // 10. 부동산 관련 함수
    // ======================================================
    
    // 부동산 목록 렌더링
    function renderRealEstateList() {
      const list = document.getElementById('realEstateList');
      list.innerHTML = '';
      
      realEstateProperties.forEach(property => {
        const card = document.createElement('div');
        card.className = 'property-card';
        card.dataset.id = property.id;
        
        card.innerHTML = `
          <div class="property-header">
            <div class="property-name">
              ${property.name}
              ${property.owned ? '<span class="property-badge owned">보유중</span>' : ''}
              ${property.premium ? '<span class="property-badge premium">프리미엄</span>' : ''}
            </div>
          </div>
          <div class="property-location">
            <i class="material-icons">location_on</i> ${property.location}
          </div>
          <div class="property-details">
            <div class="property-detail">
              <i class="material-icons">straighten</i> ${property.size}㎡
            </div>
            <div class="property-detail">
              <i class="material-icons">category</i> ${property.typeInfo.name}
            </div>
            <div class="property-detail">
              <i class="material-icons">event</i> ${property.year}년
            </div>
          </div>
          <div class="property-stats">
            <div class="property-price">${formatCurrency(property.price)}</div>
            <div class="property-income">
              <i class="material-icons">payments</i>
              ${formatCurrency(property.netMonthlyIncome)}/월
            </div>
          </div>
        `;
        
        card.addEventListener('click', () => showPropertyDetails(property));
        
        list.appendChild(card);
      });
    }
    
    // 보유 부동산 목록 렌더링
    function renderOwnedProperties() {
      const propertiesList = document.getElementById('propertiesList');
      
      // 보유 부동산 확인
      const ownedProperties = realEstateProperties.filter(p => p.owned);
      
      if (ownedProperties.length === 0) {
        propertiesList.innerHTML = `
          <div class="empty-message">
            보유 중인 부동산이 없습니다.<br>
            부동산 탭에서 자산을 구매해보세요.
          </div>
        `;
        return;
      }
      
      propertiesList.innerHTML = '';
      
      ownedProperties.forEach(property => {
        const item = document.createElement('div');
        item.className = 'holding-item';
        item.dataset.id = property.id;
        
        item.innerHTML = `
          <div class="holding-info">
            <div class="holding-name">${property.name}</div>
            <div class="holding-symbol">${property.location} · ${property.typeInfo.name}</div>
          </div>
          <div class="holding-stats">
            <div class="holding-shares">${property.size}㎡ · ${property.year}년</div>
            <div class="holding-value">${formatCurrency(property.price)}</div>
            <div class="price-change positive">+${formatCurrency(property.netMonthlyIncome)}/월</div>
          </div>
        `;
        
        item.addEventListener('click', () => showPropertyDetails(property));
        
        propertiesList.appendChild(item);
      });
    }
    
    // 부동산 상세 정보 모달 표시
    function showPropertyDetails(property) {
      selectedProperty = property;
      
      // 모달 데이터 설정
      document.getElementById('propertyDetailName').textContent = property.name;
      document.getElementById('propertyDetailPrice').textContent = formatCurrency(property.price);
      document.getElementById('propertyDetailLocation').querySelector('span').textContent = property.location;
      
      document.getElementById('propertySize').textContent = `${property.size}㎡`;
      document.getElementById('propertyType').textContent = property.typeInfo.name;
      document.getElementById('propertyYear').textContent = `${property.year}년`;
      
      document.getElementById('propertyDescription').textContent = property.description;
      
      document.getElementById('propertyPurchasePrice').textContent = formatCurrency(property.price);
      document.getElementById('propertyTaxFees').textContent = formatCurrency(property.taxAndFees);
      document.getElementById('propertyRentalIncome').textContent = formatCurrency(property.monthlyRent);
      document.getElementById('propertyMaintenanceFee').textContent = formatCurrency(property.monthlyMaintenance);
      document.getElementById('propertyNetIncome').textContent = formatCurrency(property.netMonthlyIncome);
      document.getElementById('propertyROI').textContent = `${property.annualReturn.toFixed(2)}%`;
      
      // 버튼 상태 업데이트
      const buyButton = document.getElementById('propertyBuyButton');
      if (property.owned) {
        buyButton.textContent = '매각하기';
        buyButton.className = 'modal-button danger';
      } else {
        buyButton.textContent = '매입하기';
        buyButton.className = 'modal-button primary';
        
        // 구매 가능 여부 확인
        if (simulation.portfolio.cash < property.totalCost) {
          buyButton.disabled = true;
          buyButton.textContent = '자금 부족';
        } else {
          buyButton.disabled = false;
        }
      }
      
      // 모달 표시
      document.getElementById('propertyModal').classList.add('active');
    }
    
    // 부동산 매입/매각
    function purchaseProperty() {
      if (!selectedProperty) {
        closeAllModals();
        return;
      }
      
      if (selectedProperty.owned) {
        // 매각 로직
        const salePrice = Math.round(selectedProperty.price * 0.95); // 5% 수수료
        
        simulation.portfolio.cash += salePrice;
        
        // 부동산 소유 상태 변경
        selectedProperty.owned = false;
        
        // 포트폴리오에서 제거
        delete simulation.portfolio.properties[selectedProperty.id];
        
        // 거래 내역에 추가
        simulation.portfolio.transactions.push({
          time: new Date(),
          type: 'property_sell',
          id: selectedProperty.id,
          name: selectedProperty.name,
          price: salePrice
        });
        
        showNotification('매각 완료', `${selectedProperty.name} 매각이 완료되었습니다. (+${formatCurrency(salePrice)})`, 'success');
      } else {
        // 매입 로직
        const totalCost = selectedProperty.totalCost;
        
        // 현금 확인
        if (simulation.portfolio.cash < totalCost) {
          showNotification('매입 실패', '자금이 부족합니다.', 'error');
          closeAllModals();
          return;
        }
        
        // 현금 차감
        simulation.portfolio.cash -= totalCost;
        
        // 부동산 소유 상태 변경
        selectedProperty.owned = true;
        
        // 포트폴리오에 추가
        simulation.portfolio.properties[selectedProperty.id] = {
          id: selectedProperty.id,
          purchaseDate: new Date(),
          purchasePrice: selectedProperty.price,
          taxAndFees: selectedProperty.taxAndFees,
          monthlyIncome: selectedProperty.netMonthlyIncome
        };
        
        // 거래 내역에 추가
        simulation.portfolio.transactions.push({
          time: new Date(),
          type: 'property_buy',
          id: selectedProperty.id,
          name: selectedProperty.name,
          price: totalCost
        });
        
        showNotification('매입 완료', `${selectedProperty.name} 매입이 완료되었습니다. (-${formatCurrency(totalCost)})`, 'success');
      }
      
      // UI 업데이트
      updatePortfolioDisplay();
      renderRealEstateList();
      renderOwnedProperties();
      
      closeAllModals();
    }
    
    // 부동산 수입 계산 (일일)
    function calculateRealEstateIncome() {
      let dailyIncome = 0;
      
      // 보유 부동산 확인
      Object.values(simulation.portfolio.properties).forEach(property => {
        const realEstate = realEstateProperties.find(p => p.id === property.id);
        if (realEstate) {
          // 월 수입을 일일 수입으로 변환 (30일 기준)
          dailyIncome += Math.round(realEstate.netMonthlyIncome / 30);
        }
      });
      
      return dailyIncome;
    }
    
    // ======================================================
    // 11. 대출 관련 함수
    // ======================================================
    
    // 대출 상품 렌더링
    function renderLoanProducts() {
      const productsContainer = document.getElementById('loanProducts');
      productsContainer.innerHTML = '';
      
      loanProducts.forEach(product => {
        const item = document.createElement('div');
        item.className = 'loan-product';
        item.dataset.id = product.id;
        
        item.innerHTML = `
          <div class="loan-product-header">
            <div class="loan-product-name">${product.name}</div>
            <div class="loan-product-rate">연 ${(product.interestRate * 100).toFixed(2)}%</div>
          </div>
          <div class="loan-product-description">${product.description}</div>
          <div class="loan-product-footer">
            <div class="loan-product-terms">${formatCurrency(product.minAmount)} ~ ${formatCurrency(product.maxAmount)}</div>
            <button class="loan-product-action">신청하기</button>
          </div>
        `;
        
        item.querySelector('.loan-product-action').addEventListener('click', () => {
          showLoanApplication(product);
        });
        
        productsContainer.appendChild(item);
      });
    }
    
    // 진행 중인 대출 렌더링
    function renderActiveLoans() {
      const loansContainer = document.getElementById('activeLoans');
      
      // 진행 중인 대출 확인
      const activeLoans = Object.values(simulation.portfolio.loans);
      
      if (activeLoans.length === 0) {
        loansContainer.innerHTML = `
          <div class="empty-message">
            진행 중인 대출이 없습니다.
          </div>
        `;
        return;
      }
      
      loansContainer.innerHTML = '';
      
      activeLoans.forEach(loan => {
        const product = loanProducts.find(p => p.id === loan.productId);
        
        if (!product) return;
        
        const item = document.createElement('div');
        item.className = 'loan-item';
        item.dataset.id = loan.id;
        
        // 남은 원금 계산
        const remainingPrincipal = loan.remainingAmount;
        
        // 다음 상환일
        const nextPaymentDate = new Date(loan.nextPaymentDate);
        const formattedDate = `${nextPaymentDate.getMonth() + 1}월 ${nextPaymentDate.getDate()}일`;
        
        item.innerHTML = `
          <div class="loan-item-header">
            <div class="loan-item-name">${product.name}</div>
            <div class="loan-item-amount">${formatCurrency(remainingPrincipal)}</div>
          </div>
          <div class="loan-item-details">
            대출일: ${formatDate(loan.startDate)} / 만기일: ${formatDate(loan.endDate)} / 금리: 연 ${(loan.interestRate * 100).toFixed(2)}%
          </div>
          <div class="loan-item-footer">
            <div class="loan-item-payment">
              월 상환액: ${formatCurrency(loan.monthlyPayment)}
              <span class="loan-item-next">(다음 상환: ${formattedDate})</span>
            </div>
            <button class="loan-item-action">상환하기</button>
          </div>
        `;
        
        item.querySelector('.loan-item-action').addEventListener('click', () => {
          showLoanRepayment(loan);
        });
        
        loansContainer.appendChild(item);
      });
    }
    
    // 대출 신청 모달 표시
    function showLoanApplication(product) {
      selectedLoan = product;
      
      // 모달 데이터 설정
      document.getElementById('loanTitle').textContent = '대출 신청';
      document.getElementById('loanProductName').textContent = product.name;
      document.getElementById('loanProductDescription').textContent = product.description;
      
      // 대출 금액 범위 설정
      document.getElementById('minLoanAmount').textContent = formatCurrency(product.minAmount);
      document.getElementById('maxLoanAmount').textContent = formatCurrency(product.maxAmount);
      
      // 기본 값 설정
      document.getElementById('loanAmount').value = formatCurrency(product.minAmount);
      document.getElementById('loanAmountSlider').value = 0;
      
      // 대출 기간 옵션 생성
      const termOptions = document.getElementById('loanTermOptions');
      termOptions.innerHTML = '';
      
      product.terms.forEach((term, index) => {
        const option = document.createElement('div');
        option.className = `loan-term-option ${index === Math.min(2, product.terms.length - 1) ? 'active' : ''}`;
        option.dataset.term = term;
        option.textContent = `${term}개월`;
        
        option.addEventListener('click', function() {
          document.querySelectorAll('.loan-term-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          calculateLoan();
        });
        
        termOptions.appendChild(option);
      });
      
      // 초기 계산
      calculateLoan();
      
      // 모달 표시
      document.getElementById('loanModal').classList.add('active');
    }
    
    // 대출 계산
    function calculateLoan() {
      if (!selectedLoan) return;
      
      // 대출 금액 가져오기
      const amountInput = document.getElementById('loanAmount').value;
      const amount = parseFloat(amountInput.replace(/[^\d.-]/g, '')) || selectedLoan.minAmount;
      
      // 대출 기간 가져오기
      const activeTermOption = document.querySelector('.loan-term-option.active');
      const term = parseInt(activeTermOption.dataset.term) || 24;
      
      // 이자율
      const interestRate = selectedLoan.interestRate;
      
      // 월 이자율
      const monthlyRate = interestRate / 12;
      
      // 월 상환액 계산 (원리금균등상환 방식)
      const monthlyPayment = amount * monthlyRate * Math.pow(1 + monthlyRate, term) / (Math.pow(1 + monthlyRate, term) - 1);
      
      // 총 이자 계산
      const totalInterest = (monthlyPayment * term) - amount;
      
      // 총 상환액
      const totalPayment = amount + totalInterest;
      
      // 결과 표시
      document.getElementById('loanSummaryAmount').textContent = formatCurrency(amount);
      document.getElementById('loanSummaryTerm').textContent = `${term}개월`;
      document.getElementById('loanSummaryRate').textContent = `${(interestRate * 100).toFixed(2)}%`;
      document.getElementById('loanSummaryInterest').textContent = formatCurrency(totalInterest);
      document.getElementById('loanSummaryMonthly').textContent = formatCurrency(monthlyPayment);
      document.getElementById('loanSummaryTotal').textContent = formatCurrency(totalPayment);
    }
    
    // 대출 신청 처리
    function applyForLoan() {
      if (!selectedLoan) {
        closeAllModals();
        return;
      }
      
      // 대출 금액 가져오기
      const amountInput = document.getElementById('loanAmount').value;
      const amount = parseFloat(amountInput.replace(/[^\d.-]/g, '')) || selectedLoan.minAmount;
      
      // 대출 기간 가져오기
      const activeTermOption = document.querySelector('.loan-term-option.active');
      const term = parseInt(activeTermOption.dataset.term) || 24;
      
      // 한도 체크
      if (amount < selectedLoan.minAmount || amount > selectedLoan.maxAmount) {
        showNotification('신청 실패', `대출 금액은 ${formatCurrency(selectedLoan.minAmount)}에서 ${formatCurrency(selectedLoan.maxAmount)} 사이여야 합니다.`, 'error');
        return;
      }
      
      // 현재 부채 총액 계산
      const currentDebt = calculateTotalDebt();
      
      // 대출 한도 체크
      if (currentDebt + amount > simulation.settings.loanLimit) {
        showNotification('신청 실패', `대출 한도 ${formatCurrency(simulation.settings.loanLimit)}을 초과합니다.`, 'error');
        return;
      }
      
      // 이자율
      const interestRate = selectedLoan.interestRate;
      
      // 월 이자율
      const monthlyRate = interestRate / 12;
      
      // 월 상환액 계산 (원리금균등상환 방식)
      const monthlyPayment = amount * monthlyRate * Math.pow(1 + monthlyRate, term) / (Math.pow(1 + monthlyRate, term) - 1);
      
      // 시작일, 종료일, 다음 상환일 계산
      const startDate = new Date();
      const endDate = new Date();
      endDate.setMonth(endDate.getMonth() + term);
      
      const nextPaymentDate = new Date();
      nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
      
      // 대출 ID 생성
      const loanId = `loan_${Date.now()}`;
      
      // 대출 객체 생성
      const loan = {
        id: loanId,
        productId: selectedLoan.id,
        amount: amount,
        remainingAmount: amount,
        interestRate: interestRate,
        term: term,
        monthlyPayment: monthlyPayment,
        startDate: startDate,
        endDate: endDate,
        nextPaymentDate: nextPaymentDate,
        payments: [],
        status: 'active'
      };
      
      // 포트폴리오에 추가
      simulation.portfolio.loans[loanId] = loan;
      
      // 현금 증가
      simulation.portfolio.cash += amount;
      
      // 거래 내역에 추가
      simulation.portfolio.transactions.push({
        time: new Date(),
        type: 'loan',
        id: loanId,
        productName: selectedLoan.name,
        amount: amount,
        term: term
      });
      
      // UI 업데이트
      updatePortfolioDisplay();
      updateLoanDisplay();
      renderActiveLoans();
      
      showNotification('대출 완료', `${formatCurrency(amount)}의 대출이 승인되었습니다.`, 'success');
      
      closeAllModals();
    }
    
    // 대출 상환 모달 표시
    function showLoanRepayment(loan) {
      selectedRepayLoan = loan;
      
      // 대출 상품 정보 가져오기
      const product = loanProducts.find(p => p.id === loan.productId);
      
      if (!product) {
        closeAllModals();
        return;
      }
      
      // 모달 데이터 설정
      document.getElementById('repayLoanName').textContent = product.name;
      
      // 남은 원금
      const remainingPrincipal = loan.remainingAmount;
      document.getElementById('repayRemainingPrincipal').textContent = formatCurrency(remainingPrincipal);
      
      // 남은 이자 (대략적인 계산)
      const remainingMonths = Math.ceil((new Date(loan.endDate) - new Date()) / (30 * 24 * 60 * 60 * 1000));
      const totalRemainingPayments = loan.monthlyPayment * remainingMonths;
      const remainingInterest = totalRemainingPayments - remainingPrincipal;
      document.getElementById('repayRemainingInterest').textContent = formatCurrency(Math.max(0, remainingInterest));
      
      // 조기 상환 수수료
      const earlyRepaymentFee = Math.round(remainingPrincipal * product.earlyRepaymentFee);
      document.getElementById('repayEarlyFee').textContent = formatCurrency(earlyRepaymentFee);
      
      // 총 상환액
      const totalRepayment = remainingPrincipal + earlyRepaymentFee;
      document.getElementById('repayTotal').textContent = formatCurrency(totalRepayment);
      
      // 경고 메시지
      const repayWarning = document.getElementById('repayWarning');
      if (simulation.portfolio.cash < totalRepayment) {
        repayWarning.style.display = 'flex';
        document.getElementById('repayButton').disabled = true;
      } else {
        repayWarning.style.display = 'none';
        document.getElementById('repayButton').disabled = false;
      }
      
      // 모달 표시
      document.getElementById('repayModal').classList.add('active');
    }
    
    // 대출 상환 처리
    function repayLoan() {
      if (!selectedRepayLoan) {
        closeAllModals();
        return;
      }
      
      // 대출 상품 정보 가져오기
      const product = loanProducts.find(p => p.id === selectedRepayLoan.productId);
      
      if (!product) {
        closeAllModals();
        return;
      }
      
      // 남은 원금
      const remainingPrincipal = selectedRepayLoan.remainingAmount;
      
      // 조기 상환 수수료
      const earlyRepaymentFee = Math.round(remainingPrincipal * product.earlyRepaymentFee);
      
      // 총 상환액
      const totalRepayment = remainingPrincipal + earlyRepaymentFee;
      
      // 현금 확인
      if (simulation.portfolio.cash < totalRepayment) {
        showNotification('상환 실패', '현금이 부족합니다.', 'error');
        closeAllModals();
        return;
      }
      
      // 현금 차감
      simulation.portfolio.cash -= totalRepayment;
      
      // 대출 제거
      delete simulation.portfolio.loans[selectedRepayLoan.id];
      
      // 거래 내역에 추가
      simulation.portfolio.transactions.push({
        time: new Date(),
        type: 'loan_repayment',
        id: selectedRepayLoan.id,
        productName: product.name,
        principal: remainingPrincipal,
        fee: earlyRepaymentFee,
        total: totalRepayment
      });
      
      // UI 업데이트
      updatePortfolioDisplay();
      updateLoanDisplay();
      renderActiveLoans();
      
      showNotification('상환 완료', `대출이 성공적으로 상환되었습니다. (-${formatCurrency(totalRepayment)})`, 'success');
      
      closeAllModals();
    }
    
    // 대출 정보 업데이트
    function updateLoanDisplay() {
      // 총 부채 계산
      const totalDebt = calculateTotalDebt();
      
      // 총 월 상환액 계산
      const totalMonthlyPayment = calculateTotalMonthlyPayment();
      
      // 다음 상환일 찾기
      const nextPaymentDate = findNextPaymentDate();
      
      // UI 업데이트
      document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
      document.getElementById('totalMonthlyPayment').textContent = formatCurrency(totalMonthlyPayment);
      document.getElementById('nextPaymentDate').textContent = nextPaymentDate ? formatDate(nextPaymentDate) : '-';
      
      // 부채 비율 계산 (한도 대비)
      const debtRatio = totalDebt / simulation.settings.loanLimit;
      const progressBar = document.getElementById('debtProgressBar').querySelector('.loan-progress-bar');
      progressBar.style.width = `${Math.min(100, debtRatio * 100)}%`;
      
      // 부채 비율에 따른 클래스 변경
      if (debtRatio < 0.5) {
        progressBar.className = 'loan-progress-bar loan-safe';
      } else if (debtRatio < 0.8) {
        progressBar.className = 'loan-progress-bar loan-warn';
      } else {
        progressBar.className = 'loan-progress-bar loan-danger';
      }
      
      // 경고 메시지 표시
      const loanWarning = document.getElementById('loanWarning');
      if (debtRatio > 0.7) {
        loanWarning.style.display = 'flex';
      } else {
        loanWarning.style.display = 'none';
      }
      
      // 알림 배지 표시
      const loanAlert = document.getElementById('loanAlert');
      if (debtRatio > 0.9) {
        loanAlert.style.display = 'flex';
      } else {
        loanAlert.style.display = 'none';
      }
    }
    
    // 총 부채 계산
    function calculateTotalDebt() {
      let totalDebt = 0;
      
      Object.values(simulation.portfolio.loans).forEach(loan => {
        totalDebt += loan.remainingAmount;
      });
      
      return totalDebt;
    }
    
    // 총 월 상환액 계산
    function calculateTotalMonthlyPayment() {
      let totalMonthlyPayment = 0;
      
      Object.values(simulation.portfolio.loans).forEach(loan => {
        totalMonthlyPayment += loan.monthlyPayment;
      });
      
      return totalMonthlyPayment;
    }
    
    // 다음 상환일 찾기
    function findNextPaymentDate() {
      let nextDate = null;
      
      Object.values(simulation.portfolio.loans).forEach(loan => {
        const paymentDate = new Date(loan.nextPaymentDate);
        
        if (!nextDate || paymentDate < nextDate) {
          nextDate = paymentDate;
        }
      });
      
      return nextDate;
    }
    
    // 대출 이자 및 상환 처리 (일별)
    function processLoans() {
      const today = new Date(simulation.currentDate);
      const loans = Object.values(simulation.portfolio.loans);
      
      if (loans.length === 0) return;
      
      let totalPaymentsDue = 0;
      
      loans.forEach(loan => {
        const nextPaymentDate = new Date(loan.nextPaymentDate);
        
        // 상환일이 되었는지 확인
        if (isSameDay(today, nextPaymentDate)) {
          // 상환액 계산
          const paymentAmount = loan.monthlyPayment;
          totalPaymentsDue += paymentAmount;
          
          // 현금 확인
          if (simulation.portfolio.cash >= paymentAmount) {
            // 현금 차감
            simulation.portfolio.cash -= paymentAmount;
            
            // 원금 상환 계산 (이자 제외)
            const monthlyRate = loan.interestRate / 12;
            const interestPayment = loan.remainingAmount * monthlyRate;
            const principalPayment = paymentAmount - interestPayment;
            
            // 남은 원금 업데이트
            loan.remainingAmount -= principalPayment;
            
            // 남은 원금이 0이거나 작으면 대출 종료
            if (loan.remainingAmount <= 0) {
              loan.remainingAmount = 0;
              loan.status = 'completed';
              
              // 대출 제거
              delete simulation.portfolio.loans[loan.id];
              
              showNotification('대출 완료', `${loan.productId} 대출이 완전히 상환되었습니다.`, 'info');
            } else {
              // 다음 상환일 업데이트
              const nextDate = new Date(nextPaymentDate);
              nextDate.setMonth(nextDate.getMonth() + 1);
              loan.nextPaymentDate = nextDate;
              
              // 상환 기록 추가
              loan.payments.push({
                date: today,
                amount: paymentAmount,
                principal: principalPayment,
                interest: interestPayment
              });
            }
          } else {
            // 연체 처리
            loan.status = 'overdue';
            
            // 연체 이자 추가 (일별 연체 이자는 연이자의 1/365)
            const dailyPenaltyRate = simulation.settings.interestPenalty / 365;
            const penaltyAmount = loan.remainingAmount * dailyPenaltyRate;
            
            // 원금에 연체 이자 추가
            loan.remainingAmount += penaltyAmount;
            
            // 다음 상환일은 내일로 설정 (매일 시도)
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            loan.nextPaymentDate = tomorrow;
            
            showNotification('대출 연체', `${loan.productId} 대출 상환액이 부족하여 연체되었습니다. 연체 이자가 발생합니다.`, 'warning');
            
            // 파산 체크
            if (loan.remainingAmount > simulation.settings.bankruptcyThreshold) {
              declareBankruptcy();
              return;
            }
          }
        }
      });
      
      // 상환액이 있었다면 UI 업데이트
      if (totalPaymentsDue > 0) {
        updateLoanDisplay();
        renderActiveLoans();
        updatePortfolioDisplay();
      }
    }
    
    // 파산 선고
    function declareBankruptcy() {
      simulation.gameOver = true;
      
      // 자산 가치 계산
      const totalAssets = calculateTotalAssets();
      const totalDebt = calculateTotalDebt();
      const netWorth = totalAssets - totalDebt;
      
      // 모달 데이터 설정
      document.getElementById('bankruptcyTotalAssets').textContent = formatCurrency(totalAssets);
      document.getElementById('bankruptcyTotalDebt').textContent = formatCurrency(totalDebt);
      document.getElementById('bankruptcyNetWorth').textContent = formatCurrency(netWorth);
      
      // 모달 표시
      document.getElementById('bankruptcyModal').classList.add('active');
      
      showNotification('파산', '대출금 한도를 초과하여 파산이 선고되었습니다.', 'error');
    }
    
    // 새 게임 시작
    function restartSimulation() {
      // 페이지 새로고침
      location.reload();
    }
    
    // ======================================================
    // 12. 뉴스 관련 함수
    // ======================================================
    
    // 뉴스 목록 렌더링
    function renderNewsItems() {
      const newsList = document.getElementById('newsList');
      newsList.innerHTML = '';
      
      // 뉴스 정렬 (최신순)
      const sortedNews = [...simulation.news.articles].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // 필터 적용
      const searchTerm = document.getElementById('newsSearch').value.toLowerCase();
      const filterType = document.getElementById('newsFilter').value;
      
      const filteredNews = sortedNews.filter(news => {
        // 검색어 필터
        const matchesSearch = searchTerm === '' || 
          news.headline.toLowerCase().includes(searchTerm) || 
          news.content.toLowerCase().includes(searchTerm);
        
        // 타입 필터
        const matchesType = filterType === 'all' || news.type.startsWith(filterType);
        
        return matchesSearch && matchesType;
      });
      
      if (filteredNews.length === 0) {
        newsList.innerHTML = `
          <div class="empty-message">
            조건에 맞는 뉴스가 없습니다.
          </div>
        `;
        return;
      }
      
      filteredNews.forEach(news => {
        const item = document.createElement('div');
        item.className = `holding-item ${news.read ? '' : 'unread'}`;
        item.dataset.id = news.id;
        
        // 뉴스 타입과 영향력에 따른 아이콘 및 색상
        let icon, typeClass;
        if (news.type.includes('positive') || news.impact > 0) {
          icon = 'trending_up';
          typeClass = 'positive';
        } else if (news.type.includes('negative') || news.impact < 0) {
          icon = 'trending_down';
          typeClass = 'negative';
        } else {
          icon = 'fiber_new';
          typeClass = '';
        }
        
        item.innerHTML = `
          <div class="holding-info">
            <div class="holding-name">${news.headline}</div>
            <div class="holding-symbol">${formatDate(new Date(news.date))} · ${getNewsTypeText(news.type)}</div>
          </div>
          <div class="holding-stats">
            <div class="price-change ${typeClass}">
              <i class="material-icons">${icon}</i>
              ${formatImpact(news.impact)}
            </div>
          </div>
        `;
        
        item.addEventListener('click', () => {
          showNewsDetails(news);
          markNewsAsRead(news.id);
        });
        
        newsList.appendChild(item);
      });
    }
    
    // 뉴스 타입 텍스트 변환
    function getNewsTypeText(type) {
      if (type.includes('positive')) {
        return '긍정적';
      } else if (type.includes('negative')) {
        return '부정적';
      } else if (type.includes('sector')) {
        return '산업';
      } else if (type.includes('global')) {
        return '글로벌';
      } else {
        return '일반';
      }
    }
    
    // 뉴스 영향력 포맷
    function formatImpact(impact) {
      if (impact > 0) {
        return `+${(impact * 100).toFixed(1)}%`;
      } else if (impact < 0) {
        return `${(impact * 100).toFixed(1)}%`;
      } else {
        return '0%';
      }
    }
    
    // 뉴스 상세 정보 모달 표시
    function showNewsDetails(news) {
      selectedNews = news;
      
      // 모달 데이터 설정
      document.getElementById('newsTitle').textContent = news.headline;
      document.getElementById('newsDate').textContent = formatDate(new Date(news.date));
      
      // 뉴스 영향력 클래스
      const impactElement = document.getElementById('newsImpact');
      if (news.impact > 0) {
        impactElement.textContent = `긍정적 영향: +${(news.impact * 100).toFixed(1)}%`;
        impactElement.className = 'news-impact positive';
      } else if (news.impact < 0) {
        impactElement.textContent = `부정적 영향: ${(news.impact * 100).toFixed(1)}%`;
        impactElement.className = 'news-impact negative';
      } else {
        impactElement.textContent = '중립적';
        impactElement.className = 'news-impact neutral';
      }
      
      // 뉴스 내용
      document.getElementById('newsBody').textContent = news.content;
      
      // 영향 받는 종목 목록
      const affectedStocks = document.getElementById('affectedStocks');
      affectedStocks.innerHTML = '';
      
      if (news.affectedStocks === 'all') {
        // 모든 종목에 영향
        const item = document.createElement('div');
        item.className = 'affected-stock';
        item.innerHTML = `
          <div class="affected-stock-name">모든 종목</div>
          <div class="affected-stock-impact ${news.impact >= 0 ? 'positive' : 'negative'}">${formatImpact(news.impact)}</div>
        `;
        affectedStocks.appendChild(item);
      } else if (Array.isArray(news.affectedStocks)) {
        // 특정 종목에 영향
        news.affectedStocks.forEach(affected => {
          const stock = stocks.find(s => s.symbol === affected.symbol);
          
          if (!stock) return;
          
          const item = document.createElement('div');
          item.className = 'affected-stock';
          item.innerHTML = `
            <div class="affected-stock-name">${stock.name} (${stock.symbol})</div>
            <div class="affected-stock-impact ${affected.impact >= 0 ? 'positive' : 'negative'}">${formatImpact(affected.impact)}</div>
          `;
          
          item.addEventListener('click', () => {
            selectStock(stock.symbol);
            closeAllModals();
          });
          
          affectedStocks.appendChild(item);
        });
      } else {
        // 영향 받는 종목 없음
        affectedStocks.innerHTML = `
          <div class="empty-message">
            영향 받는 종목이 없습니다.
          </div>
        `;
      }
      
      // 모달 표시
      document.getElementById('newsModal').classList.add('active');
    }
    
    // 뉴스를 읽은 것으로 표시
    function markNewsAsRead(newsId) {
      const newsItem = simulation.news.articles.find(n => n.id === newsId);
      if (newsItem && !newsItem.read) {
        newsItem.read = true;
        
        // 읽지 않은 뉴스 수 감소
        simulation.news.unread = Math.max(0, simulation.news.unread - 1);
        
        // 뉴스 알림 배지 업데이트
        const newsAlert = document.getElementById('newsAlert');
        if (simulation.news.unread > 0) {
          newsAlert.style.display = 'flex';
          newsAlert.textContent = simulation.news.unread > 9 ? '9+' : simulation.news.unread;
        } else {
          newsAlert.style.display = 'none';
        }
      }
    }
    
    // 새 뉴스 생성
    function generateNews(count = 1) {
      const newArticles = [];
      
      for (let i = 0; i < count; i++) {
        // 랜덤 뉴스 이벤트 선택
        const randomEvent = newsEvents[Math.floor(Math.random() * newsEvents.length)];
        
        // 뉴스 기사 생성
        const article = generateNewsArticle(randomEvent);
        
        // 뉴스 목록에 추가
        simulation.news.articles.push(article);
        newArticles.push(article);
        
        // 읽지 않은 뉴스 수 증가
        simulation.news.unread++;
        
        // 종목 가격에 영향 적용
        applyNewsImpact(article);
      }
      
      // 최대 뉴스 개수 제한
      if (simulation.news.articles.length > MAX_HISTORY) {
        simulation.news.articles = simulation.news.articles.slice(-MAX_HISTORY);
      }
      
      // 뉴스 알림 배지 업데이트
      const newsAlert = document.getElementById('newsAlert');
      if (simulation.news.unread > 0) {
        newsAlert.style.display = 'flex';
        newsAlert.textContent = simulation.news.unread > 9 ? '9+' : simulation.news.unread;
      }
      
      // 뉴스 티커 업데이트
      updateNewsTicker();
      
      // 뉴스 목록 업데이트 (뉴스 탭이 활성화된 경우)
      if (activeContent === 'news') {
        renderNewsItems();
      }
      
      return newArticles;
    }
    
    // 뉴스가 주식 가격에 미치는 영향 적용
    function applyNewsImpact(news) {
      if (!news) return;
      
      // 모든 주식에 영향을 미치는 경우
      if (news.affectedStocks === 'all') {
        stocks.forEach(stock => {
          // 랜덤 변동 요소 추가 (뉴스 영향의 +/-50% 범위)
          const randomFactor = 1 + (Math.random() - 0.5) * Math.abs(news.impact);
          const impact = news.impact * randomFactor;
          
          // 가격 변동 적용
          updateStockPrice(stock, impact);
        });
      } 
      // 특정 주식에만 영향을 미치는 경우
      else if (Array.isArray(news.affectedStocks)) {
        news.affectedStocks.forEach(affected => {
          const stock = stocks.find(s => s.symbol === affected.symbol);
          
          if (stock) {
            // 랜덤 변동 요소 추가
            const randomFactor = 1 + (Math.random() - 0.5) * 0.5;
            const impact = affected.impact * randomFactor;
            
            // 가격 변동 적용
            updateStockPrice(stock, impact);
          }
        });
      }
    }
    
    // 뉴스 티커 업데이트
    function updateNewsTicker() {
      const ticker = document.getElementById('newsTicker');
      ticker.innerHTML = '';
      
      // 최신 뉴스 10개 선택
      const recentNews = [...simulation.news.articles]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);
      
      recentNews.forEach(news => {
        const item = document.createElement('div');
        item.className = `news-ticker-item ${news.impact > 0 ? 'positive' : news.impact < 0 ? 'negative' : ''}`;
        
        const icon = news.impact > 0 ? 'trending_up' : news.impact < 0 ? 'trending_down' : 'fiber_new';
        
        item.innerHTML = `
          <i class="material-icons">${icon}</i>
          ${news.headline}
          <span class="news-ticker-time">${formatTime(new Date(news.date))}</span>
        `;
        
        item.addEventListener('click', () => {
          showNewsDetails(news);
          markNewsAsRead(news.id);
        });
        
        ticker.appendChild(item);
      });
    }
    
    // ======================================================
    // 13. 시장 업데이트 함수
    // ======================================================
    
    // 주식 가격 업데이트
    function updateStockPrice(stock, impactFactor = 0) {
      if (!stock) return;
      
      // 기본 변동성 (무작위)
      const randomChange = (Math.random() - 0.5) * 2 * PRICE_VOLATILITY;
      
      // 뉴스/이벤트 영향 적용
      const totalChange = randomChange + impactFactor;
      
      // 가격 변동 적용 (최소 가격은 100원)
      const oldPrice = stock.currentPrice;
      stock.currentPrice = Math.max(100, Math.round(stock.currentPrice * (1 + totalChange)));
      
      // 당일 고가/저가 업데이트
      stock.dayHigh = Math.max(stock.dayHigh, stock.currentPrice);
      stock.dayLow = Math.min(stock.dayLow, stock.currentPrice);
      
      // 거래량 업데이트 (변동폭에 비례)
      const volumeChange = Math.floor(Math.random() * 5000) + Math.abs(totalChange) * 50000;
      stock.volume += volumeChange;
      
      // 분봉 데이터에 추가
      const now = new Date();
      if (stock.intradayHistory.length > 0) {
        const lastEntry = stock.intradayHistory[stock.intradayHistory.length - 1];
        const lastTime = new Date(lastEntry.time);
        
        // 같은 시간대면 업데이트, 다른 시간대면 새 항목 추가
        if (now.getHours() === lastTime.getHours() && now.getMinutes() === lastTime.getMinutes()) {
          lastEntry.close = stock.currentPrice;
          lastEntry.high = Math.max(lastEntry.high, stock.currentPrice);
          lastEntry.low = Math.min(lastEntry.low, stock.currentPrice);
          lastEntry.volume += volumeChange;
        } else {
          stock.intradayHistory.push({
            time: now,
            open: oldPrice,
            high: Math.max(oldPrice, stock.currentPrice),
            low: Math.min(oldPrice, stock.currentPrice),
            close: stock.currentPrice,
            volume: volumeChange
          });
          
          // 최대 기록 개수 제한
          if (stock.intradayHistory.length > MAX_HISTORY) {
            stock.intradayHistory = stock.intradayHistory.slice(-MAX_HISTORY);
          }
        }
      } else {
        // 기록이 없으면 새로 추가
        stock.intradayHistory.push({
          time: now,
          open: oldPrice,
          high: Math.max(oldPrice, stock.currentPrice),
          low: Math.min(oldPrice, stock.currentPrice),
          close: stock.currentPrice,
          volume: volumeChange
        });
      }
      
      // 현재 선택된 주식이면 UI 업데이트
      if (selectedStock && selectedStock.symbol === stock.symbol) {
        updateSelectedStockPrice();
        updateChartInfo();
        
        // 거래 패널 업데이트
        document.getElementById('tradePrice').value = formatCurrency(stock.currentPrice);
        updateTradeSummary();
        
        // 차트 업데이트 (차트가 있는 경우)
        if (stockChart) {
          updateChart();
        }
      }
    }
    
    // 시장 지수 업데이트
    function updateMarketIndices() {
      // KOSPI 지수 업데이트
      const kospiChange = (Math.random() - 0.48) * 0.01; // 약간 상승 경향
      simulation.marketIndices.kospi.prevClose = simulation.marketIndices.kospi.value;
      simulation.marketIndices.kospi.value = Math.round(simulation.marketIndices.kospi.value * (1 + kospiChange) * 100) / 100;
      simulation.marketIndices.kospi.change = (simulation.marketIndices.kospi.value / simulation.marketIndices.kospi.prevClose - 1) * 100;
      
      // KOSDAQ 지수 업데이트
      const kosdaqChange = (Math.random() - 0.48) * 0.012; // 약간 상승 경향, 더 큰 변동성
      simulation.marketIndices.kosdaq.prevClose = simulation.marketIndices.kosdaq.value;
      simulation.marketIndices.kosdaq.value = Math.round(simulation.marketIndices.kosdaq.value * (1 + kosdaqChange) * 100) / 100;
      simulation.marketIndices.kosdaq.change = (simulation.marketIndices.kosdaq.value / simulation.marketIndices.kosdaq.prevClose - 1) * 100;
      
      // USD/KRW 환율 업데이트
      const usdkrwChange = (Math.random() - 0.5) * 0.006; // 중립적 경향
      simulation.marketIndices.usdkrw.prevClose = simulation.marketIndices.usdkrw.value;
      simulation.marketIndices.usdkrw.value = Math.round(simulation.marketIndices.usdkrw.value * (1 + usdkrwChange) * 100) / 100;
      simulation.marketIndices.usdkrw.change = (simulation.marketIndices.usdkrw.value / simulation.marketIndices.usdkrw.prevClose - 1) * 100;
      
      // UI 업데이트
      updateMarketIndicesDisplay();
    }
    
    // 시장 지수 UI 업데이트
    function updateMarketIndicesDisplay() {
      // KOSPI
      const kospiValue = document.getElementById('kospi-index');
      kospiValue.innerHTML = `
        ${simulation.marketIndices.kospi.value.toFixed(2)} 
        <span class="price-change ${simulation.marketIndices.kospi.change >= 0 ? 'positive' : 'negative'}">
          ${simulation.marketIndices.kospi.change >= 0 ? '+' : ''}${simulation.marketIndices.kospi.change.toFixed(2)}%
        </span>
      `;
      
      // KOSDAQ
      const kosdaqValue = document.getElementById('kosdaq-index');
      kosdaqValue.innerHTML = `
        ${simulation.marketIndices.kosdaq.value.toFixed(2)} 
        <span class="price-change ${simulation.marketIndices.kosdaq.change >= 0 ? 'positive' : 'negative'}">
          ${simulation.marketIndices.kosdaq.change >= 0 ? '+' : ''}${simulation.marketIndices.kosdaq.change.toFixed(2)}%
        </span>
      `;
      
      // USD/KRW
      const usdkrwValue = document.getElementById('usd-krw');
      usdkrwValue.innerHTML = `
        ${simulation.marketIndices.usdkrw.value.toFixed(2)} 
        <span class="price-change ${simulation.marketIndices.usdkrw.change >= 0 ? 'positive' : 'negative'}">
          ${simulation.marketIndices.usdkrw.change >= 0 ? '+' : ''}${simulation.marketIndices.usdkrw.change.toFixed(2)}%
        </span>
      `;
    }
    
    // 일일 시장 업데이트 (장 마감 후)
    function processDailyMarketUpdate() {
      // 오늘 분봉 데이터를 일봉 데이터에 추가
      stocks.forEach(stock => {
        if (stock.intradayHistory.length > 0) {
          // 오늘의 시가, 고가, 저가, 종가 계산
          const open = stock.intradayHistory[0].open;
          const close = stock.currentPrice;
          const high = stock.dayHigh;
          const low = stock.dayLow;
          const volume = stock.volume;
          
          // 일봉 데이터에 추가
          stock.yearlyHistory.push({
            time: new Date(simulation.currentDate),
            open: open,
            high: high,
            low: low,
            close: close,
            volume: volume
          });
          
          // 최대 기록 개수 제한
          if (stock.yearlyHistory.length > MAX_HISTORY) {
            stock.yearlyHistory = stock.yearlyHistory.slice(-MAX_HISTORY);
          }
          
          // 52주 최고/최저 업데이트
          const history52W = stock.yearlyHistory.slice(-260); // 약 52주 (거래일 기준)
          if (history52W.length > 0) {
            stock.high52W = Math.max(...history52W.map(h => h.high));
            stock.low52W = Math.min(...history52W.map(h => h.low));
          }
          
          // 다음 날 준비: 분봉 데이터 초기화
          stock.intradayHistory = [];
          stock.volume = 0;
          stock.dayOpen = close;
          stock.dayHigh = close;
          stock.dayLow = close;
          stock.prevClose = close;
        }
      });
      
      // 시장 지수도 전일 종가로 설정
      simulation.marketIndices.kospi.prevClose = simulation.marketIndices.kospi.value;
      simulation.marketIndices.kosdaq.prevClose = simulation.marketIndices.kosdaq.value;
      simulation.marketIndices.usdkrw.prevClose = simulation.marketIndices.usdkrw.value;
      
      // 주식 테이블 업데이트
      renderStocksTable();
      
      // 보유 주식 업데이트
      renderHoldings();
    }
    
    // ======================================================
    // 14. 시뮬레이션 시간 관리 함수
    // ======================================================
    
    // 시뮬레이션 주기 실행
    function runSimulation() {
      // 게임 오버 상태 확인
      if (simulation.gameOver) return;
      
      // 시간 업데이트
      simulation.currentDate = new Date(simulation.currentDate.getTime() + 60000); // 1분 증가
      
      // 거래 시간인지 확인 (9:00 ~ 15:30)
      const hour = simulation.currentDate.getHours();
      const minute = simulation.currentDate.getMinutes();
      const isTradingHours = (hour > 9 || (hour === 9 && minute >= 0)) && (hour < 15 || (hour === 15 && minute <= 30));
      const isWeekday = simulation.currentDate.getDay() >= 1 && simulation.currentDate.getDay() <= 5;
      
      // 거래 시간에만 주식 가격 업데이트
      if (isTradingHours && isWeekday) {
        // 각 주식 가격 업데이트
        stocks.forEach(stock => {
          updateStockPrice(stock);
        });
        
        // 주식 테이블 업데이트 (시장 탭이 활성화된 경우)
        if (document.getElementById('market-tab').classList.contains('active')) {
          renderStocksTable();
        }
        
        // 보유 주식 업데이트
        renderHoldings();
      }
      
      // 0시 0분에 일일 업데이트 실행
      if (hour === 0 && minute === 0) {
        // 새로운 날짜 시작
        simulation.daysPassed++;
        
        // 일일 부동산 수입 적용
        const dailyIncome = calculateRealEstateIncome();
        if (dailyIncome > 0) {
          simulation.portfolio.cash += dailyIncome;
          showNotification('부동산 수입', `부동산에서 ${formatCurrency(dailyIncome)}의 수입이 발생했습니다.`, 'success');
          updatePortfolioDisplay();
        }
        
        // 대출 처리
        processLoans();
        
        // 장 마감 후 일일 시장 업데이트
        processDailyMarketUpdate();
      }
    }
    
    // 시장 업데이트 주기 실행
    function updateMarket() {
      // 게임 오버 상태 확인
      if (simulation.gameOver) return;
      
      // 시장 지수 업데이트
      updateMarketIndices();
      
      // 랜덤 이벤트 발생 (10% 확률)
      if (Math.random() < 0.1) {
        // 랜덤 뉴스 생성
        generateNews(1);
      }
    }
    
    // 뉴스 업데이트 주기 실행
    function updateNews() {
      // 게임 오버 상태 확인
      if (simulation.gameOver) return;
      
      // 새 뉴스 생성
      generateNews(NEWS_ITEMS_PER_UPDATE);
    }
    
    // ======================================================
    // 15. 포트폴리오 관련 함수
    // ======================================================
    
    // 보유 주식 렌더링
    function renderHoldings() {
      const holdingsList = document.getElementById('holdingsList');
      
      // 보유 주식 확인
      const holdings = Object.entries(simulation.portfolio.holdings);
      
      if (holdings.length === 0) {
        holdingsList.innerHTML = `
          <div class="empty-message">
            보유 중인 주식이 없습니다.<br>
            시장에서 주식을 구매해보세요.
          </div>
        `;
        return;
      }
      
      holdingsList.innerHTML = '';
      
      holdings.forEach(([symbol, holding]) => {
        const stock = stocks.find(s => s.symbol === symbol);
        
        if (!stock) return;
        
        const item = document.createElement('div');
        item.className = 'holding-item';
        item.dataset.symbol = symbol;
        
        // 현재 가치
        const currentValue = stock.currentPrice * holding.quantity;
        
        // 손익
        const profitLoss = currentValue - (holding.avgPrice * holding.quantity);
        const profitLossPercent = (profitLoss / (holding.avgPrice * holding.quantity) * 100).toFixed(2);
        
        item.innerHTML = `
          <div class="holding-info">
            <div class="holding-name">${stock.name}</div>
            <div class="holding-symbol">${symbol} · ${stock.sector}</div>
          </div>
          <div class="holding-stats">
            <div class="holding-shares">${formatNumber(holding.quantity)}주 · ${formatCurrency(holding.avgPrice)}</div>
            <div class="holding-value">${formatCurrency(currentValue)}</div>
            <div class="price-change ${profitLoss >= 0 ? 'positive' : 'negative'}">
              <i class="material-icons">${profitLoss >= 0 ? 'arrow_upward' : 'arrow_downward'}</i>
              ${profitLoss >= 0 ? '+' : ''}${profitLossPercent}%
            </div>
          </div>
        `;
        
        item.addEventListener('click', () => {
          selectStock(symbol);
        });
        
        holdingsList.appendChild(item);
      });
    }
    
    // 포트폴리오 업데이트
    function updatePortfolioDisplay() {
      // 주식 평가액 계산
      const stocksValue = calculateStocksValue();
      
      // 부동산 평가액 계산
      const realEstateValue = calculateRealEstateValue();
      
      // 총 자산 가치
      const totalValue = simulation.portfolio.cash + stocksValue + realEstateValue;
      
      // 수동 수입 계산 (일 기준)
      const passiveIncome = calculateRealEstateIncome();
      
      // UI 업데이트
      document.getElementById('totalBalance').textContent = formatCurrency(totalValue);
      document.getElementById('cashBalance').textContent = formatCurrency(simulation.portfolio.cash);
      document.getElementById('stocksValue').textContent = formatCurrency(stocksValue);
      document.getElementById('realEstateValue').textContent = formatCurrency(realEstateValue);
      document.getElementById('passiveIncome').textContent = formatCurrency(passiveIncome) + ' / 일';
      
      // 보유 주식 목록 업데이트
      renderHoldings();
      
      // 보유 부동산 목록 업데이트
      renderOwnedProperties();
      
      // 대출 정보 업데이트
      updateLoanDisplay();
    }
    
    // 주식 평가액 계산
    function calculateStocksValue() {
      let value = 0;
      
      Object.entries(simulation.portfolio.holdings).forEach(([symbol, holding]) => {
        const stock = stocks.find(s => s.symbol === symbol);
        if (stock) {
          value += stock.currentPrice * holding.quantity;
        }
      });
      
      return value;
    }
    
    // 부동산 평가액 계산
    function calculateRealEstateValue() {
      let value = 0;
      
      Object.values(simulation.portfolio.properties).forEach(property => {
        const realEstate = realEstateProperties.find(p => p.id === property.id);
        if (realEstate) {
          value += realEstate.price;
        }
      });
      
      return value;
    }
    
    // 총 자산 가치 계산
    function calculateTotalAssets() {
      return simulation.portfolio.cash + calculateStocksValue() + calculateRealEstateValue();
    }
    
    // 포트폴리오 정렬
    function sortPortfolio() {
      const holdingsList = document.getElementById('holdingsList');
      const items = Array.from(holdingsList.querySelectorAll('.holding-item'));
      
      if (items.length <= 1) return;
      
      // 정렬 기준 순환 (기본값 -> 이름순 -> 가치순 -> 수익률순)
      let sortBy;
      
      if (!holdingsList.dataset.sortBy || holdingsList.dataset.sortBy === 'profit') {
        sortBy = 'name';
        showNotification('정렬', '이름순으로 정렬합니다.', 'info');
      } else if (holdingsList.dataset.sortBy === 'name') {
        sortBy = 'value';
        showNotification('정렬', '가치순으로 정렬합니다.', 'info');
      } else if (holdingsList.dataset.sortBy === 'value') {
        sortBy = 'profit';
        showNotification('정렬', '수익률순으로 정렬합니다.', 'info');
      }
      
      holdingsList.dataset.sortBy = sortBy;
      
      // 항목 정렬
      items.sort((a, b) => {
        const aSymbol = a.dataset.symbol;
        const bSymbol = b.dataset.symbol;
        const aStock = stocks.find(s => s.symbol === aSymbol);
        const bStock = stocks.find(s => s.symbol === bSymbol);
        const aHolding = simulation.portfolio.holdings[aSymbol];
        const bHolding = simulation.portfolio.holdings[bSymbol];
        
        if (!aStock || !bStock || !aHolding || !bHolding) return 0;
        
        if (sortBy === 'name') {
          return aStock.name.localeCompare(bStock.name);
        } else if (sortBy === 'value') {
          const aValue = aStock.currentPrice * aHolding.quantity;
          const bValue = bStock.currentPrice * bHolding.quantity;
          return bValue - aValue; // 내림차순
        } else if (sortBy === 'profit') {
          const aProfitLoss = (aStock.currentPrice / aHolding.avgPrice - 1) * 100;
          const bProfitLoss = (bStock.currentPrice / bHolding.avgPrice - 1) * 100;
          return bProfitLoss - aProfitLoss; // 내림차순
        }
      });
      
      // DOM 재구성
      items.forEach(item => holdingsList.appendChild(item));
    }
    
    // ======================================================
    // 16. 주식 테이블 관련 함수
    // ======================================================
    
    // 주식 테이블 렌더링
    function renderStocksTable() {
      const tbody = document.querySelector('#stocksTable tbody');
      tbody.innerHTML = '';
      
      // 필터 적용
      const filteredStocks = filterStocks();
      
      // 정렬 적용
      const sortedStocks = sortStocks(filteredStocks);
      
      sortedStocks.forEach(stock => {
        const row = document.createElement('tr');
        row.dataset.symbol = stock.symbol;
        
        // 변동률 계산
        const change = (stock.currentPrice - stock.prevClose) / stock.prevClose * 100;
        
        row.innerHTML = `
          <td>
            <div class="stock-name">${stock.name}</div>
            <div class="stock-symbol">${stock.symbol} · ${stock.sector}</div>
          </td>
          <td class="stock-price">${formatCurrency(stock.currentPrice)}</td>
          <td class="stock-change ${change >= 0 ? 'positive' : 'negative'}">
            ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // 섹터 필터 옵션 채우기
    function populateSectorFilter() {
      const sectorFilter = document.getElementById('sectorFilter');
      
      // 모든 섹터 수집
      const sectors = new Set();
      stocks.forEach(stock => sectors.add(stock.sector));
      
      // 옵션 추가
      sectorFilter.innerHTML = '<option value="all">전체 섹터</option>';
      
      [...sectors].sort().forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        sectorFilter.appendChild(option);
      });
    }
    
    // 주식 필터링
    function filterStocks() {
      const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
      const selectedSector = document.getElementById('sectorFilter').value;
      
      return stocks.filter(stock => {
        // 검색어 필터
        const matchesSearch = searchTerm === '' || 
          stock.name.toLowerCase().includes(searchTerm) || 
          stock.symbol.toLowerCase().includes(searchTerm);
        
        // 섹터 필터
        const matchesSector = selectedSector === 'all' || stock.sector === selectedSector;
        
        return matchesSearch && matchesSector;
      });
    }
    
    // 주식 테이블 필터링
    function filterStocksTable() {
      renderStocksTable();
    }
    
    // 주식 정렬
    function sortStocks(stocks) {
      // 정렬 기준 가져오기
      const sortHeader = document.querySelector('#stocksTable th.sort-by') || document.querySelector('#stocksTable th[data-sort="name"]');
      const sortBy = sortHeader ? sortHeader.dataset.sort : 'name';
      const sortOrder = sortHeader && sortHeader.classList.contains('sort-desc') ? 'asc' : 'desc';
      
      // 복사본 생성하여 정렬
      return [...stocks].sort((a, b) => {
        let comparison;
        
        if (sortBy === 'name') {
          comparison = a.name.localeCompare(b.name);
        } else if (sortBy === 'price') {
          comparison = a.currentPrice - b.currentPrice;
        } else if (sortBy === 'change') {
          const aChange = (a.currentPrice - a.prevClose) / a.prevClose;
          const bChange = (b.currentPrice - b.prevClose) / b.prevClose;
          comparison = aChange - bChange;
        } else {
          comparison = 0;
        }
        
        return sortOrder === 'desc' ? -comparison : comparison;
      });
    }
    
    // 주식 테이블 정렬
    function sortStocksTable(sortBy) {
      // 이전 정렬 상태 확인
      const th = document.querySelector(`#stocksTable th[data-sort="${sortBy}"]`);
      const wasSortedDesc = th.classList.contains('sort-desc');
      
      // 모든 헤더에서 정렬 클래스 제거
      document.querySelectorAll('#stocksTable th').forEach(header => {
        header.classList.remove('sort-by', 'sort-asc', 'sort-desc');
      });
      
      // 현재 헤더에 정렬 클래스 추가
      th.classList.add('sort-by');
      th.classList.add(wasSortedDesc ? 'sort-asc' : 'sort-desc');
      
      // 테이블 다시 렌더링
      renderStocksTable();
    }
    
    // ======================================================
    // 17. 저장/불러오기 관련 함수
    // ======================================================
    
    // 저장/불러오기 모달 표시
    function showSaveLoadModal(mode) {
      const modal = document.getElementById('saveLoadModal');
      const saveContent = document.getElementById('saveContent');
      const loadContent = document.getElementById('loadContent');
      const saveButton = document.getElementById('saveButton');
      const loadConfirmButton = document.getElementById('loadConfirmButton');
      const saveLoadTitle = document.getElementById('saveLoadTitle');
      
      if (mode === 'save') {
        // 저장 모드
        saveLoadTitle.textContent = '시뮬레이션 저장';
        saveContent.style.display = 'block';
        loadContent.style.display = 'none';
        saveButton.style.display = 'block';
        loadConfirmButton.style.display = 'none';
        
        // 현재 상태 정보 표시
        document.getElementById('saveTotalAssets').textContent = formatCurrency(calculateTotalAssets());
        document.getElementById('saveStockCount').textContent = `${Object.keys(simulation.portfolio.holdings).length}종목`;
        document.getElementById('savePropertyCount').textContent = `${Object.keys(simulation.portfolio.properties).length}건`;
        document.getElementById('saveLoanCount').textContent = `${Object.keys(simulation.portfolio.loans).length}건`;
      } else {
        // 불러오기 모드
        saveLoadTitle.textContent = '시뮬레이션 불러오기';
        saveContent.style.display = 'none';
        loadContent.style.display = 'block';
        saveButton.style.display = 'none';
        loadConfirmButton.style.display = 'block';
        
        // 파일 선택 초기화
        document.getElementById('loadFileInput').value = '';
        document.getElementById('loadFileInfo').style.display = 'none';
        document.getElementById('loadWarning').style.display = 'none';
        loadConfirmButton.disabled = true;
      }
      
      modal.classList.add('active');
    }
    
    // 시뮬레이션 저장
    function saveSimulation() {
      try {
        // 저장할 데이터 준비
        const saveData = {
          timestamp: new Date().toISOString(),
          version: '1.0',
          simulation: JSON.parse(JSON.stringify(simulation)), // 딥 카피
          stocks: stocks.map(stock => ({
            symbol: stock.symbol,
            name: stock.name,
            currentPrice: stock.currentPrice,
            prevClose: stock.prevClose,
            dayOpen: stock.dayOpen,
            dayHigh: stock.dayHigh,
            dayLow: stock.dayLow,
            high52W: stock.high52W,
            low52W: stock.low52W,
            sector: stock.sector,
            volume: stock.volume
          })),
          realEstateProperties: realEstateProperties.map(property => ({
            id: property.id,
            owned: property.owned
          }))
        };
        
        // JSON 변환
        const jsonData = JSON.stringify(saveData);
        
        // 파일명 가져오기
        const filename = document.getElementById('saveFileName').value || 'financial_simulation.json';
        
        // 다운로드 링크 생성
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        
        // 다운로드 실행
        link.click();
        
        // 리소스 정리
        URL.revokeObjectURL(url);
        
        // 모달 닫기
        closeAllModals();
        
        showNotification('저장 완료', '시뮬레이션이 성공적으로 저장되었습니다.', 'success');
      } catch (error) {
        console.error('저장 오류:', error);
        showNotification('저장 실패', '시뮬레이션을 저장하는 중 오류가 발생했습니다.', 'error');
      }
    }
    
    // 파일 업로드 처리
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(event) {
        try {
          // JSON 파싱
          const saveData = JSON.parse(event.target.result);
          
          // 버전 및 데이터 구조 확인
          if (!saveData.version || !saveData.simulation) {
            throw new Error('유효하지 않은 저장 파일입니다.');
          }
          
          // 임시 저장
          tempLoadData = saveData;
          
          // 파일 정보 표시
          document.getElementById('loadFileInfo').style.display = 'block';
          document.getElementById('loadWarning').style.display = 'block';
          
          document.getElementById('loadSaveDate').textContent = new Date(saveData.timestamp).toLocaleString();
          document.getElementById('loadTotalAssets').textContent = formatCurrency(
            saveData.simulation.portfolio.cash + 
            calculateLoadStocksValue(saveData) + 
            calculateLoadPropertiesValue(saveData)
          );
          document.getElementById('loadStockCount').textContent = `${Object.keys(saveData.simulation.portfolio.holdings).length}종목`;
          document.getElementById('loadPropertyCount').textContent = `${Object.keys(saveData.simulation.portfolio.properties).length}건`;
          
          // 불러오기 버튼 활성화
          document.getElementById('loadConfirmButton').disabled = false;
        } catch (error) {
          console.error('파일 처리 오류:', error);
          showNotification('파일 오류', '유효하지 않은 저장 파일입니다.', 'error');
          
          document.getElementById('loadFileInfo').style.display = 'none';
          document.getElementById('loadWarning').style.display = 'none';
          document.getElementById('loadConfirmButton').disabled = true;
        }
      };
      
      reader.readAsText(file);
    }
    
    // 불러온 데이터의 주식 가치 계산
    function calculateLoadStocksValue(saveData) {
      let value = 0;
      
      Object.entries(saveData.simulation.portfolio.holdings).forEach(([symbol, holding]) => {
        const stock = saveData.stocks.find(s => s.symbol === symbol);
        if (stock) {
          value += stock.currentPrice * holding.quantity;
        }
      });
      
      return value;
    }
    
    // 불러온 데이터의 부동산 가치 계산
    function calculateLoadPropertiesValue(saveData) {
      let value = 0;
      
      Object.values(saveData.simulation.portfolio.properties).forEach(property => {
        const realEstate = realEstateProperties.find(p => p.id === property.id);
        if (realEstate) {
          value += realEstate.price;
        }
      });
      
      return value;
    }
    
    // 시뮬레이션 불러오기
    function loadSimulation() {
      if (!tempLoadData) {
        closeAllModals();
        return;
      }
      
      try {
        // 저장된 데이터 적용
        simulation.portfolio = tempLoadData.simulation.portfolio;
        simulation.currentDate = new Date(tempLoadData.simulation.currentDate);
        simulation.daysPassed = tempLoadData.simulation.daysPassed;
        simulation.marketIndices = tempLoadData.simulation.marketIndices;
        simulation.news = tempLoadData.simulation.news;
        simulation.settings = tempLoadData.simulation.settings;
        simulation.gameOver = tempLoadData.simulation.gameOver;
        
        // 주식 데이터 업데이트
        tempLoadData.stocks.forEach(savedStock => {
          const stock = stocks.find(s => s.symbol === savedStock.symbol);
          if (stock) {
            stock.currentPrice = savedStock.currentPrice;
            stock.prevClose = savedStock.prevClose;
            stock.dayOpen = savedStock.dayOpen || savedStock.currentPrice;
            stock.dayHigh = savedStock.dayHigh || savedStock.currentPrice;
            stock.dayLow = savedStock.dayLow || savedStock.currentPrice;
            stock.high52W = savedStock.high52W || savedStock.currentPrice * 1.1;
            stock.low52W = savedStock.low52W || savedStock.currentPrice * 0.9;
            stock.volume = savedStock.volume || 0;
          }
        });
        
        // 부동산 소유 상태 업데이트
        tempLoadData.realEstateProperties.forEach(savedProperty => {
          const property = realEstateProperties.find(p => p.id === savedProperty.id);
          if (property) {
            property.owned = savedProperty.owned;
          }
        });
        
        // 다크 모드 적용
        if (simulation.settings.darkMode) {
          document.body.classList.add('dark-mode');
          document.getElementById('themeToggle').querySelector('i').textContent = 'brightness_5';
        } else {
          document.body.classList.remove('dark-mode');
          document.getElementById('themeToggle').querySelector('i').textContent = 'brightness_4';
        }
        
        // UI 업데이트
        updatePortfolioDisplay();
        updateMarketIndicesDisplay();
        renderStocksTable();
        renderRealEstateList();
        renderActiveLoans();
        updateNewsTicker();
        renderNewsItems();
        
        // 모달 닫기
        closeAllModals();
        
        showNotification('불러오기 완료', '시뮬레이션이 성공적으로 불러와졌습니다.', 'success');
        
        // 초기 주식 선택
        if (stocks.length > 0) {
          selectStock(stocks[0].symbol);
        }
      } catch (error) {
        console.error('불러오기 오류:', error);
        showNotification('불러오기 실패', '시뮬레이션을 불러오는 중 오류가 발생했습니다.', 'error');
      }
    }
    
    // ======================================================
    // 18. 유틸리티 함수
    // ======================================================
    
    // 통화 형식 포맷팅
    function formatCurrency(amount, short = false) {
      if (typeof amount !== 'number') return '₩0';
      
      if (short) {
        if (Math.abs(amount) >= 1000000000000) {
          return `₩${(amount / 1000000000000).toFixed(1)}조`;
        } else if (Math.abs(amount) >= 100000000) {
          return `₩${(amount / 100000000).toFixed(1)}억`;
        } else if (Math.abs(amount) >= 10000) {
          return `₩${(amount / 10000).toFixed(1)}만`;
        } else {
          return `₩${amount.toFixed(0)}`;
        }
      } else {
        return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(amount);
      }
    }
    
    // 숫자 형식 포맷팅
    function formatNumber(number) {
      return new Intl.NumberFormat('ko-KR').format(number);
    }
    
    // 날짜 형식 포맷팅
    function formatDate(date) {
      if (!date) return '';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }
    
    // 시간 형식 포맷팅
    function formatTime(date) {
      if (!date) return '';
      
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${hours}:${minutes}`;
    }
    
    // 알림 표시
    function showNotification(title, message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // 아이콘 선택
      let icon;
      switch (type) {
        case 'success':
          icon = 'check_circle';
          break;
        case 'error':
          icon = 'error';
          break;
        case 'warning':
          icon = 'warning';
          break;
        default:
          icon = 'info';
      }
      
      notification.innerHTML = `
        <i class="material-icons">${icon}</i>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
      `;
      
      container.appendChild(notification);
      
      // 3초 후 사라짐
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // 모든 모달 닫기
    function closeAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.remove('active');
      });
    }
    
    // 날짜가 같은지 확인
    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
        date1.getMonth() === date2.getMonth() &&
        date1.getDate() === date2.getDate();
    }
    
    // 랜덤 색상 생성 (ID 기반 일관성 있는 색상)
    function getRandomColor(id) {
      // ID를 숫자로 변환
      let hash = 0;
      for (let i = 0; i < id.length; i++) {
        hash = id.charCodeAt(i) + ((hash << 5) - hash);
      }
      
      // HSL 색상 생성 (파스텔 톤)
      const h = Math.abs(hash) % 360;
      const s = 60 + Math.abs(hash % 20); // 60-80%
      const l = 75 + Math.abs(hash % 10); // 75-85%
      
      return `hsl(${h}, ${s}%, ${l}%)`;
    }
    
    // 테마 토글
    function toggleTheme() {
      const body = document.body;
      const isDarkMode = body.classList.toggle('dark-mode');
      
      // 테마 설정 저장
      simulation.settings.darkMode = isDarkMode;
      
      // 아이콘 변경
      document.getElementById('themeToggle').querySelector('i').textContent = isDarkMode ? 'brightness_5' : 'brightness_4';
    }
    
    // ======================================================
    // 19. 시뮬레이션 초기화 및 시작
    // ======================================================
    
    // 시뮬레이션 주기적 실행
    setInterval(runSimulation, SIMULATION_INTERVAL);
    setInterval(updateMarket, MARKET_UPDATE_INTERVAL);
    setInterval(updateNews, NEWS_UPDATE_INTERVAL);
    
    // 앱 초기화
    function initializeApp() {
      // 테마 설정 적용
      if (simulation.settings.darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').querySelector('i').textContent = 'brightness_5';
      }
      
      // 초기 뉴스 생성
      generateNews(10);
      
      // 초기 UI 렌더링
      updatePortfolioDisplay();
      updateMarketIndicesDisplay();
      renderStocksTable();
      renderRealEstateGrid();
      renderActiveLoans();
      updateNewsTicker();
      
      showNotification('시뮬레이션 시작', '종합 금융 시뮬레이션을 시작합니다.', 'info');
    }
    
    // 페이지 로드 완료 후 초기화
    window.addEventListener('load', initializeApp);
  </script>
</body>
</html>
